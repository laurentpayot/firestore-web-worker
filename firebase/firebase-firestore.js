/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app"],e):e((t=t||self).firebase)}(this,function(Kp){"use strict";try{(function(){var o,t;Kp=Kp&&Kp.hasOwnProperty("default")?Kp.default:Kp,(t=o=o||{})[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT";function e(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var i=(new Date).toISOString();switch(e){case o.DEBUG:case o.VERBOSE:console.log.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.INFO:console.info.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.WARN:console.warn.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.ERROR:console.error.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+e+")")}}}var n=o.INFO,r=(Object.defineProperty(i.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in o))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),i.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.DEBUG].concat(t))},i.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.VERBOSE].concat(t))},i.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.INFO].concat(t))},i.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.WARN].concat(t))},i.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.ERROR].concat(t))},i);function i(t){this.name=t,this._logLevel=n,this._logHandler=e}var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function s(t,e){function n(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var l=function(){return(l=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function d(o,a,s,u){return new(s=s||Promise)(function(t,e){function n(t){try{i(u.next(t))}catch(t){e(t)}}function r(t){try{i(u.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(n,r)}i((u=u.apply(o,a||[])).next())})}function m(n,r){var i,o,a,t,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(a=2&e[0]?o.return:e[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,e[1])).done)return a;switch(o=0,a&&(e=[2&e[0],a.value]),e[0]){case 0:case 1:a=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,o=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){s.label=e[1];break}if(6===e[0]&&s.label<a[1]){s.label=a[1],a=e;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(e);break}a[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(n,s)}catch(t){e=[6,t],o=0}finally{i=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function u(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}var c,f=(s(h,c=Error),h);function h(t,e){var n=c.call(this,e)||this;return n.code=t,n.name="FirebaseError",Object.setPrototypeOf(n,h.prototype),Error.captureStackTrace&&Error.captureStackTrace(n,p.prototype.create),n}var p=(y.prototype.create=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=e[0]||{},i=this.service+"/"+t,o=this.errors[t],a=o?function(t,r){return t.replace(v,function(t,e){var n=r[e];return null!=n?n.toString():"<"+e+"?>"})}(o,r):"Error",s=this.serviceName+": "+a+" ("+i+").",u=new f(i,s),c=0,h=Object.keys(r);c<h.length;c++){var l=h[c];"_"!==l.slice(-1)&&(l in u&&console.warn('Overwriting FirebaseError base field "'+l+'" can cause unexpected behavior.'),u[l]=r[l])}return u},y);function y(t,e,n){this.service=t,this.serviceName=e,this.errors=n}var g,v=/\{\$([^}]+)}/g,b="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},w=w||{},T=b;function S(t){return"string"==typeof t}function E(t){return"number"==typeof t}function I(t,e){t=t.split("."),e=e||T;for(var n=0;n<t.length;n++)if(null==(e=e[t[n]]))return null;return e}function C(){}function D(t){var e=typeof t;if("object"==e){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return e;var n=Object.prototype.toString.call(t);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==e&&void 0===t.call)return"object";return e}function N(t){return"array"==D(t)}function A(t){var e=D(t);return"array"==e||"object"==e&&"number"==typeof t.length}function k(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var R="closure_uid_"+(1e9*Math.random()>>>0),M=0;function O(t,e,n){return t.call.apply(t.bind,arguments)}function _(e,n,t){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,r),e.apply(n,t)}}return function(){return e.apply(n,arguments)}}function L(t,e,n){return(L=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?O:_).apply(null,arguments)}function P(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}var x=Date.now||function(){return+new Date};function F(t,o){function e(){}e.prototype=o.prototype,t.N=o.prototype,t.prototype=new e,(t.prototype.constructor=t).yb=function(t,e,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return o.prototype[e].apply(t,r)}}function q(){this.j=this.j,this.i=this.i}q.prototype.j=!1,q.prototype.la=function(){if(!this.j&&(this.j=!0,this.G(),0))this[R]||(this[R]=++M)},q.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var V=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if(S(t))return S(e)&&1==e.length?t.indexOf(e,0):-1;for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},B=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var r=t.length,i=S(t)?t.split(""):t,o=0;o<r;o++)o in i&&e.call(n,i[o],o,t)};function U(t){return Array.prototype.concat.apply([],arguments)}function K(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function Q(t){return/^[\s\xa0]*$/.test(t)}var j,W=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function G(t,e){return-1!=t.indexOf(e)}function z(t,e){return t<e?-1:e<t?1:0}t:{var H=T.navigator;if(H){var Y=H.userAgent;if(Y){j=Y;break t}}j=""}function X(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function J(t){var e,n={};for(e in t)n[e]=t[e];return n}var Z="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function $(t,e){for(var n,r,i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(var o=0;o<Z.length;o++)n=Z[o],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function tt(t){return tt[" "](t),t}tt[" "]=C;var et,nt,rt=G(j,"Opera"),it=G(j,"Trident")||G(j,"MSIE"),ot=G(j,"Edge"),at=ot||it,st=G(j,"Gecko")&&!(G(j.toLowerCase(),"webkit")&&!G(j,"Edge"))&&!(G(j,"Trident")||G(j,"MSIE"))&&!G(j,"Edge"),ut=G(j.toLowerCase(),"webkit")&&!G(j,"Edge");function ct(){var t=T.document;return t?t.documentMode:void 0}t:{var ht="",lt=(nt=j,st?/rv:([^\);]+)(\)|;)/.exec(nt):ot?/Edge\/([\d\.]+)/.exec(nt):it?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(nt):ut?/WebKit\/(\S+)/.exec(nt):rt?/(?:Version)[ \/]?(\S+)/.exec(nt):void 0);if(lt&&(ht=lt?lt[1]:""),it){var ft=ct();if(null!=ft&&ft>parseFloat(ht)){et=String(ft);break t}}et=ht}var dt,pt={};function mt(s){return function(t,e){var n=pt;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e(t)}(s,function(){for(var t=0,e=W(String(et)).split("."),n=W(String(s)).split("."),r=Math.max(e.length,n.length),i=0;0==t&&i<r;i++){var o=e[i]||"",a=n[i]||"";do{if(o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],0==o[0].length&&0==a[0].length)break;t=z(0==o[1].length?0:parseInt(o[1],10),0==a[1].length?0:parseInt(a[1],10))||z(0==o[2].length,0==a[2].length)||z(o[2],a[2]),o=o[3],a=a[3]}while(0==t)}return 0<=t})}var yt=T.document;dt=yt&&it?ct()||("CSS1Compat"==yt.compatMode?parseInt(et,10):5):void 0;var gt=!it||9<=Number(dt),vt=it&&!mt("9"),bt=function(){if(!T.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{T.addEventListener("test",C,e),T.removeEventListener("test",C,e)}catch(t){}return t}();function wt(t,e){this.type=t,this.a=this.target=e,this.Ja=!0}function Tt(t,e){if(wt.call(this,t?t.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.a=e,e=t.relatedTarget){if(st){t:{try{tt(e.nodeName);var i=!0;break t}catch(t){}i=!1}i||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=S(t.pointerType)?t.pointerType:St[t.pointerType]||"",(this.c=t).defaultPrevented&&this.b()}}wt.prototype.b=function(){this.Ja=!1},F(Tt,wt);var St={2:"touch",3:"pen",4:"mouse"};Tt.prototype.b=function(){Tt.N.b.call(this);var t=this.c;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,vt)try{(t.ctrlKey||112<=t.keyCode&&t.keyCode<=123)&&(t.keyCode=-1)}catch(t){}};var Et="closure_listenable_"+(1e6*Math.random()|0),It=0;function Ct(t,e,n,r,i){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.da=i,this.key=++It,this.X=this.Z=!1}function Dt(t){t.X=!0,t.listener=null,t.proxy=null,t.src=null,t.da=null}function Nt(t){this.src=t,this.a={},this.b=0}function At(t,e){var n=e.type;if(n in t.a){var r,i=t.a[n],o=V(i,e);(r=0<=o)&&Array.prototype.splice.call(i,o,1),r&&(Dt(e),0==t.a[n].length&&(delete t.a[n],t.b--))}}function kt(t,e,n,r){for(var i=0;i<t.length;++i){var o=t[i];if(!o.X&&o.listener==e&&o.capture==!!n&&o.da==r)return i}return-1}Nt.prototype.add=function(t,e,n,r,i){var o=t.toString();(t=this.a[o])||(t=this.a[o]=[],this.b++);var a=kt(t,e,r,i);return-1<a?(e=t[a],n||(e.Z=!1)):((e=new Ct(e,this.src,o,!!r,i)).Z=n,t.push(e)),e};var Rt="closure_lm_"+(1e6*Math.random()|0),Mt={};function Ot(t,e,n,r,i){if(r&&r.once)return function t(e,n,r,i,o){if(N(n)){for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);return null}r=Bt(r);return e&&e[Et]?e.Ba(n,r,k(i)?!!i.capture:!!i,o):_t(e,n,r,!0,i,o)}(t,e,n,r,i);if(N(e)){for(var o=0;o<e.length;o++)Ot(t,e[o],n,r,i);return null}return n=Bt(n),t&&t[Et]?t.Aa(e,n,k(r)?!!r.capture:!!r,i):_t(t,e,n,!1,r,i)}function _t(t,e,n,r,i,o){if(!e)throw Error("Invalid event type");var a=k(i)?!!i.capture:!!i;if(a&&!gt)return null;var s=qt(t);if(s||(t[Rt]=s=new Nt(t)),(n=s.add(e,n,r,a,o)).proxy)return n;if(r=function(){var e=Ft,n=gt?function(t){return e.call(n.src,n.listener,t)}:function(t){if(!(t=e.call(n.src,n.listener,t)))return t};return n}(),(n.proxy=r).src=t,r.listener=n,t.addEventListener)bt||(i=a),void 0===i&&(i=!1),t.addEventListener(e.toString(),r,i);else if(t.attachEvent)t.attachEvent(Pt(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function Lt(t){if(!E(t)&&t&&!t.X){var e=t.src;if(e&&e[Et])At(e.c,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Pt(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=qt(e))?(At(n,t),0==n.b&&(n.src=null,e[Rt]=null)):Dt(t)}}}function Pt(t){return t in Mt?Mt[t]:Mt[t]="on"+t}function xt(t,e){var n=t.listener,r=t.da||t.src;return t.Z&&Lt(t),n.call(r,e)}function Ft(t,e){return!!t.X||(gt?xt(t,new Tt(e,this)):xt(t,e=new Tt(e||I("window.event"),this)))}function qt(t){return(t=t[Rt])instanceof Nt?t:null}var Vt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Bt(e){return"function"==D(e)?e:(e[Vt]||(e[Vt]=function(t){return e.handleEvent(t)}),e[Vt])}function Ut(){q.call(this),this.c=new Nt(this),(this.J=this).B=null}function Kt(t,e,n,r){if(!(e=t.c.a[String(e)]))return!0;e=e.concat();for(var i=!0,o=0;o<e.length;++o){var a=e[o];if(a&&!a.X&&a.capture==n){var s=a.listener,u=a.da||a.src;a.Z&&At(t.c,a),i=!1!==s.call(u,r)&&i}}return i&&0!=r.Ja}F(Ut,q),Ut.prototype[Et]=!0,(g=Ut.prototype).addEventListener=function(t,e,n,r){Ot(this,t,e,n,r)},g.removeEventListener=function(t,e,n,r){!function t(e,n,r,i,o){if(N(n))for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);else i=k(i)?!!i.capture:!!i,r=Bt(r),e&&e[Et]?(e=e.c,(n=String(n).toString())in e.a&&-1<(r=kt(a=e.a[n],r,i,o))&&(Dt(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete e.a[n],e.b--))):(e=e&&qt(e))&&(n=e.a[n.toString()],e=-1,n&&(e=kt(n,r,i,o)),(r=-1<e?n[e]:null)&&Lt(r))}(this,t,e,n,r)},g.dispatchEvent=function(t){var e,n=this.B;if(n)for(e=[];n;n=n.B)e.push(n);n=this.J;var r=t.type||t;if(S(t))t=new wt(t,n);else if(t instanceof wt)t.target=t.target||n;else{var i=t;$(t=new wt(r,n),i)}if(i=!0,e)for(var o=e.length-1;0<=o;o--){var a=t.a=e[o];i=Kt(a,r,!0,t)&&i}if(i=Kt(a=t.a=n,r,!0,t)&&i,i=Kt(a,r,!1,t)&&i,e)for(o=0;o<e.length;o++)i=Kt(a=t.a=e[o],r,!1,t)&&i;return i},g.G=function(){if(Ut.N.G.call(this),this.c){var t,e=this.c;for(t in e.a){for(var n=e.a[t],r=0;r<n.length;r++)Dt(n[r]);delete e.a[t],e.b--}}this.B=null},g.Aa=function(t,e,n,r){return this.c.add(String(t),e,!1,n,r)},g.Ba=function(t,e,n,r){return this.c.add(String(t),e,!0,n,r)};var Qt=T.JSON.stringify;function jt(t,e){this.c=t,this.f=e,this.b=0,this.a=null}function Wt(){this.b=this.a=null}jt.prototype.get=function(){if(0<this.b){this.b--;var t=this.a;this.a=t.next,t.next=null}else t=this.c();return t};var Gt,zt=new jt(function(){return new Ht},function(t){t.reset()});function Ht(){this.next=this.b=this.a=null}function Yt(t){T.setTimeout(function(){throw t},0)}function Xt(t,e){Gt||function(){var t=T.Promise.resolve(void 0);Gt=function(){t.then($t)}}(),Jt||(Gt(),Jt=!0),Zt.add(t,e)}Wt.prototype.add=function(t,e){var n=zt.get();n.set(t,e),this.b?this.b.next=n:this.a=n,this.b=n},Ht.prototype.set=function(t,e){this.a=t,this.b=e,this.next=null};var Jt=!(Ht.prototype.reset=function(){this.next=this.b=this.a=null}),Zt=new Wt;function $t(){for(var t;r=n=void 0,r=null,(n=Zt).a&&(r=n.a,n.a=n.a.next,n.a||(n.b=null),r.next=null),t=r;){try{t.a.call(t.b)}catch(t){Yt(t)}var e=zt;e.f(t),e.b<100&&(e.b++,t.next=e.a,e.a=t)}var n,r;Jt=!1}function te(t,e){Ut.call(this),this.b=t||1,this.a=e||T,this.f=L(this.gb,this),this.g=x()}function ee(t){t.ba=!1,t.L&&(t.a.clearTimeout(t.L),t.L=null)}function ne(t,e,n){if("function"==D(t))n&&(t=L(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=L(t.handleEvent,t)}return 2147483647<Number(e)?-1:T.setTimeout(t,e||0)}function re(t,e,n){q.call(this),this.f=null!=n?L(t,n):t,this.c=e,this.b=L(this.ab,this),this.a=[]}function ie(t){t.U=ne(t.b,t.c),t.f.apply(null,t.a)}function oe(t){q.call(this),this.b=t,this.a={}}F(te,Ut),(g=te.prototype).ba=!1,g.L=null,g.gb=function(){if(this.ba){var t=x()-this.g;0<t&&t<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-t):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(ee(this),this.start()))}},g.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=x())},g.G=function(){te.N.G.call(this),ee(this),delete this.a},F(re,q),(g=re.prototype).ea=!1,g.U=null,g.Ua=function(t){this.a=arguments,this.U?this.ea=!0:ie(this)},g.G=function(){re.N.G.call(this),this.U&&(T.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},g.ab=function(){this.U=null,this.ea&&(this.ea=!1,ie(this))},F(oe,q);var ae=[];function se(t,e,n,r){N(n)||(n&&(ae[0]=n.toString()),n=ae);for(var i=0;i<n.length;i++){var o=Ot(e,n[i],r||t.handleEvent,!1,t.b||t);if(!o)break;t.a[o.key]=o}}function ue(t){X(t.a,function(t,e){this.a.hasOwnProperty(e)&&Lt(t)},t),t.a={}}function ce(){}oe.prototype.G=function(){oe.N.G.call(this),ue(this)},oe.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var he=new Ut;function le(t){wt.call(this,"serverreachability",t)}function fe(t){he.dispatchEvent(new le(he,t))}function de(t){wt.call(this,"statevent",t)}function pe(t){he.dispatchEvent(new de(he,t))}function me(t){wt.call(this,"timingevent",t)}function ye(t,e){if("function"!=D(t))throw Error("Fn must not be null and must be a function");return T.setTimeout(function(){t()},e)}F(le,wt),F(de,wt),F(me,wt);var ge={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},ve={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};function be(){}function we(t){var e;return(e=t.a)||(e=t.a={}),e}function Te(){}be.prototype.a=null;var Se,Ee={OPEN:"a",ib:"b",Na:"c",rb:"d"};function Ie(){wt.call(this,"d")}function Ce(){wt.call(this,"c")}function De(){}function Ne(t,e,n){this.g=t,this.W=e,this.V=n||1,this.I=new oe(this),this.O=Ae,t=at?125:void 0,this.P=new te(t),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}F(Ie,wt),F(Ce,wt),F(De,be),Se=new De;var Ae=45e3,ke={},Re={};function Me(t,e,n){t.F=1,t.f=nn(Ye(e)),t.l=n,t.H=!0,_e(t,null)}function Oe(t,e,n,r){t.F=1,t.f=nn(Ye(e)),t.l=null,t.H=n,_e(t,r)}function _e(t,e){t.v=x(),xe(t),t.D=Ye(t.f),en(t.D,"t",t.V),t.A=0,t.a=t.g.$(t.g.Y()?e:null),0<t.J&&(t.B=new re(L(t.Ka,t,t.a),t.J)),se(t.I,t.a,"readystatechange",t.eb),e=t.h?J(t.h):{},t.l?(t.w||(t.w="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.a.ca(t.D,t.w,t.l,e)):(t.w="GET",t.a.ca(t.D,t.w,null,e)),fe(1)}function Le(t,e,n){for(var r=!0;!t.m&&t.A<n.length;){var i=Pe(t,n);if(i==Re){4==e&&(t.c=4,pe(14),r=!1);break}if(i==ke){t.c=4,pe(15),r=!1;break}Ue(t,i)}4==e&&0==n.length&&(t.c=1,pe(16),r=!1),t.b=t.b&&r,r||(Be(t),Ve(t))}function Pe(t,e){var n=t.A,r=e.indexOf("\n",n);return-1==r?Re:(n=Number(e.substring(n,r)),isNaN(n)?ke:(r+=1)+n>e.length?Re:(e=e.substr(r,n),t.A=r+n,e))}function xe(t){t.R=x()+t.O,Fe(t,t.O)}function Fe(t,e){if(null!=t.i)throw Error("WatchDog timer not null");t.i=ye(L(t.bb,t),e)}function qe(t){t.i&&(T.clearTimeout(t.i),t.i=null)}function Ve(t){t.g.Da()||t.m||t.g.na(t)}function Be(t){qe(t);var e=t.B;e&&"function"==typeof e.la&&e.la(),t.B=null,ee(t.P),ue(t.I),t.a&&(e=t.a,t.a=null,e.abort(),e.la())}function Ue(t,e){try{t.g.Ga(t,e),fe(4)}catch(t){}}function Ke(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(A(t)||S(t))B(t,e,void 0);else{if(t.K&&"function"==typeof t.K)var n=t.K();else if(t.C&&"function"==typeof t.C)n=void 0;else if(A(t)||S(t)){n=[];for(var r=t.length,i=0;i<r;i++)n.push(i)}else for(i in n=[],r=0,t)n[r++]=i;i=(r=function(t){if(t.C&&"function"==typeof t.C)return t.C();if(S(t))return t.split("");if(A(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length;for(var o=0;o<i;o++)e.call(void 0,r[o],n&&n[o],t)}}function Qe(t,e){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof Qe)for(n=t.K(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function je(t,e){Ge(t.b,e)&&(delete t.b[e],t.c--,t.a.length>2*t.c&&We(t))}function We(t){if(t.c!=t.a.length){for(var e=0,n=0;e<t.a.length;){var r=t.a[e];Ge(t.b,r)&&(t.a[n++]=r),e++}t.a.length=n}if(t.c!=t.a.length){var i={};for(n=e=0;e<t.a.length;)Ge(i,r=t.a[e])||(i[t.a[n++]=r]=1),e++;t.a.length=n}}function Ge(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(g=Ne.prototype).setTimeout=function(t){this.O=t},g.eb=function(t){t=t.target;var e=this.B;e&&3==Yn(t)?e.Ua():this.Ka(t)},g.Ka=function(t){try{if(t==this.a)t:{var e=Yn(this.a),n=this.a.ya(),r=this.a.T();if(!(e<3||3==e&&!at&&!this.a.aa())){this.m||4!=e||7==n||fe(8==n||r<=0?3:2),qe(this);var i=this.a.T();this.o=i;var o=this.a.aa();if(this.b=200==i){if(this.S&&!this.s){e:{if(this.a){var a=Xn(this.a,"X-HTTP-Initial-Response");if(a&&!Q(a)){var s=a;break e}}s=null}if(!s){this.b=!1,this.c=3,pe(12),Be(this),Ve(this);break t}this.s=!0,Ue(this,s)}this.H?(Le(this,e,o),at&&this.b&&3==e&&(se(this.I,this.P,"tick",this.cb),this.P.start())):Ue(this,o),4==e&&Be(this),this.b&&!this.m&&(4==e?this.g.na(this):(this.b=!1,xe(this)))}else 400==i&&0<o.indexOf("Unknown SID")?(this.c=3,pe(12)):(this.c=0,pe(13)),Be(this),Ve(this)}}}catch(t){}},g.cb=function(){if(this.a){var t=Yn(this.a),e=this.a.aa();this.A<e.length&&(qe(this),Le(this,t,e),this.b&&4!=t&&xe(this))}},g.cancel=function(){this.m=!0,Be(this)},g.bb=function(){this.i=null;var t=x();0<=t-this.R?(2!=this.F&&(fe(3),pe(17)),Be(this),this.c=2,Ve(this)):Fe(this,this.R-t)},(g=Qe.prototype).C=function(){We(this);for(var t=[],e=0;e<this.a.length;e++)t.push(this.b[this.a[e]]);return t},g.K=function(){return We(this),this.a.concat()},g.get=function(t,e){return Ge(this.b,t)?this.b[t]:e},g.set=function(t,e){Ge(this.b,t)||(this.c++,this.a.push(t)),this.b[t]=e},g.forEach=function(t,e){for(var n=this.K(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);t.call(e,o,i,this)}};var ze=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function He(t,e){var n;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,t instanceof He?(this.h=void 0!==e?e:t.h,Xe(this,t.f),this.j=t.j,Je(this,t.b),Ze(this,t.i),this.a=t.a,$e(this,gn(t.c)),this.g=t.g):t&&(n=String(t).match(ze))?(this.h=!!e,Xe(this,n[1]||"",!0),this.j=rn(n[2]||""),Je(this,n[3]||"",!0),Ze(this,n[4]),this.a=rn(n[5]||"",!0),$e(this,n[6]||"",!0),this.g=rn(n[7]||"")):(this.h=!!e,this.c=new fn(null,this.h))}function Ye(t){return new He(t)}function Xe(t,e,n){t.f=n?rn(e,!0):e,t.f&&(t.f=t.f.replace(/:$/,""))}function Je(t,e,n){t.b=n?rn(e,!0):e}function Ze(t,e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);t.i=e}else t.i=null}function $e(t,e,n){e instanceof fn?(t.c=e,function(t,e){e&&!t.f&&(dn(t),t.c=null,t.a.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(pn(this,e),yn(this,n,t))},t)),t.f=e}(t.c,t.h)):(n||(e=on(e,hn)),t.c=new fn(e,t.h))}function tn(t,e,n){t.c.set(e,n)}function en(t,e,n){N(n)||(n=[String(n)]),yn(t.c,e,n)}function nn(t){return tn(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^x()).toString(36)),t}function rn(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function on(t,e,n){return S(t)?(t=encodeURI(t).replace(e,an),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function an(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}He.prototype.toString=function(){var t=[],e=this.f;e&&t.push(on(e,sn,!0),":");var n=this.b;return!n&&"file"!=e||(t.push("//"),(e=this.j)&&t.push(on(e,sn,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&t.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&t.push("/"),t.push(on(n,"/"==n.charAt(0)?cn:un,!0))),(n=this.c.toString())&&t.push("?",n),(n=this.g)&&t.push("#",on(n,ln)),t.join("")},He.prototype.resolve=function(t){var e=Ye(this),n=!!t.f;n?Xe(e,t.f):n=!!t.j,n?e.j=t.j:n=!!t.b,n?Je(e,t.b):n=null!=t.i;var r=t.a;if(n)Ze(e,t.i);else if(n=!!t.a){if("/"!=r.charAt(0))if(this.b&&!this.a)r="/"+r;else{var i=e.a.lastIndexOf("/");-1!=i&&(r=e.a.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(G(i,"./")||G(i,"/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i}return n?e.a=r:n=""!==t.c.toString(),n?$e(e,gn(t.c)):n=!!t.g,n&&(e.g=t.g),e};var sn=/[#\/\?@]/g,un=/[#\?:]/g,cn=/[#\?]/g,hn=/[#\?@]/g,ln=/#/g;function fn(t,e){this.b=this.a=null,this.c=t||null,this.f=!!e}function dn(n){n.a||(n.a=new Qe,n.b=0,n.c&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),i=null;if(0<=r){var o=t[n].substring(0,r);i=t[n].substring(r+1)}else o=t[n];e(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.c,function(t,e){n.add(decodeURIComponent(t.replace(/\+/g," ")),e)}))}function pn(t,e){dn(t),e=vn(t,e),Ge(t.a.b,e)&&(t.c=null,t.b-=t.a.get(e).length,je(t.a,e))}function mn(t,e){return dn(t),e=vn(t,e),Ge(t.a.b,e)}function yn(t,e,n){pn(t,e),0<n.length&&(t.c=null,t.a.set(vn(t,e),K(n)),t.b+=n.length)}function gn(t){var e=new fn;return e.c=t.c,t.a&&(e.a=new Qe(t.a),e.b=t.b),e}function vn(t,e){return e=String(e),t.f&&(e=e.toLowerCase()),e}function bn(t){this.a=t,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function wn(t){var e=t.a.F.a;if(null!=e)pe(4),e?(pe(10),ur(t.a,t,!1)):(pe(11),ur(t.a,t,!0));else{t.b=new Ne(t,void 0,void 0),t.b.h=t.h,e=dr(e=t.a,e.Y()?t.f:null,t.i),pe(4),en(e,"TYPE","xmlhttp");var n=t.a.j,r=t.a.I;n&&r&&tn(e,n,r),Oe(t.b,e,!1,t.f)}}function Tn(){this.a=this.b=null}function Sn(){this.a=new Qe}function En(t){var e=typeof t;return"object"==e&&t||"function"==e?"o"+(t[R]||(t[R]=++M)):e.charAt(0)+t}function In(t,e){this.b=t,this.a=e}function Cn(t){this.g=t||Dn,t=T.PerformanceNavigationTiming?0<(t=T.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(T.ka&&T.ka.Ea&&T.ka.Ea()&&T.ka.Ea().zb),this.f=t?this.g:1,this.a=null,1<this.f&&(this.a=new Sn),this.b=null,this.c=[]}(g=fn.prototype).add=function(t,e){dn(this),this.c=null,t=vn(this,t);var n=this.a.get(t);return n||this.a.set(t,n=[]),n.push(e),this.b+=1,this},g.forEach=function(n,r){dn(this),this.a.forEach(function(t,e){B(t,function(t){n.call(r,t,e,this)},this)},this)},g.K=function(){dn(this);for(var t=this.a.C(),e=this.a.K(),n=[],r=0;r<e.length;r++)for(var i=t[r],o=0;o<i.length;o++)n.push(e[r]);return n},g.C=function(t){dn(this);var e=[];if(S(t))mn(this,t)&&(e=U(e,this.a.get(vn(this,t))));else{t=this.a.C();for(var n=0;n<t.length;n++)e=U(e,t[n])}return e},g.set=function(t,e){return dn(this),this.c=null,mn(this,t=vn(this,t))&&(this.b-=this.a.get(t).length),this.a.set(t,[e]),this.b+=1,this},g.get=function(t,e){return t&&0<(t=this.C(t)).length?String(t[0]):e},g.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var t=[],e=this.a.K(),n=0;n<e.length;n++){var r=e[n],i=encodeURIComponent(String(r));r=this.C(r);for(var o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),t.push(a)}}return this.c=t.join("&")},F(function(){},function(){}),(g=bn.prototype).M=null,g.$=function(t){return this.a.$(t)},g.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},g.Da=function(){return!1},g.Ga=function(t,e){if(this.c=t.o,0==this.M){if(!this.a.o&&(t=t.a)){var n=Xn(t,"X-Client-Wire-Protocol");this.l=n||null,this.a.j&&(t=Xn(t,"X-HTTP-Session-Id"))&&(this.a.I=t)}if(e){try{var r=this.a.ja.a.parse(e)}catch(t){return(e=this.a).m=this.c,void lr(e,2)}this.f=r[0]}else(e=this.a).m=this.c,lr(e,2)}else 1==this.M&&(this.g?pe(6):"11111"==e?(pe(5),this.g=!0,(!it||10<=Number(dt))&&(this.c=200,this.b.cancel(),pe(11),ur(this.a,this,!0))):(pe(7),this.g=!1))},g.na=function(){if(this.c=this.b.o,this.b.b)0==this.M?(this.M=1,wn(this)):1==this.M&&(this.g?(pe(11),ur(this.a,this,!0)):(pe(10),ur(this.a,this,!1)));else{0==this.M?pe(8):1==this.M&&pe(9);var t=this.a;t.m=this.c,lr(t,2)}},g.Y=function(){return this.a.Y()},g.ma=function(){return this.a.ma()},Sn.prototype.add=function(t){this.a.set(En(t),t)},Sn.prototype.C=function(){return this.a.C()};var Dn=10;function Nn(t,e){!t.a&&(G(e,"spdy")||G(e,"quic")||G(e,"h2"))&&(t.f=t.g,t.a=new Sn,t.b&&(Mn(t,t.b),t.b=null))}function An(t){return!!t.b||!!t.a&&t.a.a.c>=t.f}function kn(t){return t.b?1:t.a?t.a.a.c:0}function Rn(t,e){return t=t.b?t.b==e:!!t.a&&(e=En(e),Ge(t.a.a.b,e))}function Mn(t,e){t.a?t.a.add(e):t.b=e}function On(t,e){var n;t.b&&t.b==e?t.b=null:((n=t.a)&&(n=En(e),n=Ge(t.a.a.b,n)),n&&je(t.a.a,En(e)))}function _n(t){if(null!=t.b)return t.c.concat(t.b.j);if(null==t.a||0==t.a.a.c)return K(t.c);var e=t.c;return B(t.a.C(),function(t){e=e.concat(t.j)}),e}function Ln(){}function Pn(){this.a=new Ln}function xn(t,r,e){var i=e||"";try{Ke(t,function(t,e){var n=t;k(t)&&(n=Qt(t)),r.push(i+e+"="+encodeURIComponent(n))})}catch(t){throw r.push(i+"type="+encodeURIComponent("_badmap")),t}}function Fn(t,e,n,r,i){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch(t){}}Cn.prototype.cancel=function(){this.c=_n(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(B(this.a.C(),function(t){t.cancel()}),function(t){t.b={},t.a.length=0,t.c=0}(this.a.a))},Ln.prototype.stringify=function(t){return T.JSON.stringify(t,void 0)},Ln.prototype.parse=function(t){return T.JSON.parse(t,void 0)};var qn=T.JSON.parse;function Vn(t){Ut.call(this),this.headers=new Qe,this.H=t||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=Bn,this.D=this.F=!1}F(Vn,Ut);var Bn="",Un=/^https?$/i,Kn=["POST","PUT"];function Qn(t){return"content-type"==t.toLowerCase()}function jn(t,e){t.b=!1,t.a&&(t.g=!0,t.a.abort(),t.g=!1),t.f=e,t.h=5,Wn(t),zn(t)}function Wn(t){t.v||(t.v=!0,t.dispatchEvent("complete"),t.dispatchEvent("error"))}function Gn(t){if(t.b&&void 0!==w&&(!t.s[1]||4!=Yn(t)||2!=t.T()))if(t.l&&4==Yn(t))ne(t.Fa,0,t);else if(t.dispatchEvent("readystatechange"),4==Yn(t)){t.b=!1;try{var e,n=t.T();t:switch(n){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var r=!0;break t;default:r=!1}if(!(e=r)){var i;if(i=0===n){var o=String(t.A).match(ze)[1]||null;if(!o&&T.self&&T.self.location){var a=T.self.location.protocol;o=a.substr(0,a.length-1)}i=!Un.test(o?o.toLowerCase():"")}e=i}e?(t.dispatchEvent("complete"),t.dispatchEvent("success")):(t.h=6,t.f=t.za()+" ["+t.T()+"]",Wn(t))}finally{zn(t)}}}function zn(t,e){if(t.a){Hn(t);var n=t.a,r=t.s[0]?C:null;t.a=null,t.s=null,e||t.dispatchEvent("ready");try{n.onreadystatechange=r}catch(t){}}}function Hn(t){t.a&&t.D&&(t.a.ontimeout=null),t.m&&(T.clearTimeout(t.m),t.m=null)}function Yn(t){return t.a?t.a.readyState:0}function Xn(t,e){return t.a?t.a.getResponseHeader(e):null}function Jn(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}if(r)return t;if(n=function(t){var n="";return X(t,function(t,e){n+=e,n+=":",n+=t,n+="\r\n"}),n}(n),S(t)){if(e=encodeURIComponent(String(e)),e+=n=null!=n?"="+encodeURIComponent(String(n)):""){if((n=t.indexOf("#"))<0&&(n=t.length),(r=t.indexOf("?"))<0||n<r){r=n;var i=""}else i=t.substring(r+1,n);n=(t=[t.substr(0,r),i,t.substr(n)])[1],t[1]=e?n?n+"&"+e:e:n,t=t[0]+(t[1]?"?"+t[1]:"")+t[2]}return t}return tn(t,e,n),t}function Zn(t){this.f=[],this.F=new Tn,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!I("internalChannelParams.failFast",t),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=I("internalChannelParams.baseRetryDelayMs",t)||5e3,this.Sa=I("internalChannelParams.retryDelaySeedMs",t)||1e4,this.Qa=I("internalChannelParams.forwardChannelMaxRetries",t)||2,this.qa=I("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.La=t&&t.Ab||void 0,this.D=void 0,this.R=t&&t.supportsCrossDomainXhr||!1,this.H="",this.b=new Cn(t&&t.concurrentRequestLimit),this.ja=new Pn,this.o=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.W=t&&t.fastHandshake||!1)&&!this.o&&(this.o=!0),t&&t.forceLongPolling&&(this.oa=!1),this.fa=void 0}function $n(t){if(tr(t),3==t.u){var e=t.P++,n=Ye(t.B);tn(n,"SID",t.H),tn(n,"RID",e),tn(n,"TYPE","terminate"),ir(t,n),(e=new Ne(t,e,void 0)).F=2,e.f=nn(Ye(n)),n=!1,T.navigator&&T.navigator.sendBeacon&&(n=T.navigator.sendBeacon(e.f.toString(),"")),!n&&T.Image&&((new Image).src=e.f,n=!0),n||(e.a=e.g.$(null),e.a.ca(e.f)),e.v=x(),xe(e)}fr(t)}function tr(t){t.w&&(t.w.abort(),t.w=null),t.a&&(t.a.cancel(),t.a=null),t.l&&(T.clearTimeout(t.l),t.l=null),cr(t),t.b.cancel(),t.h&&(E(t.h)&&T.clearTimeout(t.h),t.h=null)}function er(t,e){t.f.push(new In(t.Ra++,e)),3==t.u&&nr(t)}function nr(t){An(t.b)||t.h||(t.h=!0,Xt(t.Ia,t),t.A=0)}function rr(t,e){var n;n=e?e.W:t.P++;var r=Ye(t.B);tn(r,"SID",t.H),tn(r,"RID",n),tn(r,"AID",t.O),ir(t,r),t.g&&t.i&&Jn(r,t.g,t.i),n=new Ne(t,n,t.A+1),null===t.g&&(n.h=t.i),e&&(t.f=e.j.concat(t.f)),e=or(t,n,1e3),n.setTimeout(Math.round(.5*t.qa)+Math.round(.5*t.qa*Math.random())),Mn(t.b,n),Me(n,r,e)}function ir(t,n){t.c&&Ke({},function(t,e){tn(n,e,t)})}function or(t,e,n){n=Math.min(t.f.length,n);var r=t.c?L(t.c.Ta,t.c,t):null;t:for(var i=t.f,o=-1;;){var a=["count="+n];-1==o?0<n?(o=i[0].b,a.push("ofs="+o)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,h=i[u].a;if((c-=o)<0)o=Math.max(0,i[u].b-100),s=!1;else try{xn(h,a,"req"+c+"_")}catch(t){r&&r(h)}}if(s){r=a.join("&");break t}}return t=t.f.splice(0,n),e.j=t,r}function ar(t){t.a||t.l||(t.S=1,Xt(t.Ha,t),t.v=0)}function sr(t){return!(t.a||t.l||3<=t.v)&&(t.S++,t.l=ye(L(t.Ha,t),hr(t,t.v)),t.v++,!0)}function ur(t,e,n){var r=e.l;r&&Nn(t.b,r),t.ia=t.oa&&n,t.m=e.c,t.B=dr(t,null,t.ha),nr(t)}function cr(t){null!=t.s&&(T.clearTimeout(t.s),t.s=null)}function hr(t,e){var n=t.Oa+Math.floor(Math.random()*t.Sa);return t.ma()||(n*=2),n*e}function lr(t,e){if(2==e){var n=null;t.c&&(n=null);var r=L(t.fb,t);n||(n=new He("//www.google.com/images/cleardot.gif"),T.location&&"http"==T.location.protocol||Xe(n,"https"),nn(n)),function(t,e){var n=new ce;if(T.Image){var r=new Image;r.onload=P(Fn,n,r,"TestLoadImage: loaded",!0,e),r.onerror=P(Fn,n,r,"TestLoadImage: error",!1,e),r.onabort=P(Fn,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=P(Fn,n,r,"TestLoadImage: timeout",!1,e),T.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}(n.toString(),r)}else pe(2);t.u=0,t.c&&t.c.ta(e),fr(t),tr(t)}function fr(t){t.u=0,t.m=-1,t.c&&(0==_n(t.b).length&&0==t.f.length||(t.b.c.length=0,K(t.f),t.f.length=0),t.c.sa())}function dr(t,e,n){var r=function(t){return t instanceof He?Ye(t):new He(t,void 0)}(n);if(""!=r.b)e&&Je(r,e+"."+r.b),Ze(r,r.i);else{var i,o=T.location;i=e?e+"."+o.hostname:o.hostname,r=function(t,e,n,r){var i=new He(null,void 0);return t&&Xe(i,t),e&&Je(i,e),n&&Ze(i,n),r&&(i.a=r),i}(o.protocol,i,+o.port,n)}return t.V&&X(t.V,function(t,e){tn(r,e,t)}),e=t.j,n=t.I,e&&n&&tn(r,e,n),tn(r,"VER",t.wa),ir(t,r),r}function pr(){}function mr(){if(it&&!(10<=Number(dt)))throw Error("Environmental error: no available transport.")}function yr(t,e){Ut.call(this),this.a=new Zn(e),this.g=t,this.m=e&&e.testUrl?e.testUrl:function(t){for(var e=t,n=1;n<arguments.length;n++){var r,i=arguments[n];if(0==i.lastIndexOf("/",0))e=i;else(r=""==e)||(r=0<=(r=e.length-1)&&e.indexOf("/",r)==r),e+=r?i:"/"+i}return e}(this.g,"test"),this.b=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.a.i=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.xa&&(t?t["X-WebChannel-Client-Profile"]=e.xa:t={"X-WebChannel-Client-Profile":e.xa}),this.a.J=t,(t=e&&e.httpHeadersOverwriteParam)&&!Q(t)&&(this.a.g=t),this.l=e&&e.supportsCrossDomainXhr||!1,this.h=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!Q(e)&&(this.a.j=e,null!==(t=this.b)&&e in t&&(e in(t=this.b)&&delete t[e])),this.f=new br(this)}function gr(t){Ie.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.c=t)?(t=this.c,this.data=null!==e&&t in e?e[t]:void 0):this.data=e}else this.data=t}function vr(){Ce.call(this),this.status=1}function br(t){this.a=t}(g=Vn.prototype).ca=function(t,e,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+t);e=e?e.toUpperCase():"GET",this.A=t,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?we(this.H):we(Se),this.a.onreadystatechange=L(this.Fa,this);try{this.w=!0,this.a.open(e,String(t),!0),this.w=!1}catch(t){return void jn(this,t)}t=n||"";var i=new Qe(this.headers);r&&Ke(r,function(t,e){i.set(e,t)}),r=function(t){t:{for(var e=Qn,n=t.length,r=S(t)?t.split(""):t,i=0;i<n;i++)if(i in r&&e.call(void 0,r[i],i,t)){e=i;break t}e=-1}return e<0?null:S(t)?t.charAt(e):t[e]}(i.K()),n=T.FormData&&t instanceof T.FormData,0<=V(Kn,e)&&!r&&!n&&i.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),i.forEach(function(t,e){this.a.setRequestHeader(e,t)},this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{Hn(this),0<this.o&&((this.D=function(t){return it&&mt(9)&&E(t.timeout)&&void 0!==t.ontimeout}(this.a))?(this.a.timeout=this.o,this.a.ontimeout=L(this.Ca,this)):this.m=ne(this.Ca,this.o,this)),this.l=!0,this.a.send(t),this.l=!1}catch(t){jn(this,t)}},g.Ca=function(){void 0!==w&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},g.abort=function(t){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),zn(this))},g.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),zn(this,!0)),Vn.N.G.call(this)},g.Fa=function(){this.j||(this.w||this.l||this.g?Gn(this):this.$a())},g.$a=function(){Gn(this)},g.T=function(){try{return 2<Yn(this)?this.a.status:-1}catch(t){return-1}},g.za=function(){try{return 2<Yn(this)?this.a.statusText:""}catch(t){return""}},g.aa=function(){try{return this.a?this.a.responseText:""}catch(t){return""}},g.Va=function(t){if(this.a){var e=this.a.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),qn(e)}},g.ya=function(){return this.h},g.Ya=function(){return S(this.f)?this.f:String(this.f)},(g=Zn.prototype).wa=8,g.u=1,g.Da=function(){return 0==this.u},g.Ia=function(t){if(this.h)if(this.h=null,1==this.u){if(!t){this.P=Math.floor(1e5*Math.random()),t=this.P++;var e,n=new Ne(this,t,void 0),r=this.i;if(this.J&&(r?$(r=J(r),this.J):r=this.J),null===this.g&&(n.h=r),this.W)t:{for(var i=e=0;i<this.f.length;i++){var o=this.f[i];if(void 0===(o="__data__"in o.a&&S(o=o.a.__data__)?o.length:void 0))break;if(4096<(e+=o)){e=i;break t}if(4096===e||i===this.f.length-1){e=i+1;break t}}e=1e3}else e=1e3;e=or(this,n,e),tn(i=Ye(this.B),"RID",t),tn(i,"CVER",22),this.o&&this.j&&tn(i,"X-HTTP-Session-Id",this.j),ir(this,i),this.g&&r&&Jn(i,this.g,r),Mn(this.b,n),this.W?(tn(i,"$req",e),tn(i,"SID","null"),n.S=!0,Me(n,i,null)):Me(n,i,e),this.u=2}}else 3==this.u&&(t?rr(this,t):0==this.f.length||An(this.b)||rr(this))},g.Ha=function(){this.l=null,this.a=new Ne(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var t=Ye(this.pa);tn(t,"RID","rpc"),tn(t,"SID",this.H),tn(t,"CI",this.ia?"0":"1"),tn(t,"AID",this.O),ir(this,t),tn(t,"TYPE","xmlhttp"),this.g&&this.i&&Jn(t,this.g,this.i),this.D&&this.a.setTimeout(this.D),Oe(this.a,t,!0,this.ga)},g.Ga=function(t,e){if(0!=this.u&&(this.a==t||Rn(this.b,t)))if(this.m=t.o,!t.s&&Rn(this.b,t)&&3==this.u){try{var n=this.ja.a.parse(e)}catch(t){n=null}if(N(n)&&3==n.length){if(0==(e=n)[0]){t:if(!this.l){if(this.a){if(!(this.a.v+3e3<t.v))break t;cr(this),this.a.cancel(),this.a=null}sr(this),pe(18)}}else this.ra=e[1],0<this.ra-this.O&&e[2]<37500&&this.ia&&0==this.v&&!this.s&&(this.s=ye(L(this.Za,this),6e3));if(kn(this.b)<=1&&this.fa){try{this.fa()}catch(t){}this.fa=void 0}}else lr(this,11)}else if(!t.s&&this.a!=t||cr(this),!Q(e))for(e=n=this.ja.a.parse(e),n=0;n<e.length;n++){var r=e[n];if(this.O=r[0],r=r[1],2==this.u)if("c"==r[0]){this.H=r[1],this.ga=r[2];var i=r[3];null!=i&&(this.wa=i),null!=(r=r[5])&&E(r)&&0<r&&(this.D=1.5*r),this.o&&(r=t.a)&&((i=Xn(r,"X-Client-Wire-Protocol"))&&Nn(this.b,i),this.j&&(r=Xn(r,"X-HTTP-Session-Id")))&&(this.I=r,tn(this.B,this.j,r)),this.u=3,this.c&&this.c.va(),r=t,this.pa=dr(this,this.Y()?this.ga:null,this.ha),r.s?(On(this.b,r),(i=this.D)&&r.setTimeout(i),r.i&&(qe(r),xe(r)),this.a=r):ar(this),0<this.f.length&&nr(this)}else"stop"!=r[0]&&"close"!=r[0]||lr(this,7);else 3==this.u&&("stop"==r[0]||"close"==r[0]?"stop"==r[0]?lr(this,7):$n(this):"noop"!=r[0]&&this.c&&this.c.ua(r),this.v=0)}},g.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,sr(this),pe(19))},g.na=function(t){var e=null;if(this.a==t){cr(this),this.a=null;var n=2}else{if(!Rn(this.b,t))return;e=t.j,On(this.b,t),n=1}if(this.m=t.o,0!=this.u)if(t.b)1==n?(e=x()-t.v,he.dispatchEvent(new me(he,t.l?t.l.length:0,e,this.A)),nr(this)):ar(this);else{var r=t.c;if(3==r||0==r&&0<this.m||!(1==n&&function(t,e){return!(kn(t.b)>=t.b.f-(t.h?1:0))&&(t.h?(t.f=e.j.concat(t.f),!0):!(1==t.u||2==t.u||t.A>=(t.Pa?0:t.Qa))&&(t.h=ye(L(t.Ia,t,e),hr(t,t.A)),t.A++,!0))}(this,t)||2==n&&sr(this)))switch(e&&0<e.length&&(t=this.b,t.c=t.c.concat(e)),r){case 1:lr(this,5);break;case 4:lr(this,10);break;case 3:lr(this,6);break;default:lr(this,2)}}},g.fb=function(t){pe(t?2:1)},g.$=function(t){if(t&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new Vn(this.La)).F=this.R,t},g.ma=function(){return!!this.c&&!0},g.Y=function(){return this.R},(g=pr.prototype).va=function(){},g.ua=function(){},g.ta=function(){},g.sa=function(){},g.Ta=function(){},mr.prototype.a=function(t,e){return new yr(t,e)},F(yr,Ut),(g=yr.prototype).addEventListener=function(t,e,n,r){yr.N.addEventListener.call(this,t,e,n,r)},g.removeEventListener=function(t,e,n,r){yr.N.removeEventListener.call(this,t,e,n,r)},g.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var t=this.a,e=this.m,n=this.g,r=this.b||void 0;pe(0),t.ha=n,t.V=r||{},t.o&&(t.F.b=[],t.F.a=!1),t.w=new bn(t),null===t.g&&(t.w.h=t.i),n=e,t.g&&t.i&&(n=Jn(e,t.g,t.i)),(t=t.w).i=n,e=dr(t.a,null,t.i),pe(3),null!=(n=t.a.F.b)?(t.f=n[0],t.M=1,wn(t)):(en(e,"MODE","init"),!t.a.o&&t.a.j&&en(e,"X-HTTP-Session-Id",t.a.j),t.b=new Ne(t,void 0,void 0),t.b.h=t.h,Oe(t.b,e,!1,null),t.M=0)},g.close=function(){$n(this.a)},g.Xa=function(t){if(S(t)){var e={};e.__data__=t,er(this.a,e)}else this.h?((e={}).__data__=Qt(t),er(this.a,e)):er(this.a,t)},g.G=function(){this.a.c=null,delete this.f,$n(this.a),delete this.a,yr.N.G.call(this)},F(gr,Ie),F(vr,Ce),F(br,pr),br.prototype.va=function(){this.a.dispatchEvent("a")},br.prototype.ua=function(t){this.a.dispatchEvent(new gr(t))},br.prototype.ta=function(t){this.a.dispatchEvent(new vr(t))},br.prototype.sa=function(){this.a.dispatchEvent("b")};var wr=P(function(t,e){function n(){}n.prototype=t.prototype;var r=new n;return t.apply(r,Array.prototype.slice.call(arguments,1)),r},mr);mr.prototype.createWebChannel=mr.prototype.a,yr.prototype.send=yr.prototype.Xa,yr.prototype.open=yr.prototype.Wa,yr.prototype.close=yr.prototype.close,ge.NO_ERROR=0,ge.TIMEOUT=8,ge.HTTP_ERROR=6,ve.COMPLETE="complete",(Te.EventType=Ee).OPEN="a",Ee.CLOSE="b",Ee.ERROR="c",Ee.MESSAGE="d",Ut.prototype.listen=Ut.prototype.Aa,Vn.prototype.listenOnce=Vn.prototype.Ba,Vn.prototype.getLastError=Vn.prototype.Ya,Vn.prototype.getLastErrorCode=Vn.prototype.ya,Vn.prototype.getStatus=Vn.prototype.T,Vn.prototype.getStatusText=Vn.prototype.za,Vn.prototype.getResponseJson=Vn.prototype.Va,Vn.prototype.getResponseText=Vn.prototype.aa,Vn.prototype.send=Vn.prototype.ca;var Tr,Sr,Er={createWebChannelTransport:wr,ErrorCode:ge,EventType:ve,WebChannel:Te,XhrIo:Vn},Ir=Er.createWebChannelTransport,Cr=Er.ErrorCode,Dr=Er.EventType,Nr=Er.WebChannel,Ar=Er.XhrIo,kr=Kp.SDK_VERSION,Rr=new r("@firebase/firestore");function Mr(){return Rr.logLevel===o.DEBUG?Tr.DEBUG:Rr.logLevel===o.SILENT?Tr.SILENT:Tr.ERROR}function Or(t){switch(t){case Tr.DEBUG:Rr.logLevel=o.DEBUG;break;case Tr.ERROR:Rr.logLevel=o.ERROR;break;case Tr.SILENT:Rr.logLevel=o.SILENT;break;default:Rr.error("Firestore ("+kr+"): Invalid value passed to `setLogLevel`")}}function _r(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(Rr.logLevel<=o.DEBUG){var i=n.map(Pr);Rr.debug.apply(Rr,["Firestore ("+kr+") ["+t+"]: "+e].concat(i))}}function Lr(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(Rr.logLevel<=o.ERROR){var r=e.map(Pr);Rr.error.apply(Rr,["Firestore ("+kr+"): "+t].concat(r))}}function Pr(e){if("string"==typeof e)return e;var t=qr.getPlatform();try{return t.formatJSON(e)}catch(t){return e}}function xr(t){var e="FIRESTORE ("+kr+") INTERNAL ASSERTION FAILED: "+t;throw Lr(e),new Error(e)}function Fr(t,e){t||xr(e)}(Sr=Tr=Tr||{})[Sr.DEBUG=0]="DEBUG",Sr[Sr.ERROR=1]="ERROR",Sr[Sr.SILENT=2]="SILENT";var qr=(Vr.setPlatform=function(t){Vr.platform&&xr("Platform already defined"),Vr.platform=t},Vr.getPlatform=function(){return Vr.platform||xr("Platform not set"),Vr.platform},Vr);function Vr(){}function Br(){return qr.getPlatform().emptyByteString}var Ur,Kr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},Qr=(s(jr,Ur=Error),jr);function jr(t,e){var n=Ur.call(this,e)||this;return n.code=t,n.message=e,n.name="FirebaseError",n.toString=function(){return n.name+": [code="+n.code+"]: "+n.message},n}function Wr(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new Qr(Kr.INVALID_ARGUMENT,t)}for(var r in n.prototype=t.prototype,t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function Gr(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function zr(t,e){return void 0!==t?t:e}function Hr(t,e){for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=Number(n);isNaN(r)||e(r,t[n])}}function Yr(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Xr(t){for(var e in Fr(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function Jr(t,e){if(0!==e.length)throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+mi(e.length,"argument")+".")}function Zr(t,e,n){if(e.length!==n)throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() requires "+mi(n,"argument")+", but was called with "+mi(e.length,"argument")+".")}function $r(t,e,n){if(e.length<n)throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() requires at least "+mi(n,"argument")+", but was called with "+mi(e.length,"argument")+".")}function ti(t,e,n,r){if(e.length<n||e.length>r)throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+mi(e.length,"argument")+".")}function ei(t,e,n,r){si(t,e,pi(n)+" argument",r)}function ni(t,e,n,r){void 0!==r&&ei(t,e,n,r)}function ri(t,e,n,r){si(t,e,n+" option",r)}function ii(t,e,n,r){void 0!==r&&ri(t,e,n,r)}function oi(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){if(!(r instanceof Array))throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+ci(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+o+" was: "+ci(r[o]))}(t,e,n,r,i)}function ai(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){for(var o=[],a=0,s=i;a<s.length;a++){var u=s[a];if(u===r)return;o.push(ci(u))}var c=ci(r);throw new Qr(Kr.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+t+'() for option "'+n+'". Acceptable values: '+o.join(", "))}(t,0,n,r,i)}function si(t,e,n,r){if(!("object"===e?ui(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){var i=ci(r);throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+i)}}function ui(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function ci(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return 20<t.length&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"!=typeof t)return"function"==typeof t?"a function":xr("Unknown wrong type: "+typeof t);if(t instanceof Array)return"an array";var e=function(t){if(t.constructor){var e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&1<e.length)return e[1]}return null}(t);return e?"a custom "+e+" object":"an object"}function hi(t,e,n){if(void 0===n)throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+pi(e)+" argument, but it was undefined.")}function li(n,t,r){Yr(t,function(t,e){if(r.indexOf(t)<0)throw new Qr(Kr.INVALID_ARGUMENT,"Unknown option '"+t+"' passed to function "+n+"(). Available options: "+r.join(", "))})}function fi(t,e,n,r){var i=ci(r);return new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() requires its "+pi(n)+" argument to be a "+e+", but it was: "+i)}function di(t,e,n){if(n<=0)throw new Qr(Kr.INVALID_ARGUMENT,'Function "'+t+'()" requires its '+pi(e)+" argument to be a positive number, but it was: "+n+".")}function pi(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function mi(t,e){return t+" "+e+(1===t?"":"s")}var yi=(gi.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return Fr(20===e.length,"Invalid auto ID: "+e),e},gi);function gi(){}function vi(t,e){return t<e?-1:e<t?1:0}function bi(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function wi(t){return t+"\0"}function Ti(){if("undefined"==typeof Uint8Array)throw new Qr(Kr.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function Si(){if(!qr.getPlatform().base64Available)throw new Qr(Kr.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var Ei=(Ii.fromBase64String=function(t){Zr("Blob.fromBase64String",arguments,1),ei("Blob.fromBase64String","string",1,t),Si();try{return new Ii(qr.getPlatform().atob(t))}catch(t){throw new Qr(Kr.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},Ii.fromUint8Array=function(t){if(Zr("Blob.fromUint8Array",arguments,1),Ti(),!(t instanceof Uint8Array))throw fi("Blob.fromUint8Array","Uint8Array",1,t);return new Ii(Array.prototype.map.call(t,function(t){return String.fromCharCode(t)}).join(""))},Ii.prototype.toBase64=function(){return Zr("Blob.toBase64",arguments,0),Si(),qr.getPlatform().btoa(this._binaryString)},Ii.prototype.toUint8Array=function(){Zr("Blob.toUint8Array",arguments,0),Ti();for(var t=new Uint8Array(this._binaryString.length),e=0;e<this._binaryString.length;e++)t[e]=this._binaryString.charCodeAt(e);return t},Ii.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},Ii.prototype.isEqual=function(t){return this._binaryString===t._binaryString},Ii.prototype._compareTo=function(t){return vi(this._binaryString,t._binaryString)},Ii);function Ii(t){Si(),this._binaryString=t}var Ci=Wr(Ei,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),Di=function(t,e,n,r,i){this.databaseId=t,this.persistenceKey=e,this.host=n,this.ssl=r,this.forceLongPolling=i},Ni="(default)",Ai=(Object.defineProperty(ki.prototype,"isDefaultDatabase",{get:function(){return this.database===Ni},enumerable:!0,configurable:!0}),ki.prototype.isEqual=function(t){return t instanceof ki&&t.projectId===this.projectId&&t.database===this.database},ki.prototype.compareTo=function(t){return vi(this.projectId,t.projectId)||vi(this.database,t.database)},ki);function ki(t,e){this.projectId=t,this.database=e||Ni}var Ri=(Mi.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},Mi.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},Mi.INVALID=-1,Mi);function Mi(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return e.writeSequenceNumber(t)})}var Oi="__name__",_i=(Object.defineProperty(Li.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),Li.prototype.isEqual=function(t){return 0===Li.comparator(this,t)},Li.prototype.child=function(t){var e=this.segments.slice(this.offset,this.limit());return t instanceof Li?t.forEach(function(t){e.push(t)}):e.push(t),this.construct(e)},Li.prototype.limit=function(){return this.offset+this.length},Li.prototype.popFirst=function(t){return t=void 0===t?1:t,Fr(this.length>=t,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},Li.prototype.popLast=function(){return Fr(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},Li.prototype.firstSegment=function(){return Fr(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},Li.prototype.lastSegment=function(){return this.get(this.length-1)},Li.prototype.get=function(t){return Fr(t<this.length,"Index out of range"),this.segments[this.offset+t]},Li.prototype.isEmpty=function(){return 0===this.length},Li.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},Li.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},Li.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},Li.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},Li.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(o<i)return 1}return t.length<e.length?-1:t.length>e.length?1:0},Li);function Li(t,e,n){void 0===e?e=0:e>t.length&&xr("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&xr("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n}var Pi,xi=(s(Fi,Pi=_i),Fi.prototype.construct=function(t,e,n){return new Fi(t,e,n)},Fi.prototype.canonicalString=function(){return this.toArray().join("/")},Fi.prototype.toString=function(){return this.canonicalString()},Fi.fromString=function(t){if(0<=t.indexOf("//"))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new Fi(t.split("/").filter(function(t){return 0<t.length}))},Fi.EMPTY_PATH=new Fi([]),Fi);function Fi(){return null!==Pi&&Pi.apply(this,arguments)||this}var qi,Vi=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Bi=(s(Ui,qi=_i),Ui.prototype.construct=function(t,e,n){return new Ui(t,e,n)},Ui.isValidIdentifier=function(t){return Vi.test(t)},Ui.prototype.canonicalString=function(){return this.toArray().map(function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),Ui.isValidIdentifier(t)||(t="`"+t+"`"),t}).join(".")},Ui.prototype.toString=function(){return this.canonicalString()},Ui.prototype.isKeyField=function(){return 1===this.length&&this.get(0)===Oi},Ui.keyField=function(){return new Ui([Oi])},Ui.fromServerFormat=function(t){for(var e=[],n="",r=0,i=function(){if(0===n.length)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");e.push(n),n=""},o=!1;r<t.length;){var a=t[r];if("\\"===a){if(r+1===t.length)throw new Qr(Kr.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var s=t[r+1];if("\\"!==s&&"."!==s&&"`"!==s)throw new Qr(Kr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=s,r+=2}else"`"===a?o=!o:"."!==a||o?n+=a:i(),r++}if(i(),o)throw new Qr(Kr.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Ui(e)},Ui.EMPTY_PATH=new Ui([]),Ui);function Ui(){return null!==qi&&qi.apply(this,arguments)||this}var Ki=(Qi.prototype.hasCollectionId=function(t){return 2<=this.path.length&&this.path.get(this.path.length-2)===t},Qi.prototype.isEqual=function(t){return null!==t&&0===xi.comparator(this.path,t.path)},Qi.prototype.toString=function(){return this.path.toString()},Qi.comparator=function(t,e){return xi.comparator(t.path,e.path)},Qi.isDocumentKey=function(t){return t.length%2==0},Qi.fromSegments=function(t){return new Qi(new xi(t.slice()))},Qi.fromPathString=function(t){return new Qi(xi.fromString(t))},Qi.EMPTY=new Qi(new xi([])),Qi);function Qi(t){this.path=t,Fr(Qi.isDocumentKey(t),"Invalid DocumentKey with an odd number of segments: "+t.toArray().join("/"))}var ji,Wi,Gi=function(){var n=this;this.promise=new Promise(function(t,e){n.resolve=t,n.reject=e})};(Wi=ji=ji||{}).All="all",Wi.ListenStreamIdle="listen_stream_idle",Wi.ListenStreamConnectionBackoff="listen_stream_connection_backoff",Wi.WriteStreamIdle="write_stream_idle",Wi.WriteStreamConnectionBackoff="write_stream_connection_backoff",Wi.OnlineStateTimeout="online_state_timeout",Wi.ClientMetadataRefresh="client_metadata_refresh",Wi.LruGarbageCollection="lru_garbage_collection",Wi.RetryTransaction="retry_transaction";var zi=(Hi.createAndSchedule=function(t,e,n,r,i){var o=new Hi(t,e,Date.now()+n,r,i);return o.start(n),o},Hi.prototype.start=function(t){var e=this;this.timerHandle=setTimeout(function(){return e.handleDelayElapsed()},t)},Hi.prototype.skipDelay=function(){return this.handleDelayElapsed()},Hi.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Qr(Kr.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},Hi.prototype.handleDelayElapsed=function(){var e=this;this.asyncQueue.enqueueAndForget(function(){return null!==e.timerHandle?(e.clearTimeout(),e.op().then(function(t){return e.deferred.resolve(t)})):Promise.resolve()})},Hi.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},Hi);function Hi(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Gi,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(t){})}var Yi=(Object.defineProperty(Xi.prototype,"isShuttingDown",{get:function(){return this._isShuttingDown},enumerable:!0,configurable:!0}),Xi.prototype.enqueueAndForget=function(t){this.enqueue(t)},Xi.prototype.enqueueAndForgetEvenAfterShutdown=function(t){this.verifyNotFailed(),this.enqueueInternal(t)},Xi.prototype.enqueueEvenAfterShutdown=function(t){return this.verifyNotFailed(),this.enqueueInternal(t)},Xi.prototype.enqueueAndInitiateShutdown=function(e){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.verifyNotFailed(),this._isShuttingDown?[3,2]:(this._isShuttingDown=!0,[4,this.enqueueEvenAfterShutdown(e)]);case 1:t.sent(),t.label=2;case 2:return[2]}})})},Xi.prototype.enqueue=function(t){return this.verifyNotFailed(),this._isShuttingDown?new Promise(function(t){}):this.enqueueInternal(t)},Xi.prototype.enqueueInternal=function(t){var n=this,e=this.tail.then(function(){return n.operationInProgress=!0,t().catch(function(t){n.failure=t,n.operationInProgress=!1;var e=t.stack||t.message||"";throw Lr("INTERNAL UNHANDLED ERROR: ",e),e.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw t},0),t}).then(function(t){return n.operationInProgress=!1,t})});return this.tail=e},Xi.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.verifyNotFailed(),Fr(0<=e,"Attempted to schedule an operation with a negative delay of "+e),-1<this.timerIdsToSkip.indexOf(t)&&(e=0);var i=zi.createAndSchedule(this,t,e,n,function(t){return r.removeDelayedOperation(t)});return this.delayedOperations.push(i),i},Xi.prototype.verifyNotFailed=function(){this.failure&&xr("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},Xi.prototype.verifyOperationInProgress=function(){Fr(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},Xi.prototype.drain=function(){return this.enqueueEvenAfterShutdown(function(){return Promise.resolve()})},Xi.prototype.containsDelayedOperation=function(t){for(var e=0,n=this.delayedOperations;e<n.length;e++)if(n[e].timerId===t)return!0;return!1},Xi.prototype.runDelayedOperationsEarly=function(r){var i=this;return this.drain().then(function(){Fr(r===ji.All||i.containsDelayedOperation(r),"Attempted to drain to missing operation "+r),i.delayedOperations.sort(function(t,e){return t.targetTimeMs-e.targetTimeMs});for(var t=0,e=i.delayedOperations;t<e.length;t++){var n=e[t];if(n.skipDelay(),r!==ji.All&&n.timerId===r)break}return i.drain()})},Xi.prototype.skipDelaysForTimerId=function(t){this.timerIdsToSkip.push(t)},Xi.prototype.removeDelayedOperation=function(t){var e=this.delayedOperations.indexOf(t);Fr(0<=e,"Delayed operation not found."),this.delayedOperations.splice(e,1)},Xi);function Xi(){this.tail=Promise.resolve(),this._isShuttingDown=!1,this.delayedOperations=[],this.failure=null,this.operationInProgress=!1,this.timerIdsToSkip=[]}var Ji="",Zi="",$i="",to="";function eo(t){for(var e="",n=0;n<t.length;n++)0<e.length&&(e=ro(e)),e=no(t.get(n),e);return ro(e)}function no(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+=Ji+$i;break;case Ji:n+=Ji+to;break;default:n+=o}}return n}function ro(t){return t+Ji+Zi}function io(t){var e=t.length;if(Fr(2<=e,"Invalid path "+t),2===e)return Fr(t.charAt(0)===Ji&&t.charAt(1)===Zi,"Non-empty path "+t+" had length 2"),xi.EMPTY_PATH;for(var n=e-2,r=[],i="",o=0;o<e;){var a=t.indexOf(Ji,o);switch((a<0||n<a)&&xr('Invalid encoded resource path: "'+t+'"'),t.charAt(a+1)){case Zi:var s=t.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case $i:i+=t.substring(o,a),i+="\0";break;case to:i+=t.substring(o,a+1);break;default:xr('Invalid encoded resource path: "'+t+'"')}o=a+2}return new xi(r)}var oo=(ao.now=function(){return ao.fromMillis(Date.now())},ao.fromDate=function(t){return ao.fromMillis(t.getTime())},ao.fromMillis=function(t){var e=Math.floor(t/1e3);return new ao(e,1e6*(t-1e3*e))},ao.prototype.toDate=function(){return new Date(this.toMillis())},ao.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},ao.prototype._compareTo=function(t){return this.seconds===t.seconds?vi(this.nanoseconds,t.nanoseconds):vi(this.seconds,t.seconds)},ao.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},ao.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},ao);function ao(t,e){if(this.seconds=t,(this.nanoseconds=e)<0)throw new Qr(Kr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(1e9<=e)throw new Qr(Kr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Qr(Kr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(253402300800<=t)throw new Qr(Kr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}var so=(uo.fromMicroseconds=function(t){var e=Math.floor(t/1e6);return new uo(new oo(e,t%1e6*1e3))},uo.fromTimestamp=function(t){return new uo(t)},uo.forDeletedDoc=function(){return uo.MIN},uo.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},uo.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},uo.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},uo.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},uo.prototype.toTimestamp=function(){return this.timestamp},uo.MIN=new uo(new oo(0,0)),uo);function uo(t){this.timestamp=t}var co=(ho.prototype.insert=function(t,e){return new ho(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,po.BLACK,null,null))},ho.prototype.remove=function(t){return new ho(this.comparator,this.root.remove(t,this.comparator).copy(null,null,po.BLACK,null,null))},ho.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:0<n&&(e=e.right)}return null},ho.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;n=r<0?n.left:(e+=n.left.size+1,n.right)}return-1},ho.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(ho.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),ho.prototype.minKey=function(){return this.root.minKey()},ho.prototype.maxKey=function(){return this.root.maxKey()},ho.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},ho.prototype.forEach=function(n){this.inorderTraversal(function(t,e){return n(t,e),!1})},ho.prototype.toString=function(){var n=[];return this.inorderTraversal(function(t,e){return n.push(t+":"+e),!1}),"{"+n.join(", ")+"}"},ho.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},ho.prototype.getIterator=function(){return new lo(this.root,null,this.comparator,!1)},ho.prototype.getIteratorFrom=function(t){return new lo(this.root,t,this.comparator,!1)},ho.prototype.getReverseIterator=function(){return new lo(this.root,null,this.comparator,!0)},ho.prototype.getReverseIteratorFrom=function(t){return new lo(this.root,t,this.comparator,!0)},ho);function ho(t,e){this.comparator=t,this.root=e||po.EMPTY}var lo=(fo.prototype.getNext=function(){Fr(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},fo.prototype.hasNext=function(){return 0<this.nodeStack.length},fo.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},fo);function fo(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}var po=(mo.prototype.copy=function(t,e,n,r,i){return new mo(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)},mo.prototype.isEmpty=function(){return!1},mo.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},mo.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},mo.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},mo.prototype.minKey=function(){return this.min().key},mo.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},mo.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},mo.prototype.removeMin=function(){if(this.left.isEmpty())return mo.EMPTY;var t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),(t=t.copy(null,null,null,t.left.removeMin(),null)).fixUp()},mo.prototype.remove=function(t,e){var n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return mo.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()},mo.prototype.isRed=function(){return this.color},mo.prototype.fixUp=function(){var t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t},mo.prototype.moveRedLeft=function(){var t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t},mo.prototype.moveRedRight=function(){var t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t},mo.prototype.rotateLeft=function(){var t=this.copy(null,null,mo.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},mo.prototype.rotateRight=function(){var t=this.copy(null,null,mo.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},mo.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},mo.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},mo.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw xr("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw xr("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw xr("Black depths differ");return t+(this.isRed()?0:1)},mo.EMPTY=null,mo.RED=!0,mo.BLACK=!1,mo);function mo(t,e,n,r,i){this.key=t,this.value=e,this.color=null!=n?n:mo.RED,this.left=null!=r?r:mo.EMPTY,this.right=null!=i?i:mo.EMPTY,this.size=this.left.size+1+this.right.size}var yo=(Object.defineProperty(go.prototype,"key",{get:function(){throw xr("LLRBEmptyNode has no key.")},enumerable:!0,configurable:!0}),Object.defineProperty(go.prototype,"value",{get:function(){throw xr("LLRBEmptyNode has no value.")},enumerable:!0,configurable:!0}),Object.defineProperty(go.prototype,"color",{get:function(){throw xr("LLRBEmptyNode has no color.")},enumerable:!0,configurable:!0}),Object.defineProperty(go.prototype,"left",{get:function(){throw xr("LLRBEmptyNode has no left child.")},enumerable:!0,configurable:!0}),Object.defineProperty(go.prototype,"right",{get:function(){throw xr("LLRBEmptyNode has no right child.")},enumerable:!0,configurable:!0}),go.prototype.copy=function(t,e,n,r,i){return this},go.prototype.insert=function(t,e,n){return new po(t,e)},go.prototype.remove=function(t,e){return this},go.prototype.isEmpty=function(){return!0},go.prototype.inorderTraversal=function(t){return!1},go.prototype.reverseTraversal=function(t){return!1},go.prototype.minKey=function(){return null},go.prototype.maxKey=function(){return null},go.prototype.isRed=function(){return!1},go.prototype.checkMaxDepth=function(){return!0},go.prototype.check=function(){return 0},go);function go(){this.size=0}po.EMPTY=new yo;var vo=(bo.fromMapKeys=function(t){var e=new bo(t.comparator);return t.forEach(function(t){e=e.add(t)}),e},bo.prototype.has=function(t){return null!==this.data.get(t)},bo.prototype.first=function(){return this.data.minKey()},bo.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(bo.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),bo.prototype.indexOf=function(t){return this.data.indexOf(t)},bo.prototype.forEach=function(n){this.data.inorderTraversal(function(t,e){return n(t),!1})},bo.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,t[1]))return;e(r.key)}},bo.prototype.forEachWhile=function(t,e){var n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return},bo.prototype.firstAfterOrEqual=function(t){var e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null},bo.prototype.getIterator=function(){return new wo(this.data.getIterator())},bo.prototype.getIteratorFrom=function(t){return new wo(this.data.getIteratorFrom(t))},bo.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},bo.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},bo.prototype.isEmpty=function(){return this.data.isEmpty()},bo.prototype.unionWith=function(t){var e=this;return t.forEach(function(t){e=e.add(t)}),e},bo.prototype.isEqual=function(t){if(!(t instanceof bo))return!1;if(this.size!==t.size)return!1;for(var e=this.data.getIterator(),n=t.data.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(0!==this.comparator(r,i))return!1}return!0},bo.prototype.toArray=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},bo.prototype.toString=function(){var e=[];return this.forEach(function(t){return e.push(t)}),"SortedSet("+e.toString()+")"},bo.prototype.copy=function(t){var e=new bo(this.comparator);return e.data=t,e},bo);function bo(t){this.comparator=t,this.data=new co(this.comparator)}var wo=(To.prototype.getNext=function(){return this.iter.getNext().key},To.prototype.hasNext=function(){return this.iter.hasNext()},To);function To(t){this.iter=t}var So=new co(Ki.comparator);function Eo(){return So}function Io(){return Eo()}var Co=new co(Ki.comparator);function Do(){return Co}var No=new co(Ki.comparator);function Ao(){return No}var ko=new vo(Ki.comparator);function Ro(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=ko,r=0,i=t;r<i.length;r++){var o=i[r];n=n.add(o)}return n}var Mo=new vo(vi);function Oo(){return Mo}var _o=(Lo.prototype.applyToRemoteDocument=function(t,e,n){e&&Fr(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.mutationResults;Fr(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];if(o.key.isEqual(t)){var a=r[i];e=o.applyToRemoteDocument(e,a)}}return e},Lo.prototype.applyToLocalView=function(t,e){e&&Fr(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=0,r=this.baseMutations;n<r.length;n++)(s=r[n]).key.isEqual(t)&&(e=s.applyToLocalView(e,e,this.localWriteTime));for(var i=e,o=0,a=this.mutations;o<a.length;o++){var s;(s=a[o]).key.isEqual(t)&&(e=s.applyToLocalView(e,i,this.localWriteTime))}return e},Lo.prototype.applyToLocalDocumentSet=function(n){var r=this,i=n;return this.mutations.forEach(function(t){var e=r.applyToLocalView(t.key,n.get(t.key));e&&(i=i.insert(t.key,e))}),i},Lo.prototype.keys=function(){return this.mutations.reduce(function(t,e){return t.add(e.key)},Ro())},Lo.prototype.isEqual=function(t){return this.batchId===t.batchId&&bi(this.mutations,t.mutations)&&bi(this.baseMutations,t.baseMutations)},Lo);function Lo(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,Fr(0<(this.mutations=r).length,"Cannot create an empty mutation batch")}var Po=(xo.from=function(t,e,n,r){Fr(t.mutations.length===n.length,"Mutations sent "+t.mutations.length+" must equal results received "+n.length);for(var i=Ao(),o=t.mutations,a=0;a<o.length;a++)i=i.insert(o[a].key,n[a].version);return new xo(t,e,n,r,i)},xo);function xo(t,e,n,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.streamToken=r,this.docVersions=i}var Fo=(qo.prototype.catch=function(t){return this.next(void 0,t)},qo.prototype.next=function(r,i){var o=this;return this.callbackAttached&&xr("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new qo(function(e,n){o.nextCallback=function(t){o.wrapSuccess(r,t).next(e,n)},o.catchCallback=function(t){o.wrapFailure(i,t).next(e,n)}})},qo.prototype.toPromise=function(){var n=this;return new Promise(function(t,e){n.next(t,e)})},qo.prototype.wrapUserFunction=function(t){try{var e=t();return e instanceof qo?e:qo.resolve(e)}catch(t){return qo.reject(t)}},qo.prototype.wrapSuccess=function(t,e){return t?this.wrapUserFunction(function(){return t(e)}):qo.resolve(e)},qo.prototype.wrapFailure=function(t,e){return t?this.wrapUserFunction(function(){return t(e)}):qo.reject(e)},qo.resolve=function(n){return new qo(function(t,e){t(n)})},qo.reject=function(n){return new qo(function(t,e){e(n)})},qo.waitFor=function(t){return new qo(function(e,n){var r=0,i=0,o=!1;t.forEach(function(t){++r,t.next(function(){++i,o&&i===r&&e()},function(t){return n(t)})}),o=!0,i===r&&e()})},qo.or=function(t){for(var n=qo.resolve(!1),e=function(e){n=n.next(function(t){return t?qo.resolve(t):e()})},r=0,i=t;r<i.length;r++)e(i[r]);return n},qo.forEach=function(t,n){var r=this,i=[];return t.forEach(function(t,e){i.push(n.call(r,t,e))}),this.waitFor(i)},qo);function qo(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)},function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)})}var Vo="SimpleDb",Bo=(Uo.openOrCreate=function(o,t,a){return Fr(Uo.isAvailable(),"IndexedDB not supported in current environment."),_r(Vo,"Opening database:",o),new Fo(function(n,r){var i;(i="undefined"!=typeof indexedDB?indexedDB.open(o,t):window.indexedDB.open(o,t)).onsuccess=function(t){var e=t.target.result;n(new Uo(e))},i.onblocked=function(){r(new Qr(Kr.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=function(t){var e=t.target.error;"VersionError"===e.name?r(new Qr(Kr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):r(e)},i.onupgradeneeded=function(t){_r(Vo,'Database "'+o+'" requires upgrade from version:',t.oldVersion);var e=t.target.result;a.createOrUpgrade(e,i.transaction,t.oldVersion,ou).next(function(){_r(Vo,"Database upgrade to version "+ou+" complete")})}}).toPromise()},Uo.delete=function(t){return _r(Vo,"Removing database:",t),Ho(window.indexedDB.deleteDatabase(t)).toPromise()},Uo.isAvailable=function(){if("undefined"!=typeof indexedDB)return!0;if("undefined"==typeof window||null==window.indexedDB)return!1;if(Uo.isMockPersistence())return!0;if(void 0===window.navigator)return!1;var t=u(),e=Uo.getIOSVersion(t),n=0<e&&e<10,r=Uo.getAndroidVersion(t),i=0<r&&r<4.5;return!(0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")||n||i)},Uo.isMockPersistence=function(){return"undefined"!=typeof process&&"YES"===process.env.USE_MOCK_PERSISTENCE},Uo.getStore=function(t,e){return t.store(e)},Uo.getIOSVersion=function(t){var e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)},Uo.getAndroidVersion=function(t){var e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)},Uo.prototype.setVersionChangeListener=function(e){this.db.onversionchange=function(t){return e(t)}},Uo.prototype.runTransaction=function(r,c,h){return d(this,void 0,void 0,function(){var o,a,s,e,u,n;return m(this,function(t){switch(t.label){case 0:o=r.startsWith("readonly"),a=r.endsWith("idempotent"),s=0,e=function(){var e,n,r,i;return m(this,function(t){switch(t.label){case 0:++s,e=jo.open(u.db,o?"readonly":"readwrite",c),t.label=1;case 1:return t.trys.push([1,3,,4]),(n=h(e).catch(function(t){return e.abort(t),Fo.reject(t)}).toPromise()).catch(function(){}),[4,e.completionPromise];case 2:return t.sent(),[2,{value:n}];case 3:return r=t.sent(),i=a&&"FirebaseError"!==r.name&&s<3,_r(Vo,"Transaction failed with error: %s. Retrying: %s.",r.message,i),i?[3,4]:[2,{value:Promise.reject(r)}];case 4:return[2]}})},u=this,t.label=1;case 1:return[5,e()];case 2:return"object"==typeof(n=t.sent())?[2,n.value]:[3,1];case 3:return[2]}})})},Uo.prototype.close=function(){this.db.close()},Uo);function Uo(t){this.db=t,12.2===Uo.getIOSVersion(u())&&Lr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}var Ko=(Object.defineProperty(Qo.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(Qo.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(Qo.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),Qo.prototype.done=function(){this.shouldStop=!0},Qo.prototype.skip=function(t){this.nextKey=t},Qo.prototype.delete=function(){return Ho(this.dbCursor.delete())},Qo);function Qo(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}var jo=(Wo.open=function(t,e,n){return new Wo(t.transaction(n,e))},Object.defineProperty(Wo.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),Wo.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(_r(Vo,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},Wo.prototype.store=function(t){var e=this.transaction.objectStore(t);return Fr(!!e,"Object store not part of transaction: "+t),new Go(e)},Wo);function Wo(t){var n=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new Gi,this.transaction.oncomplete=function(){n.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?n.completionDeferred.reject(t.error):n.completionDeferred.resolve()},this.transaction.onerror=function(t){var e=Xo(t.target.error);n.completionDeferred.reject(e)}}var Go=(zo.prototype.put=function(t,e){return Ho(void 0!==e?(_r(Vo,"PUT",this.store.name,t,e),this.store.put(e,t)):(_r(Vo,"PUT",this.store.name,"<auto-key>",t),this.store.put(t)))},zo.prototype.add=function(t){return _r(Vo,"ADD",this.store.name,t,t),Ho(this.store.add(t))},zo.prototype.get=function(e){var n=this;return Ho(this.store.get(e)).next(function(t){return void 0===t&&(t=null),_r(Vo,"GET",n.store.name,e,t),t})},zo.prototype.delete=function(t){return _r(Vo,"DELETE",this.store.name,t),Ho(this.store.delete(t))},zo.prototype.count=function(){return _r(Vo,"COUNT",this.store.name),Ho(this.store.count())},zo.prototype.loadAll=function(t,e){var n=this.cursor(this.options(t,e)),r=[];return this.iterateCursor(n,function(t,e){r.push(e)}).next(function(){return r})},zo.prototype.deleteAll=function(t,e){_r(Vo,"DELETE ALL",this.store.name);var n=this.options(t,e);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,function(t,e,n){return n.delete()})},zo.prototype.iterate=function(t,e){var n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.iterateCursor(r,e)},zo.prototype.iterateSerial=function(i){var t=this.cursor({});return new Fo(function(n,r){t.onerror=function(t){var e=Xo(t.target.error);r(e)},t.onsuccess=function(t){var e=t.target.result;e?i(e.primaryKey,e.value).next(function(t){t?e.continue():n()}):n()}})},zo.prototype.iterateCursor=function(t,a){var s=[];return new Fo(function(o,e){t.onerror=function(t){e(t.target.error)},t.onsuccess=function(t){var e=t.target.result;if(e){var n=new Ko(e),r=a(e.primaryKey,e.value,n);if(r instanceof Fo){var i=r.catch(function(t){return n.done(),Fo.reject(t)});s.push(i)}n.isDone?o():null===n.skipToKey?e.continue():e.continue(n.skipToKey)}else o()}}).next(function(){return Fo.waitFor(s)})},zo.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(Fr(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},zo.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.keysOnly?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},zo);function zo(t){this.store=t}function Ho(t){return new Fo(function(n,r){t.onsuccess=function(t){var e=t.target.result;n(e)},t.onerror=function(t){var e=Xo(t.target.error);r(e)}})}var Yo=!1;function Xo(t){var e=Bo.getIOSVersion(u());if(12.2<=e&&e<13){var n="An internal error was encountered in the Indexed Database server";if(0<=t.message.indexOf(n)){var r=new Qr("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+n+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return Yo||(Yo=!0,setTimeout(function(){throw r},0)),r}}return t}var Jo=(Zo.forUser=function(t,e,n,r){return Fr(""!==t.uid,"UserID must not be an empty string."),new Zo(t.isAuthenticated()?t.uid:"",e,n,r)},Zo.prototype.checkEmpty=function(t){var r=!0,e=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return na(t).iterate({index:du.userMutationsIndex,range:e},function(t,e,n){r=!1,n.done()}).next(function(){return r})},Zo.prototype.acknowledgeBatch=function(e,t,n){return this.getMutationQueueMetadata(e).next(function(t){return t.lastStreamToken=ea(n),ia(e).put(t)})},Zo.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next(function(t){return t.lastStreamToken})},Zo.prototype.setLastStreamToken=function(e,n){return this.getMutationQueueMetadata(e).next(function(t){return t.lastStreamToken=ea(n),ia(e).put(t)})},Zo.prototype.addMutationBatch=function(c,h,l,f){var d=this,p=ra(c),m=na(c);return m.add({}).next(function(t){Fr("number"==typeof t,"Auto-generated key is not a number");for(var e=new _o(t,h,l,f),n=d.serializer.toDbMutationBatch(d.userId,e),r=[],i=new vo(function(t,e){return vi(t.canonicalString(),e.canonicalString())}),o=0,a=f;o<a.length;o++){var s=a[o],u=mu.key(d.userId,s.key.path,t);i=i.add(s.key.path.popLast()),r.push(m.put(n)),r.push(p.put(u,mu.PLACEHOLDER))}return i.forEach(function(t){r.push(d.indexManager.addToCollectionParentIndex(c,t))}),c.addOnCommittedListener(function(){d.documentKeysByBatchId[t]=e.keys()}),Fo.waitFor(r).next(function(){return e})})},Zo.prototype.lookupMutationBatch=function(t,e){var n=this;return na(t).get(e).next(function(t){return t?(Fr(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.fromDbMutationBatch(t)):null})},Zo.prototype.lookupMutationKeys=function(t,n){var r=this;return this.documentKeysByBatchId[n]?Fo.resolve(this.documentKeysByBatchId[n]):this.lookupMutationBatch(t,n).next(function(t){if(t){var e=t.keys();return r.documentKeysByBatchId[n]=e}return null})},Zo.prototype.getNextMutationBatchAfterBatchId=function(t,e){var r=this,i=e+1,n=IDBKeyRange.lowerBound([this.userId,i]),o=null;return na(t).iterate({index:du.userMutationsIndex,range:n},function(t,e,n){e.userId===r.userId&&(Fr(e.batchId>=i,"Should have found mutation after "+i),o=r.serializer.fromDbMutationBatch(e)),n.done()}).next(function(){return o})},Zo.prototype.getHighestUnacknowledgedBatchId=function(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return na(t).iterate({index:du.userMutationsIndex,range:e,reverse:!0},function(t,e,n){r=e.batchId,n.done()}).next(function(){return r})},Zo.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return na(t).loadAll(du.userMutationsIndex,n).next(function(t){return t.map(function(t){return e.serializer.fromDbMutationBatch(t)})})},Zo.prototype.getAllMutationBatchesAffectingDocumentKey=function(s,u){var c=this,t=mu.prefixForPath(this.userId,u.path),e=IDBKeyRange.lowerBound(t),h=[];return ra(s).iterate({range:e},function(e,t,n){var r=e[0],i=e[1],o=e[2],a=io(i);if(r===c.userId&&u.path.isEqual(a))return na(s).get(o).next(function(t){if(!t)throw xr("Dangling document-mutation reference found: "+e+" which points to "+o);Fr(t.userId===c.userId,"Unexpected user '"+t.userId+"' for mutation batch "+o),h.push(c.serializer.fromDbMutationBatch(t))});n.done()}).next(function(){return h})},Zo.prototype.getAllMutationBatchesAffectingDocumentKeys=function(r,t){var u=this,c=new vo(vi),i=[];return t.forEach(function(s){var t=mu.prefixForPath(u.userId,s.path),e=IDBKeyRange.lowerBound(t),n=ra(r).iterate({range:e},function(t,e,n){var r=t[0],i=t[1],o=t[2],a=io(i);r===u.userId&&s.path.isEqual(a)?c=c.add(o):n.done()});i.push(n)}),Fo.waitFor(i).next(function(){return u.lookupMutationBatches(r,c)})},Zo.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var s=this;Fr(!e.isDocumentQuery(),"Document queries shouldn't go down this path"),Fr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var u=e.path,c=u.length+1,n=mu.prefixForPath(this.userId,u),r=IDBKeyRange.lowerBound(n),h=new vo(vi);return ra(t).iterate({range:r},function(t,e,n){var r=t[0],i=t[1],o=t[2],a=io(i);r===s.userId&&u.isPrefixOf(a)?a.length===c&&(h=h.add(o)):n.done()}).next(function(){return s.lookupMutationBatches(t,h)})},Zo.prototype.lookupMutationBatches=function(t,e){var n=this,r=[],i=[];return e.forEach(function(e){i.push(na(t).get(e).next(function(t){if(null===t)throw xr("Dangling document-mutation reference found, which points to "+e);Fr(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.fromDbMutationBatch(t))}))}),Fo.waitFor(i).next(function(){return r})},Zo.prototype.removeMutationBatch=function(e,n){var r=this;return ta(e.simpleDbTransaction,this.userId,n).next(function(t){return e.addOnCommittedListener(function(){r.removeCachedMutationKeys(n.batchId)}),Fo.forEach(t,function(t){return r.referenceDelegate.removeMutationReference(e,t)})})},Zo.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},Zo.prototype.performConsistencyCheck=function(n){var o=this;return this.checkEmpty(n).next(function(t){if(!t)return Fo.resolve();var e=IDBKeyRange.lowerBound(mu.prefixForUser(o.userId)),i=[];return ra(n).iterate({range:e},function(t,e,n){if(t[0]===o.userId){var r=io(t[1]);i.push(r)}else n.done()}).next(function(){Fr(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map(function(t){return t.canonicalString()}))})})},Zo.prototype.containsKey=function(t,e){return $o(t,this.userId,e)},Zo.prototype.getMutationQueueMetadata=function(t){var e=this;return ia(t).get(this.userId).next(function(t){return t||new lu(e.userId,-1,"")})},Zo);function Zo(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}function $o(t,o,e){var n=mu.prefixForPath(o,e.path),a=n[1],r=IDBKeyRange.lowerBound(n),s=!1;return ra(t).iterate({range:r,keysOnly:!0},function(t,e,n){var r=t[0],i=t[1];t[2];r===o&&i===a&&(s=!0),n.done()}).next(function(){return s})}function ta(t,e,n){var r=t.store(du.store),i=t.store(mu.store),o=[],a=IDBKeyRange.only(n.batchId),s=0,u=r.iterate({range:a},function(t,e,n){return s++,n.delete()});o.push(u.next(function(){Fr(1===s,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var c=[],h=0,l=n.mutations;h<l.length;h++){var f=l[h],d=mu.key(e,f.key.path,n.batchId);o.push(i.delete(d)),c.push(f.key)}return Fo.waitFor(o).next(function(){return c})}function ea(t){return t instanceof Uint8Array?(Fr(Bo.isMockPersistence(),"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function na(t){return uc.getStore(t,du.store)}function ra(t){return uc.getStore(t,mu.store)}function ia(t){return uc.getStore(t,lu.store)}var oa,aa;(aa=oa=oa||{})[aa.QueryCache=0]="QueryCache",aa[aa.SyncEngine=1]="SyncEngine";var sa=(ua.prototype.next=function(){var t=this.nextId;return this.nextId+=2,t},ua.prototype.after=function(t){return this.seek(t+2),this.next()},ua.prototype.seek=function(t){Fr((1&t)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},ua.forTargetCache=function(){return new ua(oa.QueryCache,2)},ua.forSyncEngine=function(){return new ua(oa.SyncEngine)},ua);function ua(t,e){Fr((1&(this.generatorId=t))===t,"Generator ID "+t+" contains more than 1 reserved bits"),this.seek(void 0!==e?e:this.generatorId)}var ca=(ha.prototype.allocateTargetId=function(e){var n=this;return this.retrieveMetadata(e).next(function(t){return t.highestTargetId=n.targetIdGenerator.after(t.highestTargetId),n.saveMetadata(e,t).next(function(){return t.highestTargetId})})},ha.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next(function(t){return so.fromTimestamp(new oo(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))})},ha.prototype.getHighestSequenceNumber=function(t){return da(t.simpleDbTransaction)},ha.prototype.setTargetsMetadata=function(e,n,r){var i=this;return this.retrieveMetadata(e).next(function(t){return t.highestListenSequenceNumber=n,r&&(t.lastRemoteSnapshotVersion=r.toTimestamp()),n>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=n),i.saveMetadata(e,t)})},ha.prototype.addTargetData=function(e,n){var r=this;return this.saveTargetData(e,n).next(function(){return r.retrieveMetadata(e).next(function(t){return t.targetCount+=1,r.updateMetadataFromTargetData(n,t),r.saveMetadata(e,t)})})},ha.prototype.updateTargetData=function(t,e){return this.saveTargetData(t,e)},ha.prototype.removeTargetData=function(e,t){var n=this;return this.removeMatchingKeysForTargetId(e,t.targetId).next(function(){return la(e).delete(t.targetId)}).next(function(){return n.retrieveMetadata(e)}).next(function(t){return Fr(0<t.targetCount,"Removing from an empty target cache"),t.targetCount-=1,n.saveMetadata(e,t)})},ha.prototype.removeTargets=function(r,i,o){var a=this,s=0,u=[];return la(r).iterate(function(t,e){var n=a.serializer.fromDbTarget(e);n.sequenceNumber<=i&&null===o.get(n.targetId)&&(s++,u.push(a.removeTargetData(r,n)))}).next(function(){return Fo.waitFor(u)}).next(function(){return s})},ha.prototype.forEachTarget=function(t,r){var i=this;return la(t).iterate(function(t,e){var n=i.serializer.fromDbTarget(e);r(n)})},ha.prototype.retrieveMetadata=function(t){return fa(t.simpleDbTransaction)},ha.prototype.saveMetadata=function(t,e){return function(t){return uc.getStore(t,Nu.store)}(t).put(Nu.key,e)},ha.prototype.saveTargetData=function(t,e){return la(t).put(this.serializer.toDbTarget(e))},ha.prototype.updateMetadataFromTargetData=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},ha.prototype.getTargetCount=function(t){return this.retrieveMetadata(t).next(function(t){return t.targetCount})},ha.prototype.getTargetData=function(t,i){var o=this,e=i.canonicalId(),n=IDBKeyRange.bound([e,Number.NEGATIVE_INFINITY],[e,Number.POSITIVE_INFINITY]),a=null;return la(t).iterate({range:n,index:Eu.queryTargetsIndexName},function(t,e,n){var r=o.serializer.fromDbTarget(e);i.isEqual(r.target)&&(a=r,n.done())}).next(function(){return a})},ha.prototype.addMatchingKeys=function(n,t,r){var i=this,o=[],a=pa(n);return t.forEach(function(t){var e=eo(t.path);o.push(a.put(new Cu(r,e))),o.push(i.referenceDelegate.addReference(n,t))}),Fo.waitFor(o)},ha.prototype.removeMatchingKeys=function(n,t,r){var i=this,o=pa(n);return Fo.forEach(t,function(t){var e=eo(t.path);return Fo.waitFor([o.delete([r,e]),i.referenceDelegate.removeReference(n,t)])})},ha.prototype.removeMatchingKeysForTargetId=function(t,e){var n=pa(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)},ha.prototype.getMatchingKeysForTargetId=function(t,e){var n=IDBKeyRange.bound([e],[e+1],!1,!0),r=pa(t),o=Ro();return r.iterate({range:n,keysOnly:!0},function(t,e,n){var r=io(t[1]),i=new Ki(r);o=o.add(i)}).next(function(){return o})},ha.prototype.containsKey=function(t,e){var n=eo(e.path),r=IDBKeyRange.bound([n],[wi(n)],!1,!0),i=0;return pa(t).iterate({index:Cu.documentTargetsIndex,keysOnly:!0,range:r},function(t,e,n){var r=t[0];t[1],0!==r&&(i++,n.done())}).next(function(){return 0<i})},ha.prototype.getTargetDataForTarget=function(t,e){var n=this;return la(t).get(e).next(function(t){return t?n.serializer.fromDbTarget(t):null})},ha);function ha(t,e){this.referenceDelegate=t,this.serializer=e,this.targetIdGenerator=sa.forTargetCache()}function la(t){return uc.getStore(t,Eu.store)}function fa(t){return Bo.getStore(t,Nu.store).get(Nu.key).next(function(t){return Fr(null!==t,"Missing metadata row."),t})}function da(t){return fa(t).next(function(t){return t.highestListenSequenceNumber})}function pa(t){return uc.getStore(t,Cu.store)}var ma=(ya.fromSet=function(t){return new ya(t)},ya.fromArray=function(t){var e=new vo(Bi.comparator);return t.forEach(function(t){return e=e.add(t)}),new ya(e)},ya.prototype.covers=function(e){var n=!1;return this.fields.forEach(function(t){t.isPrefixOf(e)&&(n=!0)}),n},ya.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},ya);function ya(t){this.fields=t}var ga=(va.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},va);function va(t,e){this.field=t,this.transform=e}var ba,wa,Ta=function(t,e){this.version=t,this.transformResults=e};(wa=ba=ba||{})[wa.Set=0]="Set",wa[wa.Patch=1]="Patch",wa[wa.Transform=2]="Transform",wa[wa.Delete=3]="Delete";var Sa=(Ea.exists=function(t){return new Ea(void 0,t)},Ea.updateTime=function(t){return new Ea(t)},Object.defineProperty(Ea.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),Ea.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof Ps&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof Ps:(Fr(this.isNone,"Precondition should be empty"),!0)},Ea.prototype.isEqual=function(t){return function(t,e){return null!=t?!(!e||!t.isEqual(e)):t===e}(this.updateTime,t.updateTime)&&this.exists===t.exists},Ea.NONE=new Ea,Ea);function Ea(t,e){this.updateTime=t,this.exists=e,Fr(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}var Ia=(Ca.prototype.verifyKeyMatches=function(t){null!=t&&Fr(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},Ca.getPostMutationVersion=function(t){return t instanceof Ps?t.version:so.MIN},Ca);function Ca(){}var Da,Na=(s(Aa,Da=Ia),Aa.prototype.applyToRemoteDocument=function(t,e){this.verifyKeyMatches(t),Fr(null==e.transformResults,"Transform results received by SetMutation.");var n=e.version;return new Ps(this.key,n,{hasCommittedMutations:!0},this.value)},Aa.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Ia.getPostMutationVersion(t);return new Ps(this.key,r,{hasLocalMutations:!0},this.value)},Aa.prototype.extractBaseValue=function(t){return null},Aa.prototype.isEqual=function(t){return t instanceof Aa&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},Aa);function Aa(t,e,n){var r=Da.call(this)||this;return r.key=t,r.value=e,r.precondition=n,r.type=ba.Set,r}var ka,Ra=(s(Ma,ka=Ia),Ma.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Fr(null==e.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new Us(this.key,e.version);var n=this.patchDocument(t);return new Ps(this.key,e.version,{hasCommittedMutations:!0},n)},Ma.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Ia.getPostMutationVersion(t),i=this.patchDocument(t);return new Ps(this.key,r,{hasLocalMutations:!0},i)},Ma.prototype.extractBaseValue=function(t){return null},Ma.prototype.isEqual=function(t){return t instanceof Ma&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},Ma.prototype.patchDocument=function(t){var e;return e=t instanceof Ps?t.data():Ns.EMPTY,this.patchObject(e)},Ma.prototype.patchObject=function(n){var r=this;return this.fieldMask.fields.forEach(function(t){if(!t.isEmpty()){var e=r.data.field(t);n=null!==e?n.set(t,e):n.delete(t)}}),n},Ma);function Ma(t,e,n,r){var i=ka.call(this)||this;return i.key=t,i.data=e,i.fieldMask=n,i.precondition=r,i.type=ba.Patch,i}var Oa,_a=(s(La,Oa=Ia),La.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Fr(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new Us(this.key,e.version);var n=this.requireDocument(t),r=this.serverTransformResults(t,e.transformResults),i=e.version,o=this.transformObject(n.data(),r);return new Ps(this.key,i,{hasCommittedMutations:!0},o)},La.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=this.requireDocument(t),i=this.localTransformResults(n,t,e),o=this.transformObject(r.data(),i);return new Ps(this.key,r.version,{hasLocalMutations:!0},o)},La.prototype.extractBaseValue=function(t){for(var e=null,n=0,r=this.fieldTransforms;n<r.length;n++){var i=r[n],o=t instanceof Ps?t.field(i.field):void 0,a=i.transform.computeBaseValue(o||null);null!=a&&(e=null==e?Ns.EMPTY.set(i.field,a):e.set(i.field,a))}return e},La.prototype.isEqual=function(t){return t instanceof La&&this.key.isEqual(t.key)&&bi(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},La.prototype.requireDocument=function(t){Fr(t instanceof Ps,"Unknown MaybeDocument type "+t);var e=t;return Fr(e.key.isEqual(this.key),"Can only transform a document with the same key"),e},La.prototype.serverTransformResults=function(t,e){var n=[];Fr(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;t instanceof Ps&&(a=t.field(i.field)),n.push(o.applyToRemoteDocument(a,e[r]))}return n},La.prototype.localTransformResults=function(t,e,n){for(var r=[],i=0,o=this.fieldTransforms;i<o.length;i++){var a=o[i],s=a.transform,u=null;e instanceof Ps&&(u=e.field(a.field)),null===u&&n instanceof Ps&&(u=n.field(a.field)),r.push(s.applyToLocalView(u,t))}return r},La.prototype.transformObject=function(t,e){Fr(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n].field;t=t.set(r,e[n])}return t},La);function La(t,e){var n=Oa.call(this)||this;return n.key=t,n.fieldTransforms=e,n.type=ba.Transform,n.precondition=Sa.exists(!0),n}var Pa,xa,Fa,qa,Va,Ba=(s(Ua,Pa=Ia),Ua.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),Fr(null==e.transformResults,"Transform results received by DeleteMutation."),new qs(this.key,e.version,{hasCommittedMutations:!0})},Ua.prototype.applyToLocalView=function(t,e,n){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&Fr(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new qs(this.key,so.forDeletedDoc())):t},Ua.prototype.extractBaseValue=function(t){return null},Ua.prototype.isEqual=function(t){return t instanceof Ua&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},Ua);function Ua(t,e){var n=Pa.call(this)||this;return n.key=t,n.precondition=e,n.type=ba.Delete,n}(Fa=xa=xa||{})[Fa.NullValue=0]="NullValue",Fa[Fa.BooleanValue=1]="BooleanValue",Fa[Fa.NumberValue=2]="NumberValue",Fa[Fa.TimestampValue=3]="TimestampValue",Fa[Fa.StringValue=4]="StringValue",Fa[Fa.BlobValue=5]="BlobValue",Fa[Fa.RefValue=6]="RefValue",Fa[Fa.GeoPointValue=7]="GeoPointValue",Fa[Fa.ArrayValue=8]="ArrayValue",Fa[Fa.ObjectValue=9]="ObjectValue",(Va=qa=qa||{})[Va.Default=0]="Default",Va[Va.Estimate=1]="Estimate",Va[Va.Previous=2]="Previous";var Ka=(Qa.fromSnapshotOptions=function(t,e){switch(t.serverTimestamps){case"estimate":return new Qa(qa.Estimate,e);case"previous":return new Qa(qa.Previous,e);case"none":case void 0:return new Qa(qa.Default,e);default:return xr("fromSnapshotOptions() called with invalid options.")}},Qa);function Qa(t,e){this.serverTimestampBehavior=t,this.timestampsInSnapshots=e}var ja=(Wa.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},Wa.prototype.defaultCompareTo=function(t){return Fr(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type."),vi(this.typeOrder,t.typeOrder)},Wa);function Wa(){}var Ga,za=(s(Ha,Ga=ja),Ha.prototype.value=function(t){return null},Ha.prototype.isEqual=function(t){return t instanceof Ha},Ha.prototype.compareTo=function(t){return t instanceof Ha?0:this.defaultCompareTo(t)},Ha.INSTANCE=new Ha,Ha);function Ha(){var t=Ga.call(this)||this;return t.typeOrder=xa.NullValue,t.internalValue=null,t}var Ya,Xa=(s(Ja,Ya=ja),Ja.prototype.value=function(t){return this.internalValue},Ja.prototype.isEqual=function(t){return t instanceof Ja&&this.internalValue===t.internalValue},Ja.prototype.compareTo=function(t){return t instanceof Ja?vi(this,t):this.defaultCompareTo(t)},Ja.of=function(t){return t?Ja.TRUE:Ja.FALSE},Ja.TRUE=new Ja(!0),Ja.FALSE=new Ja(!1),Ja);function Ja(t){var e=Ya.call(this)||this;return e.internalValue=t,e.typeOrder=xa.BooleanValue,e}var Za,$a=(s(ts,Za=ja),ts.prototype.value=function(t){return this.internalValue},ts.prototype.compareTo=function(t){return t instanceof ts?function(t,e){return t<e?-1:e<t?1:t===e?0:isNaN(t)?isNaN(e)?0:-1:1}(this.internalValue,t.internalValue):this.defaultCompareTo(t)},ts);function ts(t){var e=Za.call(this)||this;return e.internalValue=t,e.typeOrder=xa.NumberValue,e}function es(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}var ns,rs=(s(is,ns=$a),is.prototype.isEqual=function(t){return t instanceof is&&es(this.internalValue,t.internalValue)},is);function is(){return null!==ns&&ns.apply(this,arguments)||this}var os,as=(s(ss,os=$a),ss.prototype.isEqual=function(t){return t instanceof ss&&es(this.internalValue,t.internalValue)},ss.NAN=new ss(NaN),ss.POSITIVE_INFINITY=new ss(1/0),ss.NEGATIVE_INFINITY=new ss(-1/0),ss);function ss(){return null!==os&&os.apply(this,arguments)||this}var us,cs=(s(hs,us=ja),hs.prototype.value=function(t){return this.internalValue},hs.prototype.isEqual=function(t){return t instanceof hs&&this.internalValue===t.internalValue},hs.prototype.compareTo=function(t){return t instanceof hs?vi(this.internalValue,t.internalValue):this.defaultCompareTo(t)},hs);function hs(t){var e=us.call(this)||this;return e.internalValue=t,e.typeOrder=xa.StringValue,e}var ls,fs=(s(ds,ls=ja),ds.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},ds.prototype.isEqual=function(t){return t instanceof ds&&this.internalValue.isEqual(t.internalValue)},ds.prototype.compareTo=function(t){return t instanceof ds?this.internalValue._compareTo(t.internalValue):t instanceof ms?-1:this.defaultCompareTo(t)},ds);function ds(t){var e=ls.call(this)||this;return e.internalValue=t,e.typeOrder=xa.TimestampValue,e}var ps,ms=(s(ys,ps=ja),ys.prototype.value=function(t){return t&&t.serverTimestampBehavior===qa.Estimate?new fs(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===qa.Previous&&this.previousValue?this.previousValue.value(t):null},ys.prototype.isEqual=function(t){return t instanceof ys&&this.localWriteTime.isEqual(t.localWriteTime)},ys.prototype.compareTo=function(t){return t instanceof ys?this.localWriteTime._compareTo(t.localWriteTime):t instanceof fs?1:this.defaultCompareTo(t)},ys.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},ys);function ys(t,e){var n=ps.call(this)||this;return n.localWriteTime=t,n.previousValue=e,n.typeOrder=xa.TimestampValue,n}var gs,vs=(s(bs,gs=ja),bs.prototype.value=function(t){return this.internalValue},bs.prototype.isEqual=function(t){return t instanceof bs&&this.internalValue.isEqual(t.internalValue)},bs.prototype.compareTo=function(t){return t instanceof bs?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},bs);function bs(t){var e=gs.call(this)||this;return e.internalValue=t,e.typeOrder=xa.BlobValue,e}var ws,Ts=(s(Ss,ws=ja),Ss.prototype.value=function(t){return this.key},Ss.prototype.isEqual=function(t){return t instanceof Ss&&this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId)},Ss.prototype.compareTo=function(t){if(t instanceof Ss){var e=this.databaseId.compareTo(t.databaseId);return 0!==e?e:Ki.comparator(this.key,t.key)}return this.defaultCompareTo(t)},Ss);function Ss(t,e){var n=ws.call(this)||this;return n.databaseId=t,n.key=e,n.typeOrder=xa.RefValue,n}var Es,Is=(s(Cs,Es=ja),Cs.prototype.value=function(t){return this.internalValue},Cs.prototype.isEqual=function(t){return t instanceof Cs&&this.internalValue.isEqual(t.internalValue)},Cs.prototype.compareTo=function(t){return t instanceof Cs?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},Cs);function Cs(t){var e=Es.call(this)||this;return e.internalValue=t,e.typeOrder=xa.GeoPointValue,e}var Ds,Ns=(s(As,Ds=ja),As.prototype.value=function(n){var r={};return this.internalValue.inorderTraversal(function(t,e){r[t]=e.value(n)}),r},As.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},As.prototype.isEqual=function(t){if(t instanceof As){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext();if(r.key!==i.key||!r.value.isEqual(i.value))return!1}return!e.hasNext()&&!n.hasNext()}return!1},As.prototype.compareTo=function(t){if(t instanceof As){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext(),o=vi(r.key,i.key)||r.value.compareTo(i.value);if(o)return o}return vi(e.hasNext(),n.hasNext())}return this.defaultCompareTo(t)},As.prototype.set=function(t,e){if(Fr(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),e);var n=this.child(t.firstSegment());n instanceof As||(n=As.EMPTY);var r=n.set(t.popFirst(),e);return this.setChild(t.firstSegment(),r)},As.prototype.delete=function(t){if(Fr(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new As(this.internalValue.remove(t.firstSegment()));var e=this.child(t.firstSegment());if(e instanceof As){var n=e.delete(t.popFirst());return new As(this.internalValue.insert(t.firstSegment(),n))}return this},As.prototype.contains=function(t){return null!==this.field(t)},As.prototype.field=function(t){Fr(!t.isEmpty(),"Can't get field of empty path");var e=this;return t.forEach(function(t){e=e instanceof As?e.internalValue.get(t):null}),e},As.prototype.fieldMask=function(){var i=new vo(Bi.comparator);return this.internalValue.forEach(function(t,e){var n=new Bi([t]);if(e instanceof As){var r=e.fieldMask().fields;r.isEmpty()?i=i.add(n):r.forEach(function(t){i=i.add(n.child(t))})}else i=i.add(n)}),ma.fromSet(i)},As.prototype.toString=function(){return this.internalValue.toString()},As.prototype.child=function(t){return this.internalValue.get(t)||void 0},As.prototype.setChild=function(t,e){return new As(this.internalValue.insert(t,e))},As.EMPTY=new As(new co(vi)),As);function As(t){var e=Ds.call(this)||this;return e.internalValue=t,e.typeOrder=xa.ObjectValue,e}var ks,Rs=(s(Ms,ks=ja),Ms.prototype.value=function(e){return this.internalValue.map(function(t){return t.value(e)})},Ms.prototype.contains=function(t){for(var e=0,n=this.internalValue;e<n.length;e++)if(n[e].isEqual(t))return!0;return!1},Ms.prototype.forEach=function(t){this.internalValue.forEach(t)},Ms.prototype.isEqual=function(t){if(t instanceof Ms){if(this.internalValue.length!==t.internalValue.length)return!1;for(var e=0;e<this.internalValue.length;e++)if(!this.internalValue[e].isEqual(t.internalValue[e]))return!1;return!0}return!1},Ms.prototype.compareTo=function(t){if(t instanceof Ms){for(var e=Math.min(this.internalValue.length,t.internalValue.length),n=0;n<e;n++){var r=this.internalValue[n].compareTo(t.internalValue[n]);if(r)return r}return vi(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},Ms.prototype.toString=function(){return"["+this.internalValue.map(function(t){return t.toString()}).join(",")+"]"},Ms);function Ms(t){var e=ks.call(this)||this;return e.internalValue=t,e.typeOrder=xa.ArrayValue,e}var Os=(_s.compareByKey=function(t,e){return Ki.comparator(t.key,e.key)},_s);function _s(t,e){this.key=t,this.version=e}var Ls,Ps=(s(xs,Ls=Os),xs.prototype.field=function(t){if(this.objectValue)return this.objectValue.field(t);this.fieldValueCache||(this.fieldValueCache=new Map);var e=t.canonicalString(),n=this.fieldValueCache.get(e);if(void 0===n){var r=this.getProtoField(t);n=void 0===r?null:this.converter(r),this.fieldValueCache.set(e,n)}return n},xs.prototype.data=function(){var n=this;if(!this.objectValue){var r=Ns.EMPTY;Yr(this.proto.fields||{},function(t,e){r=r.set(new Bi([t]),n.converter(e))}),this.objectValue=r,this.fieldValueCache=void 0}return this.objectValue},xs.prototype.value=function(){return this.data().value()},xs.prototype.isEqual=function(t){return t instanceof xs&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations&&this.data().isEqual(t.data())},xs.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data().toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(xs.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),xs.prototype.getProtoField=function(t){Fr(void 0!==this.proto,"Can only call getProtoField() when proto is defined");for(var e=this.proto.fields?this.proto.fields[t.firstSegment()]:void 0,n=1;n<t.length;++n){if(!e||!e.mapValue||!e.mapValue.fields)return;e=e.mapValue.fields[t.get(n)]}return e},xs.compareByField=function(t,e,n){var r=e.field(t),i=n.field(t);return null!==r&&null!==i?r.compareTo(i):xr("Trying to compare documents on fields that don't exist")},xs);function xs(t,e,n,r,i,o){var a=Ls.call(this,t,e)||this;return a.objectValue=r,a.proto=i,a.converter=o,Fr(void 0!==a.objectValue||void 0!==a.proto&&void 0!==a.converter,"If objectValue is not defined, proto and converter need to be set."),a.hasLocalMutations=!!n.hasLocalMutations,a.hasCommittedMutations=!!n.hasCommittedMutations,a}var Fs,qs=(s(Vs,Fs=Os),Vs.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(Vs.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),Vs.prototype.isEqual=function(t){return t instanceof Vs&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},Vs);function Vs(t,e,n){var r=Fs.call(this,t,e)||this;return r.hasCommittedMutations=!(!n||!n.hasCommittedMutations),r}var Bs,Us=(s(Ks,Bs=Os),Ks.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(Ks.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),Ks.prototype.isEqual=function(t){return t instanceof Ks&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},Ks);function Ks(){return null!==Bs&&Bs.apply(this,arguments)||this}var Qs=(js.prototype.get=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];if(a.isEqual(t))return s}},js.prototype.has=function(t){return void 0!==this.get(t)},js.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},js.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},js.prototype.forEach=function(s){Yr(this.inner,function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n],o=i[0],a=i[1];s(o,a)}})},js.prototype.isEmpty=function(){return Xr(this.inner)},js);function js(t){this.mapKeyFn=t,this.inner={}}var Ws=(Object.defineProperty(Gs.prototype,"readTime",{get:function(){return Fr(void 0!==this._readTime,"Read time is not set. All removeEntry() calls must include a readTime if `trackRemovals` is used."),this._readTime},set:function(t){Fr(void 0===this._readTime||this._readTime.isEqual(t),"All changes in a RemoteDocumentChangeBuffer must have the same read time"),this._readTime=t},enumerable:!0,configurable:!0}),Gs.prototype.addEntry=function(t,e){this.assertNotApplied(),this.readTime=e,this.changes.set(t.key,t)},Gs.prototype.removeEntry=function(t,e){this.assertNotApplied(),e&&(this.readTime=e),this.changes.set(t,null)},Gs.prototype.getEntry=function(t,e){this.assertNotApplied();var n=this.changes.get(e);return void 0!==n?Fo.resolve(n):this.getFromCache(t,e)},Gs.prototype.getEntries=function(t,e){return this.getAllFromCache(t,e)},Gs.prototype.apply=function(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)},Gs.prototype.assertNotApplied=function(){Fr(!this.changesApplied,"Changes have already been applied.")},Gs);function Gs(){this.changes=new Qs(function(t){return t.toString()}),this.changesApplied=!1}var zs,Hs=(Ys.prototype.addEntry=function(t,e,n){return Zs(t).put($s(e),n)},Ys.prototype.removeEntry=function(t,e){var n=Zs(t),r=$s(e);return n.delete(r)},Ys.prototype.updateMetadata=function(e,n){var r=this;return this.getMetadata(e).next(function(t){return t.byteSize+=n,r.setMetadata(e,t)})},Ys.prototype.getEntry=function(t,e){var n=this;return Zs(t).get($s(e)).next(function(t){return n.maybeDecodeDocument(t)})},Ys.prototype.getSizedEntry=function(t,e){var n=this;return Zs(t).get($s(e)).next(function(t){var e=n.maybeDecodeDocument(t);return e?{maybeDocument:e,size:tu(t)}:null})},Ys.prototype.getEntries=function(t,e){var r=this,i=Io();return this.forEachDbEntry(t,e,function(t,e){var n=r.maybeDecodeDocument(e);i=i.insert(t,n)}).next(function(){return i})},Ys.prototype.getSizedEntries=function(t,e){var r=this,i=Io(),o=new co(Ki.comparator);return this.forEachDbEntry(t,e,function(t,e){var n=r.maybeDecodeDocument(e);o=n?(i=i.insert(t,n),o.insert(t,tu(e))):(i=i.insert(t,null),o.insert(t,0))}).next(function(){return{maybeDocuments:i,sizeMap:o}})},Ys.prototype.forEachDbEntry=function(t,e,i){if(e.isEmpty())return Fo.resolve();var n=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),o=e.getIterator(),a=o.getNext();return Zs(t).iterate({range:n},function(t,e,n){for(var r=Ki.fromSegments(t);a&&Ki.comparator(a,r)<0;)i(a,null),a=o.getNext();a&&a.isEqual(r)&&(i(a,e),a=o.hasNext()?o.getNext():null),a?n.skip(a.path.toArray()):n.done()}).next(function(){for(;a;)i(a,null),a=o.hasNext()?o.getNext():null})},Ys.prototype.getDocumentsMatchingQuery=function(t,i,e){var o=this;Fr(!i.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var a=Do(),s=i.path.length+1,n={};if(e.isEqual(so.MIN)){var r=i.path.toArray();n.range=IDBKeyRange.lowerBound(r)}else{var u=i.path.toArray(),c=this.serializer.toDbTimestampKey(e);n.range=IDBKeyRange.lowerBound([u,c],!0),n.index=bu.collectionReadTimeIndex}return Zs(t).iterate(n,function(t,e,n){if(t.length===s){var r=o.serializer.fromDbRemoteDocument(e);i.path.isPrefixOf(r.key.path)?r instanceof Ps&&i.matches(r)&&(a=a.insert(r.key,r)):n.done()}}).next(function(){return a})},Ys.prototype.getNewDocumentChanges=function(t,e){var r=this,i=Eo(),o=this.serializer.toDbTimestampKey(e),n=Zs(t),a=IDBKeyRange.lowerBound(o,!0);return n.iterate({index:bu.readTimeIndex,range:a},function(t,e){var n=r.serializer.fromDbRemoteDocument(e);i=i.insert(n.key,n),o=e.readTime}).next(function(){return{changedDocs:i,readTime:r.serializer.fromDbTimestampKey(o)}})},Ys.prototype.getLastDocumentChange=function(t){var r,i=this,e=Zs(t),o=so.MIN;return e.iterate({index:bu.readTimeIndex,reverse:!0},function(t,e,n){r=i.serializer.fromDbRemoteDocument(e),e.readTime&&(o=i.serializer.fromDbTimestampKey(e.readTime)),n.done()}).next(function(){return{changedDoc:r,readTime:o}})},Ys.prototype.newChangeBuffer=function(t){return new Ys.RemoteDocumentChangeBuffer(this,!!t&&t.trackRemovals)},Ys.prototype.getSize=function(t){return this.getMetadata(t).next(function(t){return t.byteSize})},Ys.prototype.getMetadata=function(t){return Js(t).get(Tu.key).next(function(t){return Fr(!!t,"Missing document cache metadata"),t})},Ys.prototype.setMetadata=function(t,e){return Js(t).put(Tu.key,e)},Ys.prototype.maybeDecodeDocument=function(t){if(t){var e=this.serializer.fromDbRemoteDocument(t);return e instanceof qs&&e.version.isEqual(so.forDeletedDoc())?null:e}return null},Ys.RemoteDocumentChangeBuffer=(s(Xs,zs=Ws),Xs.prototype.applyChanges=function(a){var s=this,u=[],c=0,h=new vo(function(t,e){return vi(t.canonicalString(),e.canonicalString())});return this.changes.forEach(function(t,e){var n=s.documentSizes.get(t);if(Fr(void 0!==n,"Cannot modify a document that wasn't read (for "+t+")"),e){Fr(!s.readTime.isEqual(so.MIN),"Cannot add a document with a read time of zero");var r=s.documentCache.serializer.toDbRemoteDocument(e,s.readTime);h=h.add(t.path.popLast());var i=tu(r);c+=i-n,u.push(s.documentCache.addEntry(a,t,r))}else if(c-=n,s.trackRemovals){var o=s.documentCache.serializer.toDbRemoteDocument(new qs(t,so.forDeletedDoc()),s.readTime);u.push(s.documentCache.addEntry(a,t,o))}else u.push(s.documentCache.removeEntry(a,t))}),h.forEach(function(t){u.push(s.documentCache.indexManager.addToCollectionParentIndex(a,t))}),u.push(this.documentCache.updateMetadata(a,c)),Fo.waitFor(u)},Xs.prototype.getFromCache=function(t,e){var n=this;return this.documentCache.getSizedEntry(t,e).next(function(t){return null===t?(n.documentSizes.set(e,0),null):(n.documentSizes.set(e,t.size),t.maybeDocument)})},Xs.prototype.getAllFromCache=function(t,e){var n=this;return this.documentCache.getSizedEntries(t,e).next(function(t){var e=t.maybeDocuments;return t.sizeMap.forEach(function(t,e){n.documentSizes.set(t,e)}),e})},Xs),Ys);function Ys(t,e){this.serializer=t,this.indexManager=e}function Xs(t,e){var n=zs.call(this)||this;return n.documentCache=t,n.trackRemovals=e,n.documentSizes=new Qs(function(t){return t.toString()}),n}function Js(t){return uc.getStore(t,Tu.store)}function Zs(t){return uc.getStore(t,bu.store)}function $s(t){return t.path.toArray()}function tu(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw xr("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}var eu=(nu.prototype.addToCollectionParentIndex=function(t,e){return this.collectionParentIndex.add(e),Fo.resolve()},nu.prototype.getCollectionParents=function(t,e){return Fo.resolve(this.collectionParentIndex.getEntries(e))},nu);function nu(){this.collectionParentIndex=new ru}var ru=(iu.prototype.add=function(t){Fr(t.length%2==1,"Expected a collection path.");var e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new vo(xi.comparator),i=!r.has(n);return this.index[e]=r.add(n),i},iu.prototype.has=function(t){var e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)},iu.prototype.getEntries=function(t){return(this.index[t]||new vo(xi.comparator)).toArray()},iu);function iu(){this.index={}}var ou=9,au=(su.prototype.createOrUpgrade=function(t,e,n,r){var i=this;Fr(n<r&&0<=n&&r<=ou,"Unexpected schema upgrade from v"+n+" to v{toVersion}.");var o=new jo(e);n<1&&1<=r&&(function(t){t.createObjectStore(cu.store)}(t),function(t){t.createObjectStore(lu.store,{keyPath:lu.keyPath}),t.createObjectStore(du.store,{keyPath:du.keyPath,autoIncrement:!0}).createIndex(du.userMutationsIndex,du.userMutationsKeyPath,{unique:!0}),t.createObjectStore(mu.store)}(t),Mu(t),function(t){t.createObjectStore(bu.store)}(t));var a=Fo.resolve();return n<3&&3<=r&&(0!==n&&(function(t){t.deleteObjectStore(Cu.store),t.deleteObjectStore(Eu.store),t.deleteObjectStore(Nu.store)}(t),Mu(t)),a=a.next(function(){return function(t){var e=t.store(Nu.store),n=new Nu(0,0,so.MIN.toTimestamp(),0);return e.put(Nu.key,n)}(o)})),n<4&&4<=r&&(0!==n&&(a=a.next(function(){return function(r,i){return i.store(du.store).loadAll().next(function(t){r.deleteObjectStore(du.store),r.createObjectStore(du.store,{keyPath:du.keyPath,autoIncrement:!0}).createIndex(du.userMutationsIndex,du.userMutationsKeyPath,{unique:!0});var e=i.store(du.store),n=t.map(function(t){return e.put(t)});return Fo.waitFor(n)})}(t,o)})),a=a.next(function(){!function(t){t.createObjectStore(Ou.store,{keyPath:Ou.keyPath})}(t)})),n<5&&5<=r&&(a=a.next(function(){return i.removeAcknowledgedMutations(o)})),n<6&&6<=r&&(a=a.next(function(){return function(t){t.createObjectStore(Tu.store)}(t),i.addDocumentGlobal(o)})),n<7&&7<=r&&(a=a.next(function(){return i.ensureSequenceNumbers(o)})),n<8&&8<=r&&(a=a.next(function(){return i.createCollectionParentIndex(t,o)})),n<9&&9<=r&&(a=a.next(function(){!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){var e=t.objectStore(bu.store);e.createIndex(bu.readTimeIndex,bu.readTimeIndexPath,{unique:!1}),e.createIndex(bu.collectionReadTimeIndex,bu.collectionReadTimeIndexPath,{unique:!1})}(e)})),a},su.prototype.addDocumentGlobal=function(e){var n=0;return e.store(bu.store).iterate(function(t,e){n+=tu(e)}).next(function(){var t=new Tu(n);return e.store(Tu.store).put(Tu.key,t)})},su.prototype.removeAcknowledgedMutations=function(r){var i=this,t=r.store(lu.store),e=r.store(du.store);return t.loadAll().next(function(t){return Fo.forEach(t,function(n){var t=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return e.loadAll(du.userMutationsIndex,t).next(function(t){return Fo.forEach(t,function(t){Fr(t.userId===n.userId,"Cannot process batch "+t.batchId+" from unexpected user");var e=i.serializer.fromDbMutationBatch(t);return ta(r,n.userId,e).next(function(){})})})})})},su.prototype.ensureSequenceNumbers=function(t){var a=t.store(Cu.store),e=t.store(bu.store);return da(t).next(function(i){var o=[];return e.iterate(function(t,e){var n=new xi(t),r=function(t){return[0,eo(t)]}(n);o.push(a.get(r).next(function(t){return t?Fo.resolve():function(t){return a.put(new Cu(0,eo(t),i))}(n)}))}).next(function(){return Fo.waitFor(o)})})},su.prototype.createCollectionParentIndex=function(t,e){function i(t){if(o.add(t)){var e=t.lastSegment(),n=t.popLast();return r.put({collectionId:e,parent:eo(n)})}}t.createObjectStore(ku.store,{keyPath:ku.keyPath});var r=e.store(ku.store),o=new ru;return e.store(bu.store).iterate({keysOnly:!0},function(t,e){var n=new xi(t);return i(n.popLast())}).next(function(){return e.store(mu.store).iterate({keysOnly:!0},function(t,e){t[0];var n=t[1],r=(t[2],io(n));return i(r.popLast())})})},su);function su(t){this.serializer=t}var uu=function(t,e){this.seconds=t,this.nanoseconds=e},cu=(hu.store="owner",hu.key="owner",hu);function hu(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}var lu=(fu.store="mutationQueues",fu.keyPath="userId",fu);function fu(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}var du=(pu.store="mutations",pu.keyPath="batchId",pu.userMutationsIndex="userMutationsIndex",pu.userMutationsKeyPath=["userId","batchId"],pu);function pu(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}var mu=(yu.prefixForUser=function(t){return[t]},yu.prefixForPath=function(t,e){return[t,eo(e)]},yu.key=function(t,e,n){return[t,eo(e),n]},yu.store="documentMutations",yu.PLACEHOLDER=new yu,yu);function yu(){}var gu=function(t,e){this.path=t,this.readTime=e},vu=function(t,e){this.path=t,this.version=e},bu=(wu.store="remoteDocuments",wu.readTimeIndex="readTimeIndex",wu.readTimeIndexPath="readTime",wu.collectionReadTimeIndex="collectionReadTimeIndex",wu.collectionReadTimeIndexPath=["parentPath","readTime"],wu);function wu(t,e,n,r,i,o){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=i,this.parentPath=o}var Tu=(Su.store="remoteDocumentGlobal",Su.key="remoteDocumentGlobalKey",Su);function Su(t){this.byteSize=t}var Eu=(Iu.store="targets",Iu.keyPath="targetId",Iu.queryTargetsIndexName="queryTargetsIndex",Iu.queryTargetsKeyPath=["canonicalId","targetId"],Iu);function Iu(t,e,n,r,i,o,a){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.lastLimboFreeSnapshotVersion=o,this.query=a}var Cu=(Du.store="targetDocuments",Du.keyPath=["targetId","path"],Du.documentTargetsIndex="documentTargetsIndex",Du.documentTargetsKeyPath=["path","targetId"],Du);function Du(t,e,n){this.targetId=t,this.path=e,Fr(0===t==(void 0!==(this.sequenceNumber=n)),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}var Nu=(Au.key="targetGlobalKey",Au.store="targetGlobal",Au);function Au(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}var ku=(Ru.store="collectionParents",Ru.keyPath=["collectionId","parent"],Ru);function Ru(t,e){this.collectionId=t,this.parent=e}function Mu(t){t.createObjectStore(Cu.store,{keyPath:Cu.keyPath}).createIndex(Cu.documentTargetsIndex,Cu.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Eu.store,{keyPath:Eu.keyPath}).createIndex(Eu.queryTargetsIndexName,Eu.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Nu.store)}var Ou=(_u.store="clientMetadata",_u.keyPath="clientId",_u);function _u(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}var Lu,Pu,xu=[lu.store,du.store,mu.store,bu.store,Eu.store,cu.store,Nu.store,Cu.store].concat([Ou.store]).concat([Tu.store]).concat([ku.store]),Fu=(qu.prototype.addToCollectionParentIndex=function(t,e){var n=this;if(Fr(e.length%2==1,"Expected a collection path."),this.collectionParentsCache.has(e))return Fo.resolve();var r=e.lastSegment(),i=e.popLast();return t.addOnCommittedListener(function(){n.collectionParentsCache.add(e)}),Vu(t).put({collectionId:r,parent:eo(i)})},qu.prototype.getCollectionParents=function(t,i){var o=[],e=IDBKeyRange.bound([i,""],[wi(i),""],!1,!0);return Vu(t).loadAll(e).next(function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];if(r.collectionId!==i)break;o.push(io(r.parent))}return o})},qu);function qu(){this.collectionParentsCache=new ru}function Vu(t){return uc.getStore(t,ku.store)}(Pu=Lu=Lu||{})[Pu.Listen=0]="Listen",Pu[Pu.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",Pu[Pu.LimboResolution=2]="LimboResolution";var Bu=(Uu.prototype.withSequenceNumber=function(t){return new Uu(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)},Uu.prototype.withResumeToken=function(t,e){return new Uu(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)},Uu.prototype.withLastLimboFreeSnapshotVersion=function(t){return new Uu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)},Uu.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.lastLimboFreeSnapshotVersion.isEqual(t.lastLimboFreeSnapshotVersion)&&this.resumeToken===t.resumeToken&&this.target.isEqual(t.target)},Uu);function Uu(t,e,n,r,i,o,a){void 0===i&&(i=so.MIN),void 0===o&&(o=so.MIN),void 0===a&&(a=Br()),this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a}var Ku=(Qu.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=Ki.fromSegments(t.noDocument.path),n=this.fromDbTimestamp(t.noDocument.readTime);return new qs(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}return t.unknownDocument?(e=Ki.fromSegments(t.unknownDocument.path),n=this.fromDbTimestamp(t.unknownDocument.version),new Us(e,n)):xr("Unexpected DbRemoteDocument")},Qu.prototype.toDbRemoteDocument=function(t,e){var n=this.toDbTimestampKey(e),r=t.key.path.popLast().toArray();if(t instanceof Ps){var i=t.proto?t.proto:this.remoteSerializer.toDocument(t),o=t.hasCommittedMutations;return new bu(null,null,i,o,n,r)}if(t instanceof qs){var a=t.key.path.toArray(),s=this.toDbTimestamp(t.version);return o=t.hasCommittedMutations,new bu(null,new gu(a,s),null,o,n,r)}if(t instanceof Us){a=t.key.path.toArray();var u=this.toDbTimestamp(t.version);return new bu(new vu(a,u),null,null,!0,n,r)}return xr("Unexpected MaybeDocument")},Qu.prototype.toDbTimestampKey=function(t){var e=t.toTimestamp();return[e.seconds,e.nanoseconds]},Qu.prototype.fromDbTimestampKey=function(t){var e=new oo(t[0],t[1]);return so.fromTimestamp(e)},Qu.prototype.toDbTimestamp=function(t){var e=t.toTimestamp();return new uu(e.seconds,e.nanoseconds)},Qu.prototype.fromDbTimestamp=function(t){var e=new oo(t.seconds,t.nanoseconds);return so.fromTimestamp(e)},Qu.prototype.toDbMutationBatch=function(t,e){var n=this,r=e.baseMutations.map(function(t){return n.remoteSerializer.toMutation(t)}),i=e.mutations.map(function(t){return n.remoteSerializer.toMutation(t)});return new du(t,e.batchId,e.localWriteTime.toMillis(),r,i)},Qu.prototype.fromDbMutationBatch=function(t){var e=this,n=(t.baseMutations||[]).map(function(t){return e.remoteSerializer.fromMutation(t)}),r=t.mutations.map(function(t){return e.remoteSerializer.fromMutation(t)}),i=oo.fromMillis(t.localWriteTimeMs);return new _o(t.batchId,i,n,r)},Qu.prototype.toDbResourcePaths=function(t){var e=[];return t.forEach(function(t){e.push(eo(t.path))}),e},Qu.prototype.fromDbResourcePaths=function(t){for(var e=Ro(),n=0,r=t;n<r.length;n++){var i=r[n];e=e.add(new Ki(io(i)))}return e},Qu.prototype.fromDbTarget=function(t){var e,n=this.fromDbTimestamp(t.readTime),r=void 0!==t.lastLimboFreeSnapshotVersion?this.fromDbTimestamp(t.lastLimboFreeSnapshotVersion):so.MIN,i=t.resumeToken;return e=function(t){return void 0!==t.documents}(t.query)?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query),new Bu(e,t.targetId,Lu.Listen,t.lastListenSequenceNumber,n,r,i)},Qu.prototype.toDbTarget=function(t){Fr(Lu.Listen===t.purpose,"Only queries with purpose "+Lu.Listen+" may be stored, got "+t.purpose);var e,n,r=this.toDbTimestamp(t.snapshotVersion),i=this.toDbTimestamp(t.lastLimboFreeSnapshotVersion);return e=t.target.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(t.target):this.remoteSerializer.toQueryTarget(t.target),n=t.resumeToken instanceof Uint8Array?(Fr(Bo.isMockPersistence(),"Persisting non-string stream tokens is only supported with mock persistence ."),t.resumeToken.toString()):t.resumeToken,new Eu(t.targetId,t.target.canonicalId(),r,n,t.sequenceNumber,i,e)},Qu);function Qu(t){this.remoteSerializer=t}function ju(t,e){var n=t[0],r=t[1],i=e[0],o=e[1],a=vi(n,i);return 0===a?vi(r,o):a}var Wu=(Gu.prototype.nextIndex=function(){return++this.previousIndex},Gu.prototype.addElement=function(t){var e=[t,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(e);else{var n=this.buffer.last();ju(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}},Object.defineProperty(Gu.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),Gu);function Gu(t){this.maxElements=t,this.buffer=new vo(ju),this.previousIndex=0}var zu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Hu=(Yu.withCacheSize=function(t){return new Yu(t,Yu.DEFAULT_COLLECTION_PERCENTILE,Yu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},Yu.COLLECTION_DISABLED=-1,Yu.MINIMUM_CACHE_SIZE_BYTES=1048576,Yu.DEFAULT=new Yu(Yu.DEFAULT_CACHE_SIZE_BYTES=41943040,Yu.DEFAULT_COLLECTION_PERCENTILE=10,Yu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3),Yu.DISABLED=new Yu(Yu.COLLECTION_DISABLED,0,0),Yu);function Yu(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}var Xu=(Ju.prototype.start=function(){Fr(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==Hu.COLLECTION_DISABLED&&this.scheduleGC()},Ju.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(Ju.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),Ju.prototype.scheduleGC=function(){var t=this;Fr(null===this.gcTask,"Cannot schedule GC while a task is pending");var e=this.hasRun?3e5:6e4;_r("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(ji.LruGarbageCollection,e,function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then(function(){return t.scheduleGC()}).catch(hc)})},Ju);function Ju(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.hasRun=!1,this.gcTask=null}var Zu=($u.prototype.calculateTargetCount=function(t,e){return this.delegate.getSequenceNumberCount(t).next(function(t){return Math.floor(e/100*t)})},$u.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return Fo.resolve(Ri.INVALID);var r=new Wu(e);return this.delegate.forEachTarget(t,function(t){return r.addElement(t.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(t,function(t){return r.addElement(t)})}).next(function(){return r.maxValue})},$u.prototype.removeTargets=function(t,e,n){return this.delegate.removeTargets(t,e,n)},$u.prototype.removeOrphanedDocuments=function(t,e){return this.delegate.removeOrphanedDocuments(t,e)},$u.prototype.collect=function(e,n){var r=this;return this.params.cacheSizeCollectionThreshold===Hu.COLLECTION_DISABLED?(_r("LruGarbageCollector","Garbage collection skipped; disabled"),Fo.resolve(zu)):this.getCacheSize(e).next(function(t){return t<r.params.cacheSizeCollectionThreshold?(_r("LruGarbageCollector","Garbage collection skipped; Cache size "+t+" is lower than threshold "+r.params.cacheSizeCollectionThreshold),zu):r.runGarbageCollection(e,n)})},$u.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},$u.prototype.runGarbageCollection=function(e,n){var r,i,o,a,s,u,c,h=this,l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(function(t){return i=t>h.params.maximumSequenceNumbersToCollect?(_r("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+h.params.maximumSequenceNumbersToCollect+" from "+t),h.params.maximumSequenceNumbersToCollect):t,a=Date.now(),h.nthSequenceNumber(e,i)}).next(function(t){return r=t,s=Date.now(),h.removeTargets(e,r,n)}).next(function(t){return o=t,u=Date.now(),h.removeOrphanedDocuments(e,r)}).next(function(t){return c=Date.now(),Mr()<=Tr.DEBUG&&_r("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(a-l)+"ms\n\tDetermined least recently used "+i+" in "+(s-a)+"ms\n\tRemoved "+o+" targets in "+(u-s)+"ms\n\tRemoved "+t+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-l)+"ms"),Fo.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:o,documentsRemoved:t})})},$u);function $u(t,e){this.delegate=t,this.params=e}var tc=(ec.prototype.addOnCommittedListener=function(t){this.onCommittedListeners.push(t)},ec.prototype.raiseOnCommittedEvent=function(){this.onCommittedListeners.forEach(function(t){return t()})},ec);function ec(){this.onCommittedListeners=[]}var nc,rc="IndexedDbPersistence",ic="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",oc="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",ac=(s(sc,nc=tc),sc);function sc(t,e){var n=nc.call(this)||this;return n.simpleDbTransaction=t,n.currentSequenceNumber=e,n}var uc=(cc.getStore=function(t,e){if(t instanceof ac)return Bo.getStore(t.simpleDbTransaction,e);throw xr("IndexedDbPersistence must use instances of IndexedDbTransaction")},cc.createIndexedDbPersistence=function(n){return d(this,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:if(!cc.isAvailable())throw new Qr(Kr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");return[4,(e=new cc(n.allowTabSynchronization,n.persistenceKey,n.clientId,n.platform,n.lruParams,n.queue,n.serializer,n.sequenceNumberSyncer,n.force)).start()];case 1:return t.sent(),[2,e]}})})},cc.prototype.start=function(){var e=this;return Fr(!this.started,"IndexedDbPersistence double-started!"),Bo.openOrCreate(this.dbName,ou,new au(this.serializer)).then(function(t){return e.simpleDb=t,e.updateClientMetadataAndTryBecomePrimary(e.force)}).then(function(){return e.attachVisibilityHandler(),e.attachWindowUnloadHook(),e.scheduleClientMetadataAndPrimaryLeaseRefreshes(),e.simpleDb.runTransaction("readonly-idempotent",[Nu.store],function(t){return da(t)})}).then(function(t){e.listenSequence=new Ri(t,e.sequenceNumberSyncer)}).then(function(){e._started=!0}).catch(function(t){return e.simpleDb&&e.simpleDb.close(),Promise.reject(t)})},cc.prototype.setPrimaryStateListener=function(n){var t=this;return this.primaryStateListener=function(e){return d(t,void 0,void 0,function(){return m(this,function(t){return this.started?[2,n(e)]:[2]})})},n(this.isPrimary)},cc.prototype.setDatabaseDeletedListener=function(n){var t=this;this.simpleDb.setVersionChangeListener(function(e){return d(t,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return null!==e.newVersion?[3,2]:[4,n()];case 1:t.sent(),t.label=2;case 2:return[2]}})})})},cc.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget(function(){return d(e,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})}))},cc.prototype.updateClientMetadataAndTryBecomePrimary=function(t){var n=this;return void 0===t&&(t=!1),this.simpleDb.runTransaction("readwrite-idempotent",xu,function(e){return fc(e).put(new Ou(n.clientId,Date.now(),n.networkEnabled,n.inForeground)).next(function(){if(n.isPrimary)return n.verifyPrimaryLease(e).next(function(t){t||(n.isPrimary=!1,n.queue.enqueueAndForget(function(){return n.primaryStateListener(!1)}))})}).next(function(){return!!t||n.canActAsPrimary(e)}).next(function(t){return n.isPrimary&&!t?n.releasePrimaryLeaseIfHeld(e).next(function(){return!1}):!!t&&n.acquireOrExtendPrimaryLease(e).next(function(){return!0})})}).catch(function(t){if(!n.allowTabSynchronization)throw t;return _r(rc,"Releasing owner lease after error during lease refresh",t),!1}).then(function(t){n.isPrimary!==t&&n.queue.enqueueAndForget(function(){return n.primaryStateListener(t)}),n.isPrimary=t})},cc.prototype.verifyPrimaryLease=function(t){var e=this;return lc(t).get(cu.key).next(function(t){return Fo.resolve(e.isLocalClient(t))})},cc.prototype.removeClientMetadata=function(t){return fc(t).delete(this.clientId)},cc.prototype.maybeGarbageCollectMultiClientState=function(){return d(this,void 0,void 0,function(){var e,i=this;return m(this,function(t){switch(t.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary-idempotent",function(t){var r=cc.getStore(t,Ou.store);return r.loadAll().next(function(t){var e=i.filterActiveClients(t,18e5),n=t.filter(function(t){return-1===e.indexOf(t)});return Fo.forEach(n,function(t){return r.delete(t.clientId)}).next(function(){return n})})})]);case 1:e=t.sent(),this.webStorage&&e.forEach(function(t){i.webStorage.removeItem(i.zombiedClientLocalStorageKey(t.clientId))}),t.label=2;case 2:return[2]}})})},cc.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(ji.ClientMetadataRefresh,4e3,function(){return t.updateClientMetadataAndTryBecomePrimary().then(function(){return t.maybeGarbageCollectMultiClientState()}).then(function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},cc.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},cc.prototype.canActAsPrimary=function(e){var i=this;return lc(e).get(cu.key).next(function(t){if(null!==t&&i.isWithinAge(t.leaseTimestampMs,5e3)&&!i.isClientZombied(t.ownerId)){if(i.isLocalClient(t)&&i.networkEnabled)return!0;if(!i.isLocalClient(t)){if(i.force)return!0;if(!t.allowTabSynchronization)throw new Qr(Kr.FAILED_PRECONDITION,oc);return!1}}return!(!i.networkEnabled||!i.inForeground)||fc(e).loadAll().next(function(t){return void 0===i.filterActiveClients(t,5e3).find(function(t){if(i.clientId!==t.clientId){var e=!i.networkEnabled&&t.networkEnabled,n=!i.inForeground&&t.inForeground,r=i.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1})})}).next(function(t){return i.isPrimary!==t&&_r(rc,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t})},cc.prototype.shutdown=function(){return d(this,void 0,void 0,function(){var e=this;return m(this,function(t){switch(t.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&(this.clientMetadataRefresher.cancel(),this.clientMetadataRefresher=null),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite-idempotent",[cu.store,Ou.store],function(t){return e.releasePrimaryLeaseIfHeld(t).next(function(){return e.removeClientMetadata(t)})})];case 1:return t.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},cc.prototype.filterActiveClients=function(t,e){var n=this;return t.filter(function(t){return n.isWithinAge(t.updateTimeMs,e)&&!n.isClientZombied(t.clientId)})},cc.prototype.getActiveClients=function(){var e=this;return this.simpleDb.runTransaction("readonly-idempotent",[Ou.store],function(t){return fc(t).loadAll().next(function(t){return e.filterActiveClients(t,18e5).map(function(t){return t.clientId})})})},cc.clearPersistence=function(n){return d(this,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:return cc.isAvailable()?(e=n+cc.MAIN_DATABASE,[4,Bo.delete(e)]):[2,Promise.resolve()];case 1:return t.sent(),[2]}})})},Object.defineProperty(cc.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),cc.prototype.getMutationQueue=function(t){return Fr(this.started,"Cannot initialize MutationQueue before persistence is started."),Jo.forUser(t,this.serializer,this.indexManager,this.referenceDelegate)},cc.prototype.getTargetCache=function(){return Fr(this.started,"Cannot initialize TargetCache before persistence is started."),this.targetCache},cc.prototype.getRemoteDocumentCache=function(){return Fr(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},cc.prototype.getIndexManager=function(){return Fr(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},cc.prototype.runTransaction=function(n,t,r){var i=this;_r(rc,"Starting transaction:",n);var o,e=t.endsWith("idempotent"),a=t.startsWith("readonly")?e?"readonly-idempotent":"readonly":e?"readwrite-idempotent":"readwrite";return this.simpleDb.runTransaction(a,xu,function(e){return o=new ac(e,i.listenSequence.next()),"readwrite-primary"===t||"readwrite-primary-idempotent"===t?i.verifyPrimaryLease(e).next(function(t){return!!t||i.canActAsPrimary(e)}).next(function(t){if(!t)throw Lr("Failed to obtain primary lease for action '"+n+"'."),i.isPrimary=!1,i.queue.enqueueAndForget(function(){return i.primaryStateListener(!1)}),new Qr(Kr.FAILED_PRECONDITION,ic);return r(o)}).next(function(t){return i.acquireOrExtendPrimaryLease(e).next(function(){return t})}):i.verifyAllowTabSynchronization(e).next(function(){return r(o)})}).then(function(t){return o.raiseOnCommittedEvent(),t})},cc.prototype.verifyAllowTabSynchronization=function(t){var e=this;return lc(t).get(cu.key).next(function(t){if(null!==t&&e.isWithinAge(t.leaseTimestampMs,5e3)&&!e.isClientZombied(t.ownerId)&&!e.isLocalClient(t)&&!t.allowTabSynchronization)throw new Qr(Kr.FAILED_PRECONDITION,oc)})},cc.prototype.acquireOrExtendPrimaryLease=function(t){var e=new cu(this.clientId,this.allowTabSynchronization,Date.now());return lc(t).put(cu.key,e)},cc.isAvailable=function(){return Bo.isAvailable()},cc.buildStoragePrefix=function(t){var e=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(e+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+e+"/"},cc.prototype.releasePrimaryLeaseIfHeld=function(t){var e=this,n=lc(t);return n.get(cu.key).next(function(t){return e.isLocalClient(t)?(_r(rc,"Releasing primary lease."),n.delete(cu.key)):Fo.resolve()})},cc.prototype.isWithinAge=function(t,e){var n=Date.now();return!(t<n-e||n<t&&(Lr("Detected an update time that is in the future: "+t+" > "+n),1))},cc.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget(function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},cc.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(Fr(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},cc.prototype.attachWindowUnloadHook=function(){var t=this;this.window&&"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget(function(){return t.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},cc.prototype.detachWindowUnloadHook=function(){this.window&&this.windowUnloadHandler&&(Fr("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},cc.prototype.isClientZombied=function(t){if(!this.webStorage)return!1;try{var e=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return _r(rc,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return Lr(rc,"Failed to get zombied client id.",t),!1}},cc.prototype.markClientZombied=function(){if(this.webStorage)try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){Lr("Failed to set zombie client id.",t)}},cc.prototype.removeClientZombiedEntry=function(){if(this.webStorage)try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},cc.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},cc.MAIN_DATABASE="main",cc);function cc(t,e,n,r,i,o,a,s,u){this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.queue=o,this.sequenceNumberSyncer=s,this.force=u,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.windowUnloadHandler=null,this.inForeground=!1,this.documentVisibilityHandler=null,this.clientMetadataRefresher=null,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(t){return Promise.resolve()},this.referenceDelegate=new dc(this,i),this.dbName=e+cc.MAIN_DATABASE,this.serializer=new Ku(a),this.document=r.document,this.targetCache=new ca(this.referenceDelegate,this.serializer),this.indexManager=new Fu,this.remoteDocumentCache=new Hs(this.serializer,this.indexManager),this.window=r.window,r.window&&r.window.localStorage?this.webStorage=r.window.localStorage:(this.webStorage=null,!1===u&&Lr(rc,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}function hc(e){return d(this,void 0,void 0,function(){return m(this,function(t){if(!function(t){return t.code===Kr.FAILED_PRECONDITION&&t.message===ic}(e))throw e;return _r(rc,"Unexpectedly lost primary lease"),[2]})})}function lc(t){return t.store(cu.store)}function fc(t){return t.store(Ou.store)}var dc=(pc.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocmentCount(t);return this.db.getTargetCache().getTargetCount(t).next(function(e){return n.next(function(t){return e+t})})},pc.prototype.orphanedDocmentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},pc.prototype.forEachTarget=function(t,e){return this.db.getTargetCache().forEachTarget(t,e)},pc.prototype.forEachOrphanedDocumentSequenceNumber=function(t,n){return this.forEachOrphanedDocument(t,function(t,e){return n(e)})},pc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},pc.prototype.addReference=function(t,e){return mc(t,e)},pc.prototype.removeReference=function(t,e){return mc(t,e)},pc.prototype.removeTargets=function(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)},pc.prototype.removeMutationReference=function(t,e){return mc(t,e)},pc.prototype.isPinned=function(t,e){return this.inMemoryPins.containsKey(e)?Fo.resolve(!0):function(e,n){var r=!1;return ia(e).iterateSerial(function(t){return $o(e,t,n).next(function(t){return t&&(r=!0),Fo.resolve(!t)})}).next(function(){return r})}(t,e)},pc.prototype.removeOrphanedDocuments=function(r,i){var o=this,a=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[],u=0;return this.forEachOrphanedDocument(r,function(e,t){if(t<=i){var n=o.isPinned(r,e).next(function(t){if(!t)return u++,a.getEntry(r,e).next(function(){return a.removeEntry(e),pa(r).delete(function(t){return[0,eo(t.path)]}(e))})});s.push(n)}}).next(function(){return Fo.waitFor(s)}).next(function(){return a.apply(r)}).next(function(){return u})},pc.prototype.removeTarget=function(t,e){var n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)},pc.prototype.updateLimboDocument=function(t,e){return mc(t,e)},pc.prototype.forEachOrphanedDocument=function(t,o){var a,e=pa(t),s=Ri.INVALID;return e.iterate({index:Cu.documentTargetsIndex},function(t,e){var n=t[0],r=(t[1],e.path),i=e.sequenceNumber;0===n?(s!==Ri.INVALID&&o(new Ki(io(a)),s),s=i,a=r):s=Ri.INVALID}).next(function(){s!==Ri.INVALID&&o(new Ki(io(a)),s)})},pc.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},pc);function pc(t,e){this.db=t,this.inMemoryPins=null,this.garbageCollector=new Zu(this,e)}function mc(t,e){return pa(t).put(function(t,e){return new Cu(0,eo(t.path),e)}(e,t.currentSequenceNumber))}var yc=(gc.prototype.getDocument=function(e,n){var r=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(e,n).next(function(t){return r.getDocumentInternal(e,n,t)})},gc.prototype.getDocumentInternal=function(t,r,i){return this.remoteDocumentCache.getEntry(t,r).next(function(t){for(var e=0,n=i;e<n.length;e++)t=n[e].applyToLocalView(r,t);return t})},gc.prototype.applyLocalMutationsToDocuments=function(t,e,i){var o=Io();return e.forEach(function(t,e){for(var n=0,r=i;n<r.length;n++)e=r[n].applyToLocalView(t,e);o=o.insert(t,e)}),o},gc.prototype.getDocuments=function(e,t){var n=this;return this.remoteDocumentCache.getEntries(e,t).next(function(t){return n.getLocalViewOfDocuments(e,t)})},gc.prototype.getLocalViewOfDocuments=function(r,i){var o=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(r,i).next(function(t){var e=o.applyLocalMutationsToDocuments(r,i,t),n=Eo();return e.forEach(function(t,e){e=e||new qs(t,so.forDeletedDoc()),n=n.insert(t,e)}),n})},gc.prototype.getDocumentsMatchingQuery=function(t,e,n){return e.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(t,e.path):e.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(t,e,n):this.getDocumentsMatchingCollectionQuery(t,e,n)},gc.prototype.getDocumentsMatchingDocumentQuery=function(t,e){return this.getDocument(t,new Ki(e)).next(function(t){var e=Do();return t instanceof Ps&&(e=e.insert(t.key,t)),e})},gc.prototype.getDocumentsMatchingCollectionGroupQuery=function(n,r,i){var o=this;Fr(r.path.isEmpty(),"Currently we only support collection group queries at the root.");var a=r.collectionGroup,s=Do();return this.indexManager.getCollectionParents(n,a).next(function(t){return Fo.forEach(t,function(t){var e=r.asCollectionQueryAtPath(t.child(a));return o.getDocumentsMatchingCollectionQuery(n,e,i).next(function(t){t.forEach(function(t,e){s=s.insert(t,e)})})}).next(function(){return s})})},gc.prototype.getDocumentsMatchingCollectionQuery=function(e,n,t){var h,l,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(e,n,t).next(function(t){return h=t,r.mutationQueue.getAllMutationBatchesAffectingQuery(e,n)}).next(function(t){return l=t,r.addMissingBaseDocuments(e,l,h).next(function(t){h=t;for(var e=0,n=l;e<n.length;e++)for(var r=n[e],i=0,o=r.mutations;i<o.length;i++){var a=o[i],s=a.key,u=h.get(s),c=a.applyToLocalView(u,u,r.localWriteTime);h=c instanceof Ps?h.insert(s,c):h.remove(s)}})}).next(function(){return h.forEach(function(t,e){n.matches(e)||(h=h.remove(t))}),h})},gc.prototype.addMissingBaseDocuments=function(t,e,n){for(var r=Ro(),i=0,o=e;i<o.length;i++)for(var a=0,s=o[i].mutations;a<s.length;a++){var u=s[a];u instanceof Ra&&null===n.get(u.key)&&(r=r.add(u.key))}var c=n;return this.remoteDocumentCache.getEntries(t,r).next(function(t){return t.forEach(function(t,e){null!==e&&e instanceof Ps&&(c=c.insert(t,e))}),c})},gc);function gc(t,e,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.indexManager=n}var vc=(bc.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},bc.prototype.addReference=function(t,e){var n=new wc(t,e);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},bc.prototype.addReferences=function(t,e){var n=this;t.forEach(function(t){return n.addReference(t,e)})},bc.prototype.removeReference=function(t,e){this.removeRef(new wc(t,e))},bc.prototype.removeReferences=function(t,e){var n=this;t.forEach(function(t){return n.removeReference(t,e)})},bc.prototype.removeReferencesForId=function(t){var e=this,n=Ki.EMPTY,r=new wc(n,t),i=new wc(n,t+1),o=[];return this.refsByTarget.forEachInRange([r,i],function(t){e.removeRef(t),o.push(t.key)}),o},bc.prototype.removeAllReferences=function(){var e=this;this.refsByKey.forEach(function(t){return e.removeRef(t)})},bc.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},bc.prototype.referencesForId=function(t){var e=Ki.EMPTY,n=new wc(e,t),r=new wc(e,t+1),i=Ro();return this.refsByTarget.forEachInRange([n,r],function(t){i=i.add(t.key)}),i},bc.prototype.containsKey=function(t){var e=new wc(t,0),n=this.refsByKey.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)},bc);function bc(){this.refsByKey=new vo(wc.compareByKey),this.refsByTarget=new vo(wc.compareByTargetId)}var wc=(Tc.compareByKey=function(t,e){return Ki.comparator(t.key,e.key)||vi(t.targetOrBatchId,e.targetOrBatchId)},Tc.compareByTargetId=function(t,e){return vi(t.targetOrBatchId,e.targetOrBatchId)||Ki.comparator(t.key,e.key)},Tc);function Tc(t,e){this.key=t,this.targetOrBatchId=e}var Sc="LocalStore",Ec=(Ic.prototype.start=function(){return this.synchronizeLastDocumentChangeReadTime()},Ic.prototype.handleUserChange=function(i){return d(this,void 0,void 0,function(){var e,y,n,r=this;return m(this,function(t){switch(t.label){case 0:return e=this.mutationQueue,y=this.localDocuments,[4,this.persistence.runTransaction("Handle user change","readonly-idempotent",function(p){var m;return r.mutationQueue.getAllMutationBatches(p).next(function(t){return m=t,e=r.persistence.getMutationQueue(i),y=new yc(r.remoteDocuments,e,r.persistence.getIndexManager()),e.getAllMutationBatches(p)}).next(function(t){for(var e=[],n=[],r=Ro(),i=0,o=m;i<o.length;i++){var a=o[i];e.push(a.batchId);for(var s=0,u=a.mutations;s<u.length;s++){var c=u[s];r=r.add(c.key)}}for(var h=0,l=t;h<l.length;h++){a=l[h],n.push(a.batchId);for(var f=0,d=a.mutations;f<d.length;f++)c=d[f],r=r.add(c.key)}return y.getDocuments(p,r).next(function(t){return{affectedDocuments:t,removedBatchIds:e,addedBatchIds:n}})})})];case 1:return n=t.sent(),this.mutationQueue=e,this.localDocuments=y,this.queryEngine.setLocalDocumentsView(this.localDocuments),[2,n]}})})},Ic.prototype.localWrite=function(s){var u,c=this,h=oo.now(),t=s.reduce(function(t,e){return t.add(e.key)},Ro());return this.persistence.runTransaction("Locally write mutations","readwrite-idempotent",function(a){return c.localDocuments.getDocuments(a,t).next(function(t){u=t;for(var e=[],n=0,r=s;n<r.length;n++){var i=r[n],o=i.extractBaseValue(u.get(i.key));null!=o&&e.push(new Ra(i.key,o,o.fieldMask(),Sa.exists(!0)))}return c.mutationQueue.addMutationBatch(a,h,e,s)})}).then(function(t){var e=t.applyToLocalDocumentSet(u);return{batchId:t.batchId,changes:e}})},Ic.prototype.lookupMutationDocuments=function(t){var n=this;return this.persistence.runTransaction("Lookup mutation documents","readonly-idempotent",function(e){return n.mutationQueue.lookupMutationKeys(e,t).next(function(t){return t?n.localDocuments.getDocuments(e,t):Fo.resolve(null)})})},Ic.prototype.acknowledgeBatch=function(r){var i=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary-idempotent",function(t){var e=r.batch.keys(),n=i.remoteDocuments.newChangeBuffer({trackRemovals:!0});return i.mutationQueue.acknowledgeBatch(t,r.batch,r.streamToken).next(function(){return i.applyWriteToRemoteDocuments(t,r,n)}).next(function(){return n.apply(t)}).next(function(){return i.mutationQueue.performConsistencyCheck(t)}).next(function(){return i.localDocuments.getDocuments(t,e)})})},Ic.prototype.rejectBatch=function(t){var r=this;return this.persistence.runTransaction("Reject batch","readwrite-primary-idempotent",function(e){var n;return r.mutationQueue.lookupMutationBatch(e,t).next(function(t){return Fr(null!==t,"Attempt to reject nonexistent batch!"),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t)}).next(function(){return r.mutationQueue.performConsistencyCheck(e)}).next(function(){return r.localDocuments.getDocuments(e,n)})})},Ic.prototype.getHighestUnacknowledgedBatchId=function(){var e=this;return this.persistence.runTransaction("Get highest unacknowledged batch id","readonly-idempotent",function(t){return e.mutationQueue.getHighestUnacknowledgedBatchId(t)})},Ic.prototype.getLastStreamToken=function(){var e=this;return this.persistence.runTransaction("Get last stream token","readonly-idempotent",function(t){return e.mutationQueue.getLastStreamToken(t)})},Ic.prototype.setLastStreamToken=function(e){var n=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary-idempotent",function(t){return n.mutationQueue.setLastStreamToken(t,e)})},Ic.prototype.getLastRemoteSnapshotVersion=function(){var e=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly-idempotent",function(t){return e.targetCache.getLastRemoteSnapshotVersion(t)})},Ic.prototype.applyRemoteEvent=function(u){var c=this,h=u.snapshotVersion,l=this.targetDataByTarget;return this.persistence.runTransaction("Apply remote event","readwrite-primary-idempotent",function(o){var i=c.remoteDocuments.newChangeBuffer({trackRemovals:!0});l=c.targetDataByTarget;var a=[];Hr(u.targetChanges,function(t,e){var n=l.get(t);if(n){a.push(c.targetCache.removeMatchingKeys(o,e.removedDocuments,t).next(function(){return c.targetCache.addMatchingKeys(o,e.addedDocuments,t)}));var r=e.resumeToken;if(0<r.length){var i=n.withResumeToken(r,h).withSequenceNumber(o.currentSequenceNumber);l=l.insert(t,i),Ic.shouldPersistTargetData(n,i,e)&&a.push(c.targetCache.updateTargetData(o,i))}}});var s=Eo(),n=Ro();if(u.documentUpdates.forEach(function(t,e){n=n.add(t)}),a.push(i.getEntries(o,n).next(function(r){u.documentUpdates.forEach(function(t,e){var n=r.get(t);e instanceof qs&&e.version.isEqual(so.MIN)?(i.removeEntry(t,h),s=s.insert(t,e)):null==n||0<e.version.compareTo(n.version)||0===e.version.compareTo(n.version)&&n.hasPendingWrites?(so.MIN.isEqual(h)&&Lr(Sc,"Cannot add a document when the remote version is zero"),i.addEntry(e,h),s=s.insert(t,e)):_r(Sc,"Ignoring outdated watch update for ",t,". Current version:",n.version," Watch version:",e.version),u.resolvedLimboDocuments.has(t)&&a.push(c.persistence.referenceDelegate.updateLimboDocument(o,t))})})),!h.isEqual(so.MIN)){var t=c.targetCache.getLastRemoteSnapshotVersion(o).next(function(t){return Fr(0<=h.compareTo(t),"Watch stream reverted to previous snapshot?? "+h+" < "+t),c.targetCache.setTargetsMetadata(o,o.currentSequenceNumber,h)});a.push(t)}return Fo.waitFor(a).next(function(){return i.apply(o)}).next(function(){return c.localDocuments.getLocalViewOfDocuments(o,s)})}).then(function(t){return c.targetDataByTarget=l,t})},Ic.shouldPersistTargetData=function(t,e,n){return Fr(0<e.resumeToken.length,"Attempted to persist target data with no resume token"),0===t.resumeToken.length||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||0<n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size},Ic.prototype.notifyLocalViewChanges=function(t){for(var n=this,e=0,r=t;e<r.length;e++){var i=r[e],o=i.targetId;if(this.localViewReferences.addReferences(i.addedKeys,o),this.localViewReferences.removeReferences(i.removedKeys,o),!i.fromCache){var a=this.targetDataByTarget.get(o);Fr(null!==a,"Can't set limbo-free snapshot version for unknown target: "+o);var s=a.snapshotVersion,u=a.withLastLimboFreeSnapshotVersion(s);this.targetDataByTarget=this.targetDataByTarget.insert(o,u)}}return this.persistence.runTransaction("notifyLocalViewChanges","readwrite-idempotent",function(e){return Fo.forEach(t,function(t){return Fo.forEach(t.removedKeys,function(t){return n.persistence.referenceDelegate.removeReference(e,t)})})})},Ic.prototype.nextMutationBatch=function(e){var n=this;return this.persistence.runTransaction("Get next mutation batch","readonly-idempotent",function(t){return void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e)})},Ic.prototype.readDocument=function(e){var n=this;return this.persistence.runTransaction("read document","readonly-idempotent",function(t){return n.localDocuments.getDocument(t,e)})},Ic.prototype.allocateTarget=function(r){var i=this;return this.persistence.runTransaction("Allocate target","readwrite-idempotent",function(e){var n;return i.targetCache.getTargetData(e,r).next(function(t){return t?(n=t,Fo.resolve(n)):i.targetCache.allocateTargetId(e).next(function(t){return n=new Bu(r,t,Lu.Listen,e.currentSequenceNumber),i.targetCache.addTargetData(e,n).next(function(){return n})})})}).then(function(t){return null===i.targetDataByTarget.get(t.targetId)&&(i.targetDataByTarget=i.targetDataByTarget.insert(t.targetId,t),i.targetIdByTarget.set(r,t.targetId)),t})},Ic.prototype.getTargetData=function(t,e){var n=this.targetIdByTarget.get(e);return void 0!==n?Fo.resolve(this.targetDataByTarget.get(n)):this.targetCache.getTargetData(t,e)},Ic.prototype.releaseTarget=function(n,r){var i=this,o=this.targetDataByTarget.get(n);if(!o)return Promise.resolve();var t=r?"readwrite-idempotent":"readwrite-primary-idempotent";return this.persistence.runTransaction("Release target",t,function(e){var t=i.localViewReferences.removeReferencesForId(n);return r?Fo.resolve():Fo.forEach(t,function(t){return i.persistence.referenceDelegate.removeReference(e,t)}).next(function(){i.persistence.referenceDelegate.removeTarget(e,o)})}).then(function(){i.targetDataByTarget=i.targetDataByTarget.remove(n),i.targetIdByTarget.delete(o.target)})},Ic.prototype.executeQuery=function(t,n){var r=this,i=so.MIN,o=Ro();return this.persistence.runTransaction("Execute query","readonly-idempotent",function(e){return r.getTargetData(e,t.toTarget()).next(function(t){if(t)return i=t.lastLimboFreeSnapshotVersion,r.targetCache.getMatchingKeysForTargetId(e,t.targetId).next(function(t){o=t})}).next(function(){return r.queryEngine.getDocumentsMatchingQuery(e,t,n?i:so.MIN,n?o:Ro())}).next(function(t){return{documents:t,remoteKeys:o}})})},Ic.prototype.remoteDocumentKeys=function(e){var n=this;return this.persistence.runTransaction("Remote document keys","readonly-idempotent",function(t){return n.targetCache.getMatchingKeysForTargetId(t,e)})},Ic.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},Ic.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},Ic.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},Ic.prototype.applyWriteToRemoteDocuments=function(t,i,o){var e=this,a=i.batch,n=a.keys(),s=Fo.resolve();return n.forEach(function(r){s=s.next(function(){return o.getEntry(t,r)}).next(function(t){var e=t,n=i.docVersions.get(r);Fr(null!==n,"ackVersions should contain every doc in the write."),(!e||e.version.compareTo(n)<0)&&((e=a.applyToRemoteDocument(r,e,i))?o.addEntry(e,i.commitVersion):Fr(!t,"Mutation batch "+a+" applied to document "+t+" resulted in null"))})}),s.next(function(){return e.mutationQueue.removeMutationBatch(t,a)})},Ic.prototype.collectGarbage=function(e){var n=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary-idempotent",function(t){return e.collect(t,n.targetDataByTarget)})},Ic.prototype.getTarget=function(e){var n=this,t=this.targetDataByTarget.get(e);return t?Promise.resolve(t.target):this.persistence.runTransaction("Get target data","readonly-idempotent",function(t){return n.targetCache.getTargetDataForTarget(t,e).next(function(t){return t?t.target:null})})},Ic.prototype.getNewDocumentChanges=function(){var r=this;return this.persistence.runTransaction("Get new document changes","readonly-idempotent",function(t){return r.remoteDocuments.getNewDocumentChanges(t,r.lastDocumentChangeReadTime)}).then(function(t){var e=t.changedDocs,n=t.readTime;return r.lastDocumentChangeReadTime=n,e})},Ic.prototype.synchronizeLastDocumentChangeReadTime=function(){return d(this,void 0,void 0,function(){var e,n=this;return m(this,function(t){return this.remoteDocuments instanceof Hs?(e=this.remoteDocuments,[2,this.persistence.runTransaction("Synchronize last document change read time","readonly-idempotent",function(t){return e.getLastDocumentChange(t)}).then(function(t){var e=t.readTime;n.lastDocumentChangeReadTime=e})]):[2]})})},Ic.RESUME_TOKEN_MAX_AGE_MICROS=3e8,Ic);function Ic(t,e,n){this.persistence=t,this.queryEngine=e,this.localViewReferences=new vc,this.targetDataByTarget=new co(vi),this.targetIdByTarget=new Qs(function(t){return t.canonicalId()}),this.lastDocumentChangeReadTime=so.MIN,Fr(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(n),this.remoteDocuments=t.getRemoteDocumentCache(),this.targetCache=t.getTargetCache(),this.localDocuments=new yc(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager()),this.queryEngine.setLocalDocumentsView(this.localDocuments)}var Cc=(Dc.prototype.checkEmpty=function(t){return Fo.resolve(0===this.mutationQueue.length)},Dc.prototype.acknowledgeBatch=function(t,e,n){var r=e.batchId,i=this.indexOfExistingBatchId(r,"acknowledged");Fr(0===i,"Can only acknowledge the first batch in the mutation queue");var o=this.mutationQueue[i];return Fr(r===o.batchId,"Queue ordering failure: expected batch "+r+", got batch "+o.batchId),this.lastStreamToken=n,Fo.resolve()},Dc.prototype.getLastStreamToken=function(t){return Fo.resolve(this.lastStreamToken)},Dc.prototype.setLastStreamToken=function(t,e){return this.lastStreamToken=e,Fo.resolve()},Dc.prototype.addMutationBatch=function(t,e,n,r){Fr(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;this.nextBatchId++,0<this.mutationQueue.length&&Fr(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");var o=new _o(i,e,n,r);this.mutationQueue.push(o);for(var a=0,s=r;a<s.length;a++){var u=s[a];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new wc(u.key,i)),this.indexManager.addToCollectionParentIndex(t,u.key.path.popLast())}return Fo.resolve(o)},Dc.prototype.lookupMutationBatch=function(t,e){return Fo.resolve(this.findMutationBatch(e))},Dc.prototype.lookupMutationKeys=function(t,e){var n=this.findMutationBatch(e);return Fr(null!=n,"Failed to find local mutation batch."),Fo.resolve(n.keys())},Dc.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=e+1,r=this.indexOfBatchId(n),i=r<0?0:r;return Fo.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)},Dc.prototype.getHighestUnacknowledgedBatchId=function(){return Fo.resolve(0===this.mutationQueue.length?-1:this.nextBatchId-1)},Dc.prototype.getAllMutationBatches=function(t){return Fo.resolve(this.mutationQueue.slice())},Dc.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,n){var r=this,e=new wc(n,0),i=new wc(n,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([e,i],function(t){Fr(n.isEqual(t.key),"Should only iterate over a single key's batches");var e=r.findMutationBatch(t.targetOrBatchId);Fr(null!==e,"Batches in the index must exist in the main table"),o.push(e)}),Fo.resolve(o)},Dc.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var r=this,i=new vo(vi);return e.forEach(function(e){var t=new wc(e,0),n=new wc(e,Number.POSITIVE_INFINITY);r.batchesByDocumentKey.forEachInRange([t,n],function(t){Fr(e.isEqual(t.key),"For each key, should only iterate over a single key's batches"),i=i.add(t.targetOrBatchId)})}),Fo.resolve(this.findMutationBatches(i))},Dc.prototype.getAllMutationBatchesAffectingQuery=function(t,e){Fr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=e.path,r=n.length+1,i=n;Ki.isDocumentKey(i)||(i=i.child(""));var o=new wc(new Ki(i),0),a=new vo(vi);return this.batchesByDocumentKey.forEachWhile(function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(a=a.add(t.targetOrBatchId)),!0)},o),Fo.resolve(this.findMutationBatches(a))},Dc.prototype.findMutationBatches=function(t){var n=this,r=[];return t.forEach(function(t){var e=n.findMutationBatch(t);null!==e&&r.push(e)}),r},Dc.prototype.removeMutationBatch=function(n,r){var i=this;Fr(0===this.indexOfExistingBatchId(r.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var o=this.batchesByDocumentKey;return Fo.forEach(r.mutations,function(t){var e=new wc(t.key,r.batchId);return o=o.delete(e),i.referenceDelegate.removeMutationReference(n,t.key)}).next(function(){i.batchesByDocumentKey=o})},Dc.prototype.removeCachedMutationKeys=function(t){},Dc.prototype.containsKey=function(t,e){var n=new wc(e,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return Fo.resolve(e.isEqual(r&&r.key))},Dc.prototype.performConsistencyCheck=function(t){return 0===this.mutationQueue.length&&Fr(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),Fo.resolve()},Dc.prototype.indexOfExistingBatchId=function(t,e){var n=this.indexOfBatchId(t);return Fr(0<=n&&n<this.mutationQueue.length,"Batches must exist to be "+e),n},Dc.prototype.indexOfBatchId=function(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId},Dc.prototype.findMutationBatch=function(t){var e=this.indexOfBatchId(t);if(e<0||e>=this.mutationQueue.length)return null;var n=this.mutationQueue[e];return Fr(n.batchId===t,"If found batch must match"),n},Dc);function Dc(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=Br(),this.batchesByDocumentKey=new vo(wc.compareByKey)}var Nc,Ac=(kc.prototype.addEntry=function(t,e,n){Fr(!n.isEqual(so.MIN),"Cannot add a document with a read time of zero");var r=e.key,i=this.docs.get(r),o=i?i.size:0,a=this.sizer(e);return this.docs=this.docs.insert(r,{maybeDocument:e,size:a,readTime:n}),this.size+=a-o,this.indexManager.addToCollectionParentIndex(t,r.path.popLast())},kc.prototype.removeEntry=function(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)},kc.prototype.getEntry=function(t,e){var n=this.docs.get(e);return Fo.resolve(n?n.maybeDocument:null)},kc.prototype.getEntries=function(t,e){var n=this,r=Io();return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null)}),Fo.resolve(r)},kc.prototype.getDocumentsMatchingQuery=function(t,e,n){Fr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var r=Do(),i=new Ki(e.path.child("")),o=this.docs.getIteratorFrom(i);o.hasNext();){var a=o.getNext(),s=a.key,u=a.value,c=u.maybeDocument,h=u.readTime;if(!e.path.isPrefixOf(s.path))break;h.compareTo(n)<=0||c instanceof Ps&&e.matches(c)&&(r=r.insert(c.key,c))}return Fo.resolve(r)},kc.prototype.forEachDocumentKey=function(t,e){return Fo.forEach(this.docs,function(t){return e(t)})},kc.prototype.getNewDocumentChanges=function(t,e){throw new Error("getNewDocumentChanges() is not supported with MemoryPersistence")},kc.prototype.newChangeBuffer=function(t){return new kc.RemoteDocumentChangeBuffer(this)},kc.prototype.getSize=function(t){return Fo.resolve(this.size)},kc.RemoteDocumentChangeBuffer=(s(Rc,Nc=Ws),Rc.prototype.applyChanges=function(n){var r=this,i=[];return this.changes.forEach(function(t,e){e?i.push(r.documentCache.addEntry(n,e,r.readTime)):r.documentCache.removeEntry(t)}),Fo.waitFor(i)},Rc.prototype.getFromCache=function(t,e){return this.documentCache.getEntry(t,e)},Rc.prototype.getAllFromCache=function(t,e){return this.documentCache.getEntries(t,e)},Rc),kc);function kc(t,e){this.indexManager=t,this.sizer=e,this.docs=new co(Ki.comparator),this.size=0}function Rc(t){var e=Nc.call(this)||this;return e.documentCache=t,e}var Mc=(Oc.prototype.forEachTarget=function(t,n){return this.targets.forEach(function(t,e){return n(e)}),Fo.resolve()},Oc.prototype.getLastRemoteSnapshotVersion=function(t){return Fo.resolve(this.lastRemoteSnapshotVersion)},Oc.prototype.getHighestSequenceNumber=function(t){return Fo.resolve(this.highestSequenceNumber)},Oc.prototype.allocateTargetId=function(t){var e=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=e,Fo.resolve(e)},Oc.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.highestSequenceNumber&&(this.highestSequenceNumber=e),Fo.resolve()},Oc.prototype.saveTargetData=function(t){this.targets.set(t.target,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},Oc.prototype.addTargetData=function(t,e){return Fr(!this.targets.has(e.target),"Adding a target that already exists"),this.saveTargetData(e),this.targetCount+=1,Fo.resolve()},Oc.prototype.updateTargetData=function(t,e){return Fr(this.targets.has(e.target),"Updating a non-existent target"),this.saveTargetData(e),Fo.resolve()},Oc.prototype.removeTargetData=function(t,e){return Fr(0<this.targetCount,"Removing a target from an empty cache"),Fr(this.targets.has(e.target),"Removing a non-existent target from the cache"),this.targets.delete(e.target),this.references.removeReferencesForId(e.targetId),this.targetCount-=1,Fo.resolve()},Oc.prototype.removeTargets=function(n,r,i){var o=this,a=0,s=[];return this.targets.forEach(function(t,e){e.sequenceNumber<=r&&null===i.get(e.targetId)&&(o.targets.delete(t),s.push(o.removeMatchingKeysForTargetId(n,e.targetId)),a++)}),Fo.waitFor(s).next(function(){return a})},Oc.prototype.getTargetCount=function(t){return Fo.resolve(this.targetCount)},Oc.prototype.getTargetData=function(t,e){var n=this.targets.get(e)||null;return Fo.resolve(n)},Oc.prototype.getTargetDataForTarget=function(t,e){return xr("Not yet implemented.")},Oc.prototype.addMatchingKeys=function(e,t,n){this.references.addReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.addReference(e,t))}),Fo.waitFor(i)},Oc.prototype.removeMatchingKeys=function(e,t,n){this.references.removeReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.removeReference(e,t))}),Fo.waitFor(i)},Oc.prototype.removeMatchingKeysForTargetId=function(t,e){return this.references.removeReferencesForId(e),Fo.resolve()},Oc.prototype.getMatchingKeysForTargetId=function(t,e){var n=this.references.referencesForId(e);return Fo.resolve(n)},Oc.prototype.containsKey=function(t,e){return Fo.resolve(this.references.containsKey(e))},Oc);function Oc(t){this.persistence=t,this.targets=new Qs(function(t){return t.canonicalId()}),this.lastRemoteSnapshotVersion=so.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new vc,this.targetCount=0,this.targetIdGenerator=sa.forTargetCache()}var _c=(Lc.createLruPersistence=function(t,e,n){return new Lc(t,function(t){return new Bc(t,new Ku(e),n)})},Lc.createEagerPersistence=function(t){return new Lc(t,function(t){return new qc(t)})},Lc.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(Lc.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),Lc.prototype.getActiveClients=function(){return d(this,void 0,void 0,function(){return m(this,function(t){return[2,[this.clientId]]})})},Lc.prototype.setPrimaryStateListener=function(t){return t(!0)},Lc.prototype.setDatabaseDeletedListener=function(){},Lc.prototype.setNetworkEnabled=function(t){},Lc.prototype.getIndexManager=function(){return this.indexManager},Lc.prototype.getMutationQueue=function(t){var e=this.mutationQueues[t.toKey()];return e||(e=new Cc(this.indexManager,this.referenceDelegate),this.mutationQueues[t.toKey()]=e),e},Lc.prototype.getTargetCache=function(){return this.targetCache},Lc.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},Lc.prototype.runTransaction=function(t,e,n){var r=this;_r("MemoryPersistence","Starting transaction:",t);var i=new xc(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(t){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return t})}).toPromise().then(function(t){return i.raiseOnCommittedEvent(),t})},Lc.prototype.mutationQueuesContainKey=function(e,n){return Fo.or(function(t){var n=[];return Yr(t,function(t,e){return n.push(e)}),n}(this.mutationQueues).map(function(t){return function(){return t.containsKey(e,n)}}))},Lc);function Lc(t,e){var n=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new Ri(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.targetCache=new Mc(this);this.indexManager=new eu,this.remoteDocumentCache=new Ac(this.indexManager,function(t){return n.referenceDelegate.documentSize(t)})}var Pc,xc=(s(Fc,Pc=tc),Fc);function Fc(t){var e=Pc.call(this)||this;return e.currentSequenceNumber=t,e}var qc=(Object.defineProperty(Vc.prototype,"orphanedDocuments",{get:function(){if(this._orphanedDocuments)return this._orphanedDocuments;throw xr("orphanedDocuments is only valid during a transaction.")},enumerable:!0,configurable:!0}),Vc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},Vc.prototype.addReference=function(t,e){return this.orphanedDocuments.delete(e),Fo.resolve()},Vc.prototype.removeReference=function(t,e){return this.orphanedDocuments.add(e),Fo.resolve()},Vc.prototype.removeMutationReference=function(t,e){return this.orphanedDocuments.add(e),Fo.resolve()},Vc.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(function(t){t.forEach(function(t){return n.orphanedDocuments.add(t)})}).next(function(){return r.removeTargetData(t,e)})},Vc.prototype.onTransactionStarted=function(){this._orphanedDocuments=new Set},Vc.prototype.onTransactionCommitted=function(t){var n=this,r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Fo.forEach(this.orphanedDocuments,function(e){return n.isReferenced(t,e).next(function(t){t||r.removeEntry(e)})}).next(function(){return n._orphanedDocuments=null,r.apply(t)})},Vc.prototype.updateLimboDocument=function(t,e){var n=this;return this.isReferenced(t,e).next(function(t){t?n.orphanedDocuments.delete(e):n.orphanedDocuments.add(e)})},Vc.prototype.documentSize=function(t){return 0},Vc.prototype.isReferenced=function(t,e){var n=this;return Fo.or([function(){return n.persistence.getTargetCache().containsKey(t,e)},function(){return n.persistence.mutationQueuesContainKey(t,e)},function(){return Fo.resolve(n.inMemoryPins.containsKey(e))}])},Vc);function Vc(t){this.persistence=t,this.inMemoryPins=null,this._orphanedDocuments=null}var Bc=(Uc.prototype.onTransactionStarted=function(){},Uc.prototype.onTransactionCommitted=function(t){return Fo.resolve()},Uc.prototype.forEachTarget=function(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)},Uc.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocumentCount(t);return this.persistence.getTargetCache().getTargetCount(t).next(function(e){return n.next(function(t){return e+t})})},Uc.prototype.orphanedDocumentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},Uc.prototype.forEachOrphanedDocumentSequenceNumber=function(n,r){var i=this;return Fo.forEach(this.orphanedSequenceNumbers,function(t,e){return i.isPinned(n,t,e).next(function(t){return t?Fo.resolve():r(e)})})},Uc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},Uc.prototype.removeTargets=function(t,e,n){return this.persistence.getTargetCache().removeTargets(t,e,n)},Uc.prototype.removeOrphanedDocuments=function(t,n){var r=this,i=0,e=this.persistence.getRemoteDocumentCache(),o=e.newChangeBuffer();return e.forEachDocumentKey(t,function(e){return r.isPinned(t,e,n).next(function(t){t||(i++,o.removeEntry(e))})}).next(function(){return o.apply(t)}).next(function(){return i})},Uc.prototype.removeMutationReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Fo.resolve()},Uc.prototype.removeTarget=function(t,e){var n=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,n)},Uc.prototype.addReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Fo.resolve()},Uc.prototype.removeReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Fo.resolve()},Uc.prototype.updateLimboDocument=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Fo.resolve()},Uc.prototype.documentSize=function(t){var e,n=this.serializer.toDbRemoteDocument(t,t.version);if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw xr("Unknown remote document type");e=n.noDocument}return JSON.stringify(e).length},Uc.prototype.isPinned=function(t,e,n){var r=this;return Fo.or([function(){return r.persistence.mutationQueuesContainKey(t,e)},function(){return Fo.resolve(r.inMemoryPins.containsKey(e))},function(){return r.persistence.getTargetCache().containsKey(t,e)},function(){var t=r.orphanedSequenceNumbers.get(e);return Fo.resolve(void 0!==t&&n<t)}])},Uc.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},Uc);function Uc(t,e,n){this.persistence=t,this.serializer=e,this.inMemoryPins=null,this.orphanedSequenceNumbers=new Qs(function(t){return eo(t.path)}),this.garbageCollector=new Zu(this,n)}var Kc=(Qc.prototype.setLocalDocumentsView=function(t){this.localDocumentsView=t},Qc.prototype.getDocumentsMatchingQuery=function(t,e,n,r){return Fr(void 0!==this.localDocumentsView,"setLocalDocumentsView() not called"),this.localDocumentsView.getDocumentsMatchingQuery(t,e,so.MIN)},Qc);function Qc(){}var jc=Number,Wc=jc.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),Gc=jc.MAX_SAFE_INTEGER||Math.pow(2,53)-1,zc=jc.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function Hc(t){return null==t}function Yc(t){return zc(t)&&t<=Gc&&Wc<=t}var Xc=(Jc.prototype.reset=function(){this.currentBaseMs=0},Jc.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},Jc.prototype.backoffAndRun=function(t){var e=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);0<this.currentBaseMs&&_r("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return e.lastAttemptTime=Date.now(),t()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},Jc.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},Jc.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},Jc);function Jc(t,e,n,r,i){void 0===n&&(n=1e3),void 0===r&&(r=1.5),void 0===i&&(i=6e4),this.queue=t,this.timerId=e,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.currentBaseMs=0,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}var Zc,$c,th="PersistentStream";($c=Zc=Zc||{})[$c.Initial=0]="Initial",$c[$c.Starting=1]="Starting",$c[$c.Open=2]="Open",$c[$c.Error=3]="Error",$c[$c.Backoff=4]="Backoff";var eh=(nh.prototype.isStarted=function(){return this.state===Zc.Starting||this.state===Zc.Open||this.state===Zc.Backoff},nh.prototype.isOpen=function(){return this.state===Zc.Open},nh.prototype.start=function(){this.state!==Zc.Error?(Fr(this.state===Zc.Initial,"Already started"),this.auth()):this.performBackoff()},nh.prototype.stop=function(){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(Zc.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},nh.prototype.inhibitBackoff=function(){Fr(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Zc.Initial,this.backoff.reset()},nh.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return t.handleIdleCloseTimer()}))},nh.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},nh.prototype.handleIdleCloseTimer=function(){return d(this,void 0,void 0,function(){return m(this,function(t){return this.isOpen()?[2,this.close(Zc.Initial)]:[2]})})},nh.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},nh.prototype.close=function(e,n){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return Fr(this.isStarted(),"Only started streams should be closed."),Fr(e===Zc.Error||Hc(n),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,e!==Zc.Error?this.backoff.reset():n&&n.code===Kr.RESOURCE_EXHAUSTED?(Lr(n.toString()),Lr("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):n&&n.code===Kr.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=e,[4,this.listener.onClose(n)];case 1:return t.sent(),[2]}})})},nh.prototype.tearDown=function(){},nh.prototype.auth=function(){var n=this;Fr(this.state===Zc.Initial,"Must be in initial state to auth"),this.state=Zc.Starting;var t=this.getCloseGuardedDispatcher(this.closeCount),e=this.closeCount;this.credentialsProvider.getToken().then(function(t){n.closeCount===e&&n.startStream(t)},function(e){t(function(){var t=new Qr(Kr.UNKNOWN,"Fetching auth token failed: "+e.message);return n.handleStreamClose(t)})})},nh.prototype.startStream=function(t){var e=this;Fr(this.state===Zc.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen(function(){n(function(){return Fr(e.state===Zc.Starting,"Expected stream to be in state Starting, but was "+e.state),e.state=Zc.Open,e.listener.onOpen()})}),this.stream.onClose(function(t){n(function(){return e.handleStreamClose(t)})}),this.stream.onMessage(function(t){n(function(){return e.onMessage(t)})})},nh.prototype.performBackoff=function(){var t=this;Fr(this.state===Zc.Error,"Should only perform backoff when in Error state"),this.state=Zc.Backoff,this.backoff.backoffAndRun(function(){return d(t,void 0,void 0,function(){return m(this,function(t){return Fr(this.state===Zc.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Zc.Initial,this.start(),Fr(this.isStarted(),"PersistentStream should have started"),[2]})})})},nh.prototype.handleStreamClose=function(t){return Fr(this.isStarted(),"Can't handle server close on non-started stream"),_r(th,"close with error: "+t),this.stream=null,this.close(Zc.Error,t)},nh.prototype.getCloseGuardedDispatcher=function(e){var n=this;return function(t){n.queue.enqueueAndForget(function(){return n.closeCount===e?t():(_r(th,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},nh);function nh(t,e,n,r,i,o){this.queue=t,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=Zc.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new Xc(t,e)}var rh,ih=(s(oh,rh=eh),oh.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},oh.prototype.onMessage=function(t){this.backoff.reset();var e=this.serializer.fromWatchChange(t),n=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(e,n)},oh.prototype.watch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.addTarget=this.serializer.toTarget(t);var n=this.serializer.toListenRequestLabels(t);n&&(e.labels=n),this.sendRequest(e)},oh.prototype.unwatch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.removeTarget=t,this.sendRequest(e)},oh);function oh(t,e,n,r,i){var o=rh.call(this,t,ji.ListenStreamConnectionBackoff,ji.ListenStreamIdle,e,n,i)||this;return o.serializer=r,o}var ah,sh=(s(uh,ah=eh),Object.defineProperty(uh.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),uh.prototype.start=function(){this.handshakeComplete_=!1,ah.prototype.start.call(this)},uh.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},uh.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},uh.prototype.onMessage=function(t){if(Fr(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var e=this.serializer.fromWriteResults(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(n,e)}return Fr(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},uh.prototype.writeHandshake=function(){Fr(this.isOpen(),"Writing handshake requires an opened stream"),Fr(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},uh.prototype.writeMutations=function(t){var e=this;Fr(this.isOpen(),"Writing mutations requires an opened stream"),Fr(this.handshakeComplete_,"Handshake must be complete before writing mutations"),Fr(0<this.lastStreamToken.length,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:t.map(function(t){return e.serializer.toMutation(t)})};this.sendRequest(n)},uh);function uh(t,e,n,r,i){var o=ah.call(this,t,ji.WriteStreamConnectionBackoff,ji.WriteStreamIdle,e,n,i)||this;return o.serializer=r,o.handshakeComplete_=!1,o.lastStreamToken=Br(),o}var ch=(hh.prototype.newPersistentWriteStream=function(t){return new sh(this.queue,this.connection,this.credentials,this.serializer,t)},hh.prototype.newPersistentWatchStream=function(t){return new ih(this.queue,this.connection,this.credentials,this.serializer,t)},hh.prototype.commit=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,writes:t.map(function(t){return e.serializer.toMutation(t)})};return this.invokeRPC("Commit",n).then(function(t){return e.serializer.fromWriteResults(t.writeResults,t.commitTime)})},hh.prototype.lookup=function(e){var i=this,t={database:this.serializer.encodedDatabaseId,documents:e.map(function(t){return i.serializer.toName(t)})};return this.invokeStreamingRPC("BatchGetDocuments",t).then(function(t){var n=Eo();t.forEach(function(t){var e=i.serializer.fromMaybeDocument(t);n=n.insert(e.key,e)});var r=[];return e.forEach(function(t){var e=n.get(t);Fr(!!e,"Missing entity in write response for "+t),r.push(e)}),r})},hh.prototype.invokeRPC=function(e,n){var r=this;return this.credentials.getToken().then(function(t){return r.connection.invokeRPC(e,n,t)}).catch(function(t){throw t.code===Kr.UNAUTHENTICATED&&r.credentials.invalidateToken(),t})},hh.prototype.invokeStreamingRPC=function(e,n){var r=this;return this.credentials.getToken().then(function(t){return r.connection.invokeStreamingRPC(e,n,t)}).catch(function(t){throw t.code===Kr.UNAUTHENTICATED&&r.credentials.invalidateToken(),t})},hh);function hh(t,e,n,r){this.queue=t,this.connection=e,this.credentials=n,this.serializer=r}var lh,fh,dh,ph,mh=(yh.prototype.lookup=function(r){return d(this,void 0,void 0,function(){var e,n=this;return m(this,function(t){switch(t.label){case 0:if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Qr(Kr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,this.datastore.lookup(r)];case 1:return(e=t.sent()).forEach(function(t){t instanceof qs||t instanceof Ps?n.recordVersion(t):xr("Document in a transaction was a "+t.constructor.name)}),[2,e]}})})},yh.prototype.set=function(t,e){this.write(e.toMutations(t,this.precondition(t))),this.writtenDocs.add(t)},yh.prototype.update=function(t,e){try{this.write(e.toMutations(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t)},yh.prototype.delete=function(t){this.write([new Ba(t,this.precondition(t))]),this.writtenDocs.add(t)},yh.prototype.commit=function(){return d(this,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;if(e=this.readVersions,this.mutations.forEach(function(t){e=e.remove(t.key)}),!e.isEmpty())throw new Qr(Kr.INVALID_ARGUMENT,"Every document read in a transaction must also be written.");return[4,this.datastore.commit(this.mutations)];case 1:return t.sent(),this.committed=!0,[2]}})})},yh.prototype.recordVersion=function(t){var e;if(t instanceof Ps)e=t.version;else{if(!(t instanceof qs))throw xr("Document in a transaction was a "+t.constructor.name);e=so.forDeletedDoc()}var n=this.readVersions.get(t.key);if(null!==n){if(!e.isEqual(n))throw new Qr(Kr.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,e)},yh.prototype.precondition=function(t){var e=this.readVersions.get(t);return!this.writtenDocs.has(t)&&e?Sa.updateTime(e):Sa.NONE},yh.prototype.preconditionForUpdate=function(t){var e=this.readVersions.get(t);if(this.writtenDocs.has(t)||!e)return Sa.exists(!0);if(e.isEqual(so.forDeletedDoc()))throw new Qr(Kr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Sa.updateTime(e)},yh.prototype.write=function(t){this.ensureCommitNotCalled(),this.mutations=this.mutations.concat(t)},yh.prototype.ensureCommitNotCalled=function(){Fr(!this.committed,"A transaction object cannot be used after its update callback has been invoked.")},yh);function yh(t){this.datastore=t,this.readVersions=Ao(),this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}(fh=lh=lh||{})[fh.Unknown=0]="Unknown",fh[fh.Online=1]="Online",fh[fh.Offline=2]="Offline",(ph=dh=dh||{})[ph.RemoteStore=0]="RemoteStore",ph[ph.SharedClientState=1]="SharedClientState";var gh,vh,bh=(wh.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(lh.Unknown),Fr(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(ji.OnlineStateTimeout,1e4,function(){return t.onlineStateTimer=null,Fr(t.state===lh.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(lh.Offline),Promise.resolve()}))},wh.prototype.handleWatchStreamFailure=function(t){this.state===lh.Online?(this.setAndBroadcast(lh.Unknown),Fr(0===this.watchStreamFailures,"watchStreamFailures must be 0"),Fr(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,1<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(lh.Offline)))},wh.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===lh.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},wh.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},wh.prototype.logClientOfflineWarningIfNecessary=function(t){var e="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(Lr(e),this.shouldWarnClientIsOffline=!1):_r("OnlineStateTracker",e)},wh.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},wh);function wh(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state=lh.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}function Th(t){switch(t){case Kr.OK:return xr("Treated status OK as error");case Kr.CANCELLED:case Kr.UNKNOWN:case Kr.DEADLINE_EXCEEDED:case Kr.RESOURCE_EXHAUSTED:case Kr.INTERNAL:case Kr.UNAVAILABLE:case Kr.UNAUTHENTICATED:return!1;case Kr.INVALID_ARGUMENT:case Kr.NOT_FOUND:case Kr.ALREADY_EXISTS:case Kr.PERMISSION_DENIED:case Kr.FAILED_PRECONDITION:case Kr.ABORTED:case Kr.OUT_OF_RANGE:case Kr.UNIMPLEMENTED:case Kr.DATA_LOSS:return!0;default:return xr("Unknown status code: "+t)}}function Sh(t){if(void 0===t)return Lr("GRPC error has no .code"),Kr.UNKNOWN;switch(t){case gh.OK:return Kr.OK;case gh.CANCELLED:return Kr.CANCELLED;case gh.UNKNOWN:return Kr.UNKNOWN;case gh.DEADLINE_EXCEEDED:return Kr.DEADLINE_EXCEEDED;case gh.RESOURCE_EXHAUSTED:return Kr.RESOURCE_EXHAUSTED;case gh.INTERNAL:return Kr.INTERNAL;case gh.UNAVAILABLE:return Kr.UNAVAILABLE;case gh.UNAUTHENTICATED:return Kr.UNAUTHENTICATED;case gh.INVALID_ARGUMENT:return Kr.INVALID_ARGUMENT;case gh.NOT_FOUND:return Kr.NOT_FOUND;case gh.ALREADY_EXISTS:return Kr.ALREADY_EXISTS;case gh.PERMISSION_DENIED:return Kr.PERMISSION_DENIED;case gh.FAILED_PRECONDITION:return Kr.FAILED_PRECONDITION;case gh.ABORTED:return Kr.ABORTED;case gh.OUT_OF_RANGE:return Kr.OUT_OF_RANGE;case gh.UNIMPLEMENTED:return Kr.UNIMPLEMENTED;case gh.DATA_LOSS:return Kr.DATA_LOSS;default:return xr("Unknown status code: "+t)}}(vh=gh=gh||{})[vh.OK=0]="OK",vh[vh.CANCELLED=1]="CANCELLED",vh[vh.UNKNOWN=2]="UNKNOWN",vh[vh.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",vh[vh.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",vh[vh.NOT_FOUND=5]="NOT_FOUND",vh[vh.ALREADY_EXISTS=6]="ALREADY_EXISTS",vh[vh.PERMISSION_DENIED=7]="PERMISSION_DENIED",vh[vh.UNAUTHENTICATED=16]="UNAUTHENTICATED",vh[vh.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",vh[vh.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",vh[vh.ABORTED=10]="ABORTED",vh[vh.OUT_OF_RANGE=11]="OUT_OF_RANGE",vh[vh.UNIMPLEMENTED=12]="UNIMPLEMENTED",vh[vh.INTERNAL=13]="INTERNAL",vh[vh.UNAVAILABLE=14]="UNAVAILABLE",vh[vh.DATA_LOSS=15]="DATA_LOSS";var Eh,Ih,Ch,Dh,Nh=(Ah.emptySet=function(t){return new Ah(t.comparator)},Ah.prototype.has=function(t){return null!=this.keyedMap.get(t)},Ah.prototype.get=function(t){return this.keyedMap.get(t)},Ah.prototype.first=function(){return this.sortedSet.minKey()},Ah.prototype.last=function(){return this.sortedSet.maxKey()},Ah.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},Ah.prototype.indexOf=function(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1},Object.defineProperty(Ah.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),Ah.prototype.forEach=function(n){this.sortedSet.inorderTraversal(function(t,e){return n(t),!1})},Ah.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},Ah.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},Ah.prototype.isEqual=function(t){if(!(t instanceof Ah))return!1;if(this.size!==t.size)return!1;for(var e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(!r.isEqual(i))return!1}return!0},Ah.prototype.toString=function(){var e=[];return this.forEach(function(t){e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"},Ah.prototype.copy=function(t,e){var n=new Ah;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n},Ah);function Ah(n){this.comparator=n?function(t,e){return n(t,e)||Ki.comparator(t.key,e.key)}:function(t,e){return Ki.comparator(t.key,e.key)},this.keyedMap=Do(),this.sortedSet=new co(this.comparator)}(Ih=Eh=Eh||{})[Ih.Added=0]="Added",Ih[Ih.Removed=1]="Removed",Ih[Ih.Modified=2]="Modified",Ih[Ih.Metadata=3]="Metadata",(Dh=Ch=Ch||{})[Dh.Local=0]="Local",Dh[Dh.Synced=1]="Synced";var kh=(Rh.prototype.track=function(t){var e=t.doc.key,n=this.changeMap.get(e);n?t.type!==Eh.Added&&n.type===Eh.Metadata?this.changeMap=this.changeMap.insert(e,t):t.type===Eh.Metadata&&n.type!==Eh.Removed?this.changeMap=this.changeMap.insert(e,{type:n.type,doc:t.doc}):t.type===Eh.Modified&&n.type===Eh.Modified?this.changeMap=this.changeMap.insert(e,{type:Eh.Modified,doc:t.doc}):t.type===Eh.Modified&&n.type===Eh.Added?this.changeMap=this.changeMap.insert(e,{type:Eh.Added,doc:t.doc}):t.type===Eh.Removed&&n.type===Eh.Added?this.changeMap=this.changeMap.remove(e):t.type===Eh.Removed&&n.type===Eh.Modified?this.changeMap=this.changeMap.insert(e,{type:Eh.Removed,doc:n.doc}):t.type===Eh.Added&&n.type===Eh.Removed?this.changeMap=this.changeMap.insert(e,{type:Eh.Modified,doc:t.doc}):xr("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n)):this.changeMap=this.changeMap.insert(e,t)},Rh.prototype.getChanges=function(){var n=[];return this.changeMap.inorderTraversal(function(t,e){n.push(e)}),n},Rh);function Rh(){this.changeMap=new co(Ki.comparator)}var Mh=(Oh.fromInitialDocuments=function(t,e,n,r){var i=[];return e.forEach(function(t){i.push({type:Eh.Added,doc:t})}),new Oh(t,e,Nh.emptySet(e),i,n,r,!0,!1)},Object.defineProperty(Oh.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),Oh.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},Oh);function Oh(t,e,n,r,i,o,a,s){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}var _h=(Lh.createSynthesizedRemoteEventForCurrentChange=function(t,e){var n,r=((n={})[t]=Ph.createSynthesizedTargetChangeForCurrentChange(t,e),n);return new Lh(so.MIN,r,Oo(),Eo(),Ro())},Lh);function Lh(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}var Ph=(xh.createSynthesizedTargetChangeForCurrentChange=function(t,e){return new xh(Br(),e,Ro(),Ro(),Ro())},xh);function xh(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}var Fh,qh,Vh=function(t,e,n,r){this.updatedTargetIds=t,this.removedTargetIds=e,this.key=n,this.newDoc=r},Bh=function(t,e){this.targetId=t,this.existenceFilter=e};(qh=Fh=Fh||{})[qh.NoChange=0]="NoChange",qh[qh.Added=1]="Added",qh[qh.Removed=2]="Removed",qh[qh.Current=3]="Current",qh[qh.Reset=4]="Reset";var Uh=function(t,e,n,r){void 0===n&&(n=Br()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r},Kh=(Object.defineProperty(Qh.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(Qh.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(Qh.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(Qh.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),Qh.prototype.updateResumeToken=function(t){0<t.length&&(this._hasPendingChanges=!0,this._resumeToken=t)},Qh.prototype.toTargetChange=function(){var n=Ro(),r=Ro(),i=Ro();return this.documentChanges.forEach(function(t,e){switch(e){case Eh.Added:n=n.add(t);break;case Eh.Modified:r=r.add(t);break;case Eh.Removed:i=i.add(t);break;default:xr("Encountered invalid change type: "+e)}}),new Ph(this._resumeToken,this._current,n,r,i)},Qh.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=zh()},Qh.prototype.addDocumentChange=function(t,e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,e)},Qh.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},Qh.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},Qh.prototype.recordTargetResponse=function(){this.pendingResponses-=1},Qh.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},Qh);function Qh(){this.pendingResponses=0,this.documentChanges=zh(),this._resumeToken=Br(),this._current=!1,this._hasPendingChanges=!0}var jh=(Wh.prototype.handleDocumentChange=function(t){for(var e=0,n=t.updatedTargetIds;e<n.length;e++){var r=n[e];t.newDoc instanceof Ps?this.addDocumentToTarget(r,t.newDoc):t.newDoc instanceof qs&&this.removeDocumentFromTarget(r,t.key,t.newDoc)}for(var i=0,o=t.removedTargetIds;i<o.length;i++)r=o[i],this.removeDocumentFromTarget(r,t.key,t.newDoc)},Wh.prototype.handleTargetChange=function(n){var r=this;this.forEachTarget(n,function(t){var e=r.ensureTargetState(t);switch(n.state){case Fh.NoChange:r.isActiveTarget(t)&&e.updateResumeToken(n.resumeToken);break;case Fh.Added:e.recordTargetResponse(),e.isPending||e.clearPendingChanges(),e.updateResumeToken(n.resumeToken);break;case Fh.Removed:e.recordTargetResponse(),e.isPending||r.removeTarget(t),Fr(!n.cause,"WatchChangeAggregator does not handle errored targets");break;case Fh.Current:r.isActiveTarget(t)&&(e.markCurrent(),e.updateResumeToken(n.resumeToken));break;case Fh.Reset:r.isActiveTarget(t)&&(r.resetTarget(t),e.updateResumeToken(n.resumeToken));break;default:xr("Unknown target watch change state: "+n.state)}})},Wh.prototype.forEachTarget=function(t,e){0<t.targetIds.length?t.targetIds.forEach(e):Hr(this.targetStates,e)},Wh.prototype.handleExistenceFilter=function(t){var e=t.targetId,n=t.existenceFilter.count,r=this.targetDataForActiveTarget(e);if(r){var i=r.target;if(i.isDocumentQuery())if(0===n){var o=new Ki(i.path);this.removeDocumentFromTarget(e,o,new qs(o,so.forDeletedDoc()))}else Fr(1===n,"Single document existence filter with count: "+n);else this.getCurrentDocumentCountForTarget(e)!==n&&(this.resetTarget(e),this.pendingTargetResets=this.pendingTargetResets.add(e))}},Wh.prototype.createRemoteEvent=function(i){var o=this,a={};Hr(this.targetStates,function(t,e){var n=o.targetDataForActiveTarget(t);if(n){if(e.current&&n.target.isDocumentQuery()){var r=new Ki(n.target.path);null!==o.pendingDocumentUpdates.get(r)||o.targetContainsDocument(t,r)||o.removeDocumentFromTarget(t,r,new qs(r,i))}e.hasPendingChanges&&(a[t]=e.toTargetChange(),e.clearPendingChanges())}});var r=Ro();this.pendingDocumentTargetMapping.forEach(function(t,e){var n=!0;e.forEachWhile(function(t){var e=o.targetDataForActiveTarget(t);return!e||e.purpose===Lu.LimboResolution||(n=!1)}),n&&(r=r.add(t))});var t=new _h(i,a,this.pendingTargetResets,this.pendingDocumentUpdates,r);return this.pendingDocumentUpdates=Eo(),this.pendingDocumentTargetMapping=Gh(),this.pendingTargetResets=new vo(vi),t},Wh.prototype.addDocumentToTarget=function(t,e){if(this.isActiveTarget(t)){var n=this.targetContainsDocument(t,e.key)?Eh.Modified:Eh.Added;this.ensureTargetState(t).addDocumentChange(e.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e.key,e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e.key,this.ensureDocumentTargetMapping(e.key).add(t))}},Wh.prototype.removeDocumentFromTarget=function(t,e,n){if(this.isActiveTarget(t)){var r=this.ensureTargetState(t);this.targetContainsDocument(t,e)?r.addDocumentChange(e,Eh.Removed):r.removeDocumentChange(e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,this.ensureDocumentTargetMapping(e).delete(t)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e,n))}},Wh.prototype.removeTarget=function(t){delete this.targetStates[t]},Wh.prototype.getCurrentDocumentCountForTarget=function(t){var e=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},Wh.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},Wh.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new Kh),this.targetStates[t]},Wh.prototype.ensureDocumentTargetMapping=function(t){var e=this.pendingDocumentTargetMapping.get(t);return e||(e=new vo(vi),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,e)),e},Wh.prototype.isActiveTarget=function(t){var e=null!==this.targetDataForActiveTarget(t);return e||_r("WatchChangeAggregator","Detected inactive target",t),e},Wh.prototype.targetDataForActiveTarget=function(t){var e=this.targetStates[t];return e&&e.isPending?null:this.metadataProvider.getTargetDataForTarget(t)},Wh.prototype.resetTarget=function(e){var n=this;Fr(!this.targetStates[e].isPending,"Should only reset active targets"),this.targetStates[e]=new Kh,this.metadataProvider.getRemoteKeysForTarget(e).forEach(function(t){n.removeDocumentFromTarget(e,t,null)})},Wh.prototype.targetContainsDocument=function(t,e){return this.metadataProvider.getRemoteKeysForTarget(t).has(e)},Wh);function Wh(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=Eo(),this.pendingDocumentTargetMapping=Gh(),this.pendingTargetResets=new vo(vi)}function Gh(){return new co(Ki.comparator)}function zh(){return new co(Ki.comparator)}var Hh="RemoteStore",Yh=(Xh.prototype.start=function(){return this.enableNetwork()},Xh.prototype.enableNetwork=function(){return d(this,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(e=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return e.lastStreamToken=t.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(lh.Unknown),[4,this.fillWritePipeline()];case 2:t.sent(),t.label=3;case 3:return[2]}})})},Xh.prototype.disableNetwork=function(){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(lh.Offline),[2]}})})},Xh.prototype.disableNetworkInternal=function(){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),0<this.writePipeline.length&&(_r(Hh,"Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},Xh.prototype.shutdown=function(){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return _r(Hh,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.connectivityMonitor.shutdown(),this.onlineStateTracker.set(lh.Unknown),[2]}})})},Xh.prototype.listen=function(t){Gr(this.listenTargets,t.targetId)||(this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t))},Xh.prototype.unlisten=function(t){Gr(this.listenTargets,t)&&(delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),Xr(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(lh.Unknown)))},Xh.prototype.getTargetDataForTarget=function(t){return this.listenTargets[t]||null},Xh.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},Xh.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},Xh.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},Xh.prototype.startWatchStream=function(){Fr(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new jh(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},Xh.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!Xr(this.listenTargets)},Xh.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},Xh.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},Xh.prototype.onWatchStreamOpen=function(){return d(this,void 0,void 0,function(){var n=this;return m(this,function(t){return Hr(this.listenTargets,function(t,e){n.sendWatchRequest(e)}),[2]})})},Xh.prototype.onWatchStreamClose=function(e){return d(this,void 0,void 0,function(){return m(this,function(t){return void 0===e&&Fr(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(e),this.startWatchStream()):this.onlineStateTracker.set(lh.Unknown),[2]})})},Xh.prototype.onWatchStreamChange=function(n,r){return d(this,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:return this.onlineStateTracker.set(lh.Online),n instanceof Uh&&n.state===Fh.Removed&&n.cause?[2,this.handleTargetError(n)]:(n instanceof Vh?this.watchChangeAggregator.handleDocumentChange(n):n instanceof Bh?this.watchChangeAggregator.handleExistenceFilter(n):(Fr(n instanceof Uh,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(n)),r.isEqual(so.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return e=t.sent(),0<=r.compareTo(e)?[4,this.raiseWatchSnapshot(r)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},Xh.prototype.raiseWatchSnapshot=function(r){var i=this;Fr(!r.isEqual(so.MIN),"Can't raise event for unknown SnapshotVersion");var t=this.watchChangeAggregator.createRemoteEvent(r);return Hr(t.targetChanges,function(t,e){if(0<e.resumeToken.length){var n=i.listenTargets[t];n&&(i.listenTargets[t]=n.withResumeToken(e.resumeToken,r))}}),t.targetMismatches.forEach(function(t){var e=i.listenTargets[t];if(e){i.listenTargets[t]=e.withResumeToken(Br(),e.snapshotVersion),i.sendUnwatchRequest(t);var n=new Bu(e.target,t,Lu.ExistenceFilterMismatch,e.sequenceNumber);i.sendWatchRequest(n)}}),this.syncEngine.applyRemoteEvent(t)},Xh.prototype.handleTargetError=function(t){var n=this;Fr(!!t.cause,"Handling target error without a cause");var r=t.cause,i=Promise.resolve();return t.targetIds.forEach(function(e){i=i.then(function(){return d(n,void 0,void 0,function(){return m(this,function(t){return Gr(this.listenTargets,e)?(delete this.listenTargets[e],this.watchChangeAggregator.removeTarget(e),[2,this.syncEngine.rejectListen(e,r)]):[2]})})})}),i},Xh.prototype.fillWritePipeline=function(){return d(this,void 0,void 0,function(){var e,n;return m(this,function(t){switch(t.label){case 0:return this.canAddToWritePipeline()?(e=0<this.writePipeline.length?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(e)]):[3,4];case 1:return null!==(n=t.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(n),[4,this.fillWritePipeline()];case 3:t.sent(),t.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},Xh.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},Xh.prototype.outstandingWrites=function(){return this.writePipeline.length},Xh.prototype.addToWritePipeline=function(t){Fr(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},Xh.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&0<this.writePipeline.length},Xh.prototype.startWriteStream=function(){Fr(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},Xh.prototype.onWriteStreamOpen=function(){return d(this,void 0,void 0,function(){return m(this,function(t){return this.writeStream.writeHandshake(),[2]})})},Xh.prototype.onWriteHandshakeComplete=function(){var r=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var t=0,e=r.writePipeline;t<e.length;t++){var n=e[t];r.writeStream.writeMutations(n.mutations)}}).catch(hc)},Xh.prototype.onMutationResult=function(t,e){var n=this;Fr(0<this.writePipeline.length,"Got result for empty write pipeline");var r=this.writePipeline.shift(),i=Po.from(r,t,e,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(i).then(function(){return n.fillWritePipeline()})},Xh.prototype.onWriteStreamClose=function(n){return d(this,void 0,void 0,function(){var e=this;return m(this,function(t){return void 0===n&&Fr(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),n&&0<this.writePipeline.length?[2,(this.writeStream.handshakeComplete?this.handleWriteError(n):this.handleHandshakeError(n)).then(function(){e.shouldStartWriteStream()&&e.startWriteStream()})]:[2]})})},Xh.prototype.handleHandshakeError=function(e){return d(this,void 0,void 0,function(){return m(this,function(t){return Th(e.code)?(_r(Hh,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=Br(),[2,this.localStore.setLastStreamToken(Br()).catch(hc)]):[2]})})},Xh.prototype.handleWriteError=function(r){return d(this,void 0,void 0,function(){var e,n=this;return m(this,function(t){return function(t){return Th(t)&&t!==Kr.ABORTED}(r.code)?(e=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(e.batchId,r).then(function(){return n.fillWritePipeline()})]):[2]})})},Xh.prototype.createTransaction=function(){return new mh(this.datastore)},Xh.prototype.restartNetwork=function(){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(lh.Unknown),[4,this.enableNetwork()];case 2:return t.sent(),[2]}})})},Xh.prototype.handleCredentialChange=function(){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(_r(Hh,"RemoteStore restarting streams for new credential"),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},Xh.prototype.applyPrimaryState=function(e){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return(this.isPrimary=e)&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return t.sent(),[3,4];case 2:return e?[3,4]:[4,this.disableNetworkInternal()];case 3:t.sent(),this.onlineStateTracker.set(lh.Unknown),t.label=4;case 4:return[2]}})})},Xh);function Xh(t,e,n,r,i){var o=this;this.localStore=t,this.datastore=e,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.connectivityMonitor=i,this.connectivityMonitor.addCallback(function(t){n.enqueueAndForget(function(){return d(o,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(_r(Hh,"Restarting streams for network reachability change."),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})})}),this.onlineStateTracker=new bh(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}var Jh=(Object.defineProperty(Zh.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(Zh.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),Zh.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},Zh.prototype._compareTo=function(t){return vi(this._lat,t._lat)||vi(this._long,t._long)},Zh);function Zh(t,e){if(Zr("GeoPoint",arguments,2),ei("GeoPoint","number",1,t),ei("GeoPoint","number",2,e),!isFinite(t)||t<-90||90<t)throw new Qr(Kr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||180<e)throw new Qr(Kr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}var $h,tl,el=(nl.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();null!==this.collectionGroup&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var e=0,n=this.filters;e<n.length;e++)t+=n[e].canonicalId(),t+=",";t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++)t+=i[r].canonicalId(),t+=",";Hc(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},nl.prototype.toString=function(){var t=this.path.canonicalString();return null!==this.collectionGroup&&(t+=" collectionGroup="+this.collectionGroup),0<this.filters.length&&(t+=", filters: ["+this.filters.join(", ")+"]"),Hc(this.limit)||(t+=", limit: "+this.limit),0<this.orderBy.length&&(t+=", orderBy: ["+this.orderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),"Target("+t+")"},nl.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&!!this.path.isEqual(t.path)&&!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)},nl.prototype.isDocumentQuery=function(){return Ki.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},nl);function nl(t,e,n,r,i,o,a){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null}(tl=$h=$h||{}).First="F",tl.Last="L";var rl=(il.atPath=function(t){return new il(t)},Object.defineProperty(il.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),e=this.getFirstOrderByField();if(null!==t&&null===e)t.isKeyField()?this.memoizedOrderBy=[Ol]:this.memoizedOrderBy=[new Rl(t),Ol];else{Fr(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field.");for(var n=!(this.memoizedOrderBy=[]),r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}if(!n){var a=0<this.explicitOrderBy.length?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Dl.ASCENDING;this.memoizedOrderBy.push(a===Dl.ASCENDING?Ol:_l)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),il.prototype.addFilter=function(t){Fr(null==this.getInequalityFilterField()||!(t instanceof cl)||!t.isInequality()||t.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),Fr(!this.isDocumentQuery(),"No filtering allowed for document query");var e=this.filters.concat([t]);return new il(this.path,this.collectionGroup,this.explicitOrderBy.slice(),e,this.limit,this.limitType,this.startAt,this.endAt)},il.prototype.addOrderBy=function(t){Fr(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var e=this.explicitOrderBy.concat([t]);return new il(this.path,this.collectionGroup,e,this.filters.slice(),this.limit,this.limitType,this.startAt,this.endAt)},il.prototype.withLimitToFirst=function(t){return new il(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),t,$h.First,this.startAt,this.endAt)},il.prototype.withLimitToLast=function(t){return new il(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),t,$h.Last,this.startAt,this.endAt)},il.prototype.withStartAt=function(t){return new il(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.limitType,t,this.endAt)},il.prototype.withEndAt=function(t){return new il(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.limitType,this.startAt,t)},il.prototype.asCollectionQueryAtPath=function(t){return new il(t,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.limitType,this.startAt,this.endAt)},il.prototype.matchesAllDocuments=function(){return 0===this.filters.length&&null===this.limit&&null==this.startAt&&null==this.endAt&&(0===this.explicitOrderBy.length||1===this.explicitOrderBy.length&&this.explicitOrderBy[0].field.isKeyField())},il.prototype.canonicalId=function(){return this.toTarget().canonicalId()+"|lt:"+this.limitType},il.prototype.toString=function(){return"Query(target="+this.toTarget().toString()+"; limitType="+this.limitType+")"},il.prototype.isEqual=function(t){return this.toTarget().isEqual(t.toTarget())&&this.limitType===t.limitType},il.prototype.docComparator=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(t,e);if(0!==a)return a;n=n||o.field.isKeyField()}return Fr(n,"orderBy used that doesn't compare on key field"),0},il.prototype.matches=function(t){return this.matchesPathAndCollectionGroup(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},il.prototype.hasLimitToFirst=function(){return!Hc(this.limit)&&this.limitType===$h.First},il.prototype.hasLimitToLast=function(){return!Hc(this.limit)&&this.limitType===$h.Last},il.prototype.getFirstOrderByField=function(){return 0<this.explicitOrderBy.length?this.explicitOrderBy[0].field:null},il.prototype.getInequalityFilterField=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof cl&&n.isInequality())return n.field}return null},il.prototype.findFilterOperator=function(t){for(var e=0,n=this.filters;e<n.length;e++){var r=n[e];if(r instanceof cl&&0<=t.indexOf(r.op))return r.op}return null},il.prototype.isDocumentQuery=function(){return this.toTarget().isDocumentQuery()},il.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},il.prototype.toTarget=function(){if(!this.memorizedTarget)if(this.limitType===$h.First)this.memorizedTarget=new el(this.path,this.collectionGroup,this.orderBy,this.filters,this.limit,this.startAt,this.endAt);else{for(var t=[],e=0,n=this.orderBy;e<n.length;e++){var r=n[e],i=r.dir===Dl.DESCENDING?Dl.ASCENDING:Dl.DESCENDING;t.push(new Rl(r.field,i))}var o=this.endAt?new Al(this.endAt.position,!this.endAt.before):null,a=this.startAt?new Al(this.startAt.position,!this.startAt.before):null;this.memorizedTarget=new el(this.path,this.collectionGroup,t,this.filters,this.limit,o,a)}return this.memorizedTarget},il.prototype.matchesPathAndCollectionGroup=function(t){var e=t.key.path;return null!==this.collectionGroup?t.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(e):Ki.isDocumentKey(this.path)?this.path.isEqual(e):this.path.isImmediateParentOf(e)},il.prototype.matchesOrderBy=function(t){for(var e=0,n=this.explicitOrderBy;e<n.length;e++){var r=n[e];if(!r.field.isKeyField()&&null===t.field(r.field))return!1}return!0},il.prototype.matchesFilters=function(t){for(var e=0,n=this.filters;e<n.length;e++)if(!n[e].matches(t))return!1;return!0},il.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t)||this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,t))},il.prototype.assertValidBound=function(t){Fr(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},il);function il(t,e,n,r,i,o,a,s){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=$h.First),void 0===a&&(a=null),void 0===s&&(s=null),this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=o,this.startAt=a,this.endAt=s,this.memoizedOrderBy=null,this.memorizedTarget=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}function ol(){}var al=(sl.fromString=function(t){switch(t){case"<":return sl.LESS_THAN;case"<=":return sl.LESS_THAN_OR_EQUAL;case"==":return sl.EQUAL;case">=":return sl.GREATER_THAN_OR_EQUAL;case">":return sl.GREATER_THAN;case"array-contains":return sl.ARRAY_CONTAINS;case"in":return sl.IN;case"array-contains-any":return sl.ARRAY_CONTAINS_ANY;default:return xr("Unknown FieldFilter operator: "+t)}},sl.prototype.toString=function(){return this.name},sl.prototype.isEqual=function(t){return this.name===t.name},sl.LESS_THAN=new sl("<"),sl.LESS_THAN_OR_EQUAL=new sl("<="),sl.EQUAL=new sl("=="),sl.GREATER_THAN=new sl(">"),sl.GREATER_THAN_OR_EQUAL=new sl(">="),sl.ARRAY_CONTAINS=new sl("array-contains"),sl.IN=new sl("in"),sl.ARRAY_CONTAINS_ANY=new sl("array-contains-any"),sl);function sl(t){this.name=t}var ul,cl=(s(hl,ul=ol),hl.create=function(t,e,n){if(t.isKeyField())return e===al.IN?(Fr(n instanceof Rs,"Comparing on key with IN, but filter value not an ArrayValue"),Fr(n.internalValue.every(function(t){return t instanceof Ts}),"Comparing on key with IN, but an array value was not a RefValue"),new ml(t,n)):(Fr(n instanceof Ts,"Comparing on key, but filter value not a RefValue"),Fr(e!==al.ARRAY_CONTAINS&&e!==al.ARRAY_CONTAINS_ANY,"'"+e.toString()+"' queries don't make sense on document keys."),new fl(t,e,n));if(n.isEqual(za.INSTANCE)){if(e!==al.EQUAL)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. Null supports only equality comparisons.");return new hl(t,e,n)}if(n.isEqual(as.NAN)){if(e!==al.EQUAL)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. NaN supports only equality comparisons.");return new hl(t,e,n)}return e===al.ARRAY_CONTAINS?new vl(t,n):e===al.IN?(Fr(n instanceof Rs,"IN filter has invalid value: "+n.toString()),new Tl(t,n)):e===al.ARRAY_CONTAINS_ANY?(Fr(n instanceof Rs,"ARRAY_CONTAINS_ANY filter has invalid value: "+n.toString()),new Il(t,n)):new hl(t,e,n)},hl.prototype.matches=function(t){var e=t.field(this.field);return null!==e&&this.value.typeOrder===e.typeOrder&&this.matchesComparison(e.compareTo(this.value))},hl.prototype.matchesComparison=function(t){switch(this.op){case al.LESS_THAN:return t<0;case al.LESS_THAN_OR_EQUAL:return t<=0;case al.EQUAL:return 0===t;case al.GREATER_THAN:return 0<t;case al.GREATER_THAN_OR_EQUAL:return 0<=t;default:return xr("Unknown FieldFilter operator: "+this.op)}},hl.prototype.isInequality=function(){return 0<=[al.LESS_THAN,al.LESS_THAN_OR_EQUAL,al.GREATER_THAN,al.GREATER_THAN_OR_EQUAL].indexOf(this.op)},hl.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},hl.prototype.isEqual=function(t){return t instanceof hl&&this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value)},hl.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},hl);function hl(t,e,n){var r=ul.call(this)||this;return r.field=t,r.op=e,r.value=n,r}var ll,fl=(s(dl,ll=cl),dl.prototype.matches=function(t){var e=this.value,n=Ki.comparator(t.key,e.key);return this.matchesComparison(n)},dl);function dl(){return null!==ll&&ll.apply(this,arguments)||this}var pl,ml=(s(yl,pl=cl),yl.prototype.matches=function(e){return this.value.internalValue.some(function(t){return e.key.isEqual(t.key)})},yl);function yl(t,e){var n=pl.call(this,t,al.IN,e)||this;return n.value=e,n}var gl,vl=(s(bl,gl=cl),bl.prototype.matches=function(t){var e=t.field(this.field);return e instanceof Rs&&e.contains(this.value)},bl);function bl(t,e){return gl.call(this,t,al.ARRAY_CONTAINS,e)||this}var wl,Tl=(s(Sl,wl=cl),Sl.prototype.matches=function(t){var e=this.value,n=t.field(this.field);return null!==n&&e.contains(n)},Sl);function Sl(t,e){var n=wl.call(this,t,al.IN,e)||this;return n.value=e,n}var El,Il=(s(Cl,El=cl),Cl.prototype.matches=function(t){var e=this,n=t.field(this.field);return n instanceof Rs&&n.internalValue.some(function(t){return e.value.contains(t)})},Cl);function Cl(t,e){var n=El.call(this,t,al.ARRAY_CONTAINS_ANY,e)||this;return n.value=e,n}var Dl=(Nl.prototype.toString=function(){return this.name},Nl.ASCENDING=new Nl("asc"),Nl.DESCENDING=new Nl("desc"),Nl);function Nl(t){this.name=t}var Al=(kl.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++)t+=n[e].toString();return t},kl.prototype.sortsBeforeDocument=function(t,e){Fr(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=t[r],o=this.position[r];if(i.field.isKeyField())Fr(o instanceof Ts,"Bound has a non-key value where the key path is being used."),n=Ki.comparator(o.key,e.key);else{var a=e.field(i.field);Fr(null!==a,"Field should exist since document matched the orderBy already."),n=o.compareTo(a)}if(i.dir===Dl.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},kl.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++){var n=this.position[e],r=t.position[e];if(!n.isEqual(r))return!1}return!0},kl);function kl(t,e){this.position=t,this.before=e}var Rl=(Ml.prototype.compare=function(t,e){var n=this.isKeyOrderBy?Ps.compareByKey(t,e):Ps.compareByField(this.field,t,e);switch(this.dir){case Dl.ASCENDING:return n;case Dl.DESCENDING:return-1*n;default:return xr("Unknown direction: "+this.dir)}},Ml.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},Ml.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},Ml.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},Ml);function Ml(t,e){this.field=t,void 0===e&&(e=Dl.ASCENDING),this.dir=e,this.isKeyOrderBy=t.isKeyField()}var Ol=new Rl(Bi.keyField(),Dl.ASCENDING),_l=new Rl(Bi.keyField(),Dl.DESCENDING),Ll=(Pl.prototype.applyToLocalView=function(t,e){return new ms(e,t)},Pl.prototype.applyToRemoteDocument=function(t,e){return e},Pl.prototype.computeBaseValue=function(t){return null},Pl.prototype.isEqual=function(t){return t instanceof Pl},Pl.instance=new Pl,Pl);function Pl(){}var xl=(Fl.prototype.applyToLocalView=function(t,e){return this.apply(t)},Fl.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},Fl.prototype.apply=function(t){for(var n=Kl(t),e=function(e){n.find(function(t){return t.isEqual(e)})||n.push(e)},r=0,i=this.elements;r<i.length;r++)e(i[r]);return new Rs(n)},Fl.prototype.computeBaseValue=function(t){return null},Fl.prototype.isEqual=function(t){return t instanceof Fl&&bi(t.elements,this.elements)},Fl);function Fl(t){this.elements=t}var ql=(Vl.prototype.applyToLocalView=function(t,e){return this.apply(t)},Vl.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},Vl.prototype.apply=function(t){for(var n=Kl(t),e=function(e){n=n.filter(function(t){return!t.isEqual(e)})},r=0,i=this.elements;r<i.length;r++)e(i[r]);return new Rs(n)},Vl.prototype.computeBaseValue=function(t){return null},Vl.prototype.isEqual=function(t){return t instanceof Vl&&bi(t.elements,this.elements)},Vl);function Vl(t){this.elements=t}var Bl=(Ul.prototype.applyToLocalView=function(t,e){var n=this.computeBaseValue(t);if(n instanceof rs&&this.operand instanceof rs){var r=n.internalValue+this.operand.internalValue;return new rs(r)}return r=n.internalValue+this.operand.internalValue,new as(r)},Ul.prototype.applyToRemoteDocument=function(t,e){return Fr(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e},Ul.prototype.computeBaseValue=function(t){return t instanceof $a?t:new rs(0)},Ul.prototype.isEqual=function(t){return t instanceof Ul&&this.operand.isEqual(t.operand)},Ul);function Ul(t){this.operand=t}function Kl(t){return t instanceof Rs?t.internalValue.slice():[]}var Ql=(jl.prototype.isEqual=function(t){return t&&t.count===this.count},jl);function jl(t){this.count=t}var Wl,Gl,zl=((Wl={})[Dl.ASCENDING.name]="ASCENDING",Wl[Dl.DESCENDING.name]="DESCENDING",Wl),Hl=((Gl={})[al.LESS_THAN.name]="LESS_THAN",Gl[al.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",Gl[al.GREATER_THAN.name]="GREATER_THAN",Gl[al.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",Gl[al.EQUAL.name]="EQUAL",Gl[al.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",Gl[al.IN.name]="IN",Gl[al.ARRAY_CONTAINS_ANY.name]="ARRAY_CONTAINS_ANY",Gl),Yl=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Xl(t,e){Fr(!Hc(t),e+" is missing")}function Jl(t){return"number"==typeof t?t:"string"==typeof t?Number(t):xr("can't parse "+t)}var Zl=($l.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},$l.prototype.unsafeCastProtoByteString=function(t){return t},$l.prototype.fromRpcStatus=function(t){var e=void 0===t.code?Kr.UNKNOWN:Sh(t.code);return new Qr(e,t.message||"")},$l.prototype.toInt32Value=function(t){return this.options.useProto3Json||Hc(t)?t:{value:t}},$l.prototype.fromInt32Value=function(t){var e;return Hc(e="object"==typeof t?t.value:t)?null:e},$l.prototype.toTimestamp=function(t){return this.options.useProto3Json?new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")+"."+("000000000"+t.nanoseconds).slice(-9)+"Z":{seconds:""+t.seconds,nanos:t.nanoseconds}},$l.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);Fr(!!t,"Cannot deserialize null or undefined timestamp.");var e=Jl(t.seconds||"0"),n=t.nanos||0;return new oo(e,n)},$l.prototype.fromIso8601String=function(t){var e=0,n=Yl.exec(t);if(Fr(!!n,"invalid timestamp: "+t),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),e=Number(r)}var i=new Date(t),o=Math.floor(i.getTime()/1e3);return new oo(o,e)},$l.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},$l.prototype.fromBlob=function(t){return"string"==typeof t?(Fr(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Ei.fromBase64String(t)):(Fr(!this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Ei.fromUint8Array(t))},$l.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},$l.prototype.fromVersion=function(t){return Fr(!!t,"Trying to deserialize version that isn't set"),so.fromTimestamp(this.fromTimestamp(t))},$l.prototype.toResourceName=function(t,e){return this.fullyQualifiedPrefixPath(t).child("documents").child(e).canonicalString()},$l.prototype.fromResourceName=function(t){var e=xi.fromString(t);return Fr(this.isValidResourceName(e),"Tried to deserialize invalid key "+e.toString()),e},$l.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},$l.prototype.fromName=function(t){var e=this.fromResourceName(t);return Fr(e.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+e.get(1)+" vs "+this.databaseId.projectId),Fr(!e.get(3)&&!this.databaseId.database||e.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+e.get(3)+" vs "+this.databaseId.database),new Ki(this.extractLocalPathFromResourceName(e))},$l.prototype.toQueryPath=function(t){return this.toResourceName(this.databaseId,t)},$l.prototype.fromQueryPath=function(t){var e=this.fromResourceName(t);return 4===e.length?xi.EMPTY_PATH:this.extractLocalPathFromResourceName(e)},Object.defineProperty($l.prototype,"encodedDatabaseId",{get:function(){return new xi(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),$l.prototype.fullyQualifiedPrefixPath=function(t){return new xi(["projects",t.projectId,"databases",t.database])},$l.prototype.extractLocalPathFromResourceName=function(t){return Fr(4<t.length&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},$l.prototype.isValidResourceName=function(t){return 4<=t.length&&"projects"===t.get(0)&&"databases"===t.get(2)},$l.prototype.toValue=function(t){if(t instanceof za)return{nullValue:"NULL_VALUE"};if(t instanceof Xa)return{booleanValue:t.value()};if(t instanceof rs)return{integerValue:""+t.value()};if(t instanceof as){var e=t.value();if(this.options.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof cs?{stringValue:t.value()}:t instanceof Ns?{mapValue:this.toMapValue(t)}:t instanceof Rs?{arrayValue:this.toArrayValue(t)}:t instanceof fs?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof Is?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof vs?{bytesValue:this.toBytes(t.value())}:t instanceof Ts?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:xr("Unknown FieldValue "+JSON.stringify(t))},$l.prototype.fromValue=function(t){var e=this;if("nullValue"in t)return za.INSTANCE;if("booleanValue"in t)return Xa.of(t.booleanValue);if("integerValue"in t)return new rs(Jl(t.integerValue));if("doubleValue"in t){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return as.NAN;if("Infinity"===t.doubleValue)return as.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return as.NEGATIVE_INFINITY}return new as(t.doubleValue)}if("stringValue"in t)return new cs(t.stringValue);if("mapValue"in t)return this.fromFields(t.mapValue.fields||{});if("arrayValue"in t){Xl(t.arrayValue,"arrayValue");var n=t.arrayValue.values||[];return new Rs(n.map(function(t){return e.fromValue(t)}))}if("timestampValue"in t)return Xl(t.timestampValue,"timestampValue"),new fs(this.fromTimestamp(t.timestampValue));if("geoPointValue"in t){Xl(t.geoPointValue,"geoPointValue");var r=t.geoPointValue.latitude||0,i=t.geoPointValue.longitude||0;return new Is(new Jh(r,i))}if("bytesValue"in t){Xl(t.bytesValue,"bytesValue");var o=this.fromBlob(t.bytesValue);return new vs(o)}if("referenceValue"in t){Xl(t.referenceValue,"referenceValue");var a=this.fromResourceName(t.referenceValue),s=new Ai(a.get(1),a.get(3)),u=new Ki(this.extractLocalPathFromResourceName(a));return new Ts(s,u)}return xr("Unknown Value proto "+JSON.stringify(t))},$l.prototype.toMutationDocument=function(t,e){return{name:this.toName(t),fields:this.toFields(e)}},$l.prototype.toDocument=function(t){return Fr(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data()),updateTime:this.toTimestamp(t.version.toTimestamp())}},$l.prototype.fromDocument=function(t,e){var n=this,r=this.fromName(t.name),i=this.fromVersion(t.updateTime);return new Ps(r,i,{hasCommittedMutations:!!e},void 0,t,function(t){return n.fromValue(t)})},$l.prototype.toFields=function(t){var n=this,r={};return t.forEach(function(t,e){r[t]=n.toValue(e)}),r},$l.prototype.fromFields=function(t){var n=this,e=t,r=Ns.EMPTY;return Yr(e,function(t,e){r=r.set(new Bi([t]),n.fromValue(e))}),r},$l.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},$l.prototype.toArrayValue=function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.toValue(t))}),{values:n}},$l.prototype.fromFound=function(t){var e=this;Fr(!!t.found,"Tried to deserialize a found document from a missing document."),Xl(t.found.name,"doc.found.name"),Xl(t.found.updateTime,"doc.found.updateTime");var n=this.fromName(t.found.name),r=this.fromVersion(t.found.updateTime);return new Ps(n,r,{},void 0,t.found,function(t){return e.fromValue(t)})},$l.prototype.fromMissing=function(t){Fr(!!t.missing,"Tried to deserialize a missing document from a found document."),Fr(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fromName(t.missing),n=this.fromVersion(t.readTime);return new qs(e,n)},$l.prototype.fromMaybeDocument=function(t){return"found"in t?this.fromFound(t):"missing"in t?this.fromMissing(t):xr("invalid batch get response: "+JSON.stringify(t))},$l.prototype.toWatchTargetChangeState=function(t){switch(t){case Fh.Added:return"ADD";case Fh.Current:return"CURRENT";case Fh.NoChange:return"NO_CHANGE";case Fh.Removed:return"REMOVE";case Fh.Reset:return"RESET";default:return xr("Unknown WatchTargetChangeState: "+t)}},$l.prototype.toTestWatchChange=function(t){if(t instanceof Bh)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof Vh){if(t.newDoc instanceof Ps){var e=t.newDoc;return{documentChange:{document:{name:this.toName(e.key),fields:this.toFields(e.data()),updateTime:this.toVersion(e.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}}}if(t.newDoc instanceof qs)return e=t.newDoc,{documentDelete:{document:this.toName(e.key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}};if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof Uh){var n=void 0;return t.cause&&(n={code:function(t){if(void 0===t)return gh.OK;switch(t){case Kr.OK:return gh.OK;case Kr.CANCELLED:return gh.CANCELLED;case Kr.UNKNOWN:return gh.UNKNOWN;case Kr.DEADLINE_EXCEEDED:return gh.DEADLINE_EXCEEDED;case Kr.RESOURCE_EXHAUSTED:return gh.RESOURCE_EXHAUSTED;case Kr.INTERNAL:return gh.INTERNAL;case Kr.UNAVAILABLE:return gh.UNAVAILABLE;case Kr.UNAUTHENTICATED:return gh.UNAUTHENTICATED;case Kr.INVALID_ARGUMENT:return gh.INVALID_ARGUMENT;case Kr.NOT_FOUND:return gh.NOT_FOUND;case Kr.ALREADY_EXISTS:return gh.ALREADY_EXISTS;case Kr.PERMISSION_DENIED:return gh.PERMISSION_DENIED;case Kr.FAILED_PRECONDITION:return gh.FAILED_PRECONDITION;case Kr.ABORTED:return gh.ABORTED;case Kr.OUT_OF_RANGE:return gh.OUT_OF_RANGE;case Kr.UNIMPLEMENTED:return gh.UNIMPLEMENTED;case Kr.DATA_LOSS:return gh.DATA_LOSS;default:return xr("Unknown status code: "+t)}}(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:n}}}return xr("Unrecognized watch change: "+JSON.stringify(t))},$l.prototype.fromWatchChange=function(t){var e,n=this;if("targetChange"in t){Xl(t.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],o=t.targetChange.resumeToken||this.emptyByteString(),a=t.targetChange.cause,s=a&&this.fromRpcStatus(a);e=new Uh(r,i,o,s||null)}else if("documentChange"in t){Xl(t.documentChange,"documentChange"),Xl(t.documentChange.document,"documentChange.name"),Xl(t.documentChange.document.name,"documentChange.document.name"),Xl(t.documentChange.document.updateTime,"documentChange.document.updateTime");var u=t.documentChange,c=this.fromName(u.document.name),h=this.fromVersion(u.document.updateTime),l=new Ps(c,h,{},void 0,u.document,function(t){return n.fromValue(t)}),f=u.targetIds||[],d=u.removedTargetIds||[];e=new Vh(f,d,l.key,l)}else if("documentDelete"in t){Xl(t.documentDelete,"documentDelete"),Xl(t.documentDelete.document,"documentDelete.document");var p=t.documentDelete;c=this.fromName(p.document),h=p.readTime?this.fromVersion(p.readTime):so.forDeletedDoc(),l=new qs(c,h),d=p.removedTargetIds||[],e=new Vh([],d,l.key,l)}else if("documentRemove"in t){Xl(t.documentRemove,"documentRemove"),Xl(t.documentRemove.document,"documentRemove");var m=t.documentRemove;c=this.fromName(m.document),d=m.removedTargetIds||[],e=new Vh([],d,c,null)}else{if(!("filter"in t))return xr("Unknown change type "+JSON.stringify(t));Xl(t.filter,"filter"),Xl(t.filter.targetId,"filter.targetId");var y=t.filter,g=y.count||0,v=new Ql(g),b=y.targetId;e=new Bh(b,v)}return e},$l.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?Fh.NoChange:"ADD"===t?Fh.Added:"REMOVE"===t?Fh.Removed:"CURRENT"===t?Fh.Current:"RESET"===t?Fh.Reset:xr("Got unexpected TargetChange.state: "+t)},$l.prototype.versionFromListenResponse=function(t){if(!("targetChange"in t))return so.MIN;var e=t.targetChange;return e.targetIds&&e.targetIds.length?so.MIN:e.readTime?this.fromVersion(e.readTime):so.MIN},$l.prototype.toMutation=function(t){var e,n=this;if(t instanceof Na)e={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof Ba)e={delete:this.toName(t.key)};else if(t instanceof Ra)e={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof _a))return xr("Unknown mutation type "+t.type);e={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map(function(t){return n.toFieldTransform(t)})}}}return t.precondition.isNone||(e.currentDocument=this.toPrecondition(t.precondition)),e},$l.prototype.fromMutation=function(t){var e=this,n=t.currentDocument?this.fromPrecondition(t.currentDocument):Sa.NONE;if(t.update){Xl(t.update.name,"name");var r=this.fromName(t.update.name),i=this.fromFields(t.update.fields||{});if(t.updateMask){var o=this.fromDocumentMask(t.updateMask);return new Ra(r,i,o,n)}return new Na(r,i,n)}if(t.delete)return r=this.fromName(t.delete),new Ba(r,n);if(t.transform){r=this.fromName(t.transform.document);var a=t.transform.fieldTransforms.map(function(t){return e.fromFieldTransform(t)});return Fr(!0===n.exists,'Transforms only support precondition "exists == true"'),new _a(r,a)}return xr("unknown mutation proto: "+JSON.stringify(t))},$l.prototype.toPrecondition=function(t){return Fr(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:xr("Unknown precondition")},$l.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?Sa.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?Sa.exists(t.exists):Sa.NONE},$l.prototype.fromWriteResult=function(t,e){var n=this,r=t.updateTime?this.fromVersion(t.updateTime):this.fromVersion(e);r.isEqual(so.MIN)&&(r=this.fromVersion(e));var i=null;return t.transformResults&&0<t.transformResults.length&&(i=t.transformResults.map(function(t){return n.fromValue(t)})),new Ta(r,i)},$l.prototype.fromWriteResults=function(t,e){var n=this;return t&&0<t.length?(Fr(void 0!==e,"Received a write result without a commit time"),t.map(function(t){return n.fromWriteResult(t,e)})):[]},$l.prototype.toFieldTransform=function(t){var e=this,n=t.transform;if(n instanceof Ll)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof xl)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof ql)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Bl)return{fieldPath:t.field.canonicalString(),increment:this.toValue(n.operand)};throw xr("Unknown transform: "+t.transform)},$l.prototype.fromFieldTransform=function(t){var e=this,n=null;if("setToServerValue"in t)Fr("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),n=Ll.instance;else if("appendMissingElements"in t){var r=t.appendMissingElements.values||[];n=new xl(r.map(function(t){return e.fromValue(t)}))}else if("removeAllFromArray"in t)r=t.removeAllFromArray.values||[],n=new ql(r.map(function(t){return e.fromValue(t)}));else if("increment"in t){var i=this.fromValue(t.increment);Fr(i instanceof $a,"NUMERIC_ADD transform requires a NumberValue"),n=new Bl(i)}else xr("Unknown transform proto: "+JSON.stringify(t));var o=Bi.fromServerFormat(t.fieldPath);return new ga(o,n)},$l.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},$l.prototype.fromDocumentsTarget=function(t){var e=t.documents.length;Fr(1===e,"DocumentsTarget contained other than 1 document: "+e);var n=t.documents[0];return rl.atPath(this.fromQueryPath(n)).toTarget()},$l.prototype.toQueryTarget=function(t){var e={structuredQuery:{}},n=t.path;null!==t.collectionGroup?(Fr(n.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.toQueryPath(n),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(Fr(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.toQueryPath(n.popLast()),e.structuredQuery.from=[{collectionId:n.lastSegment()}]);var r=this.toFilter(t.filters);r&&(e.structuredQuery.where=r);var i=this.toOrder(t.orderBy);i&&(e.structuredQuery.orderBy=i);var o=this.toInt32Value(t.limit);return null!==o&&(e.structuredQuery.limit=o),t.startAt&&(e.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.toCursor(t.endAt)),e},$l.prototype.fromQueryTarget=function(t){var e=this.fromQueryPath(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;if(0<r){Fr(1===r,"StructuredQuery.from with more than one collection is not supported.");var o=n.from[0];o.allDescendants?i=o.collectionId:e=e.child(o.collectionId)}var a=[];n.where&&(a=this.fromFilter(n.where));var s=[];n.orderBy&&(s=this.fromOrder(n.orderBy));var u=null;n.limit&&(u=this.fromInt32Value(n.limit));var c=null;n.startAt&&(c=this.fromCursor(n.startAt));var h=null;return n.endAt&&(h=this.fromCursor(n.endAt)),new rl(e,i,s,a,u,$h.First,c,h).toTarget()},$l.prototype.toListenRequestLabels=function(t){var e=this.toLabel(t.purpose);return null==e?null:{"goog-listen-tags":e}},$l.prototype.toLabel=function(t){switch(t){case Lu.Listen:return null;case Lu.ExistenceFilterMismatch:return"existence-filter-mismatch";case Lu.LimboResolution:return"limbo-document";default:return xr("Unrecognized query purpose: "+t)}},$l.prototype.toTarget=function(t){var e,n=t.target;return(e=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)}).targetId=t.targetId,0<t.resumeToken.length&&(e.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),e},$l.prototype.toFilter=function(t){var e=this;if(0!==t.length){var n=t.map(function(t){return t instanceof cl?e.toUnaryOrFieldFilter(t):xr("Unrecognized filter: "+JSON.stringify(t))});return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},$l.prototype.fromFilter=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromFieldFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(function(t){return e.fromFilter(t)}).reduce(function(t,e){return t.concat(e)}):xr("Unknown filter: "+JSON.stringify(t)):[]},$l.prototype.toOrder=function(t){var e=this;if(0!==t.length)return t.map(function(t){return e.toPropertyOrder(t)})},$l.prototype.fromOrder=function(t){var e=this;return t.map(function(t){return e.fromPropertyOrder(t)})},$l.prototype.toCursor=function(t){var e=this;return{before:t.before,values:t.position.map(function(t){return e.toValue(t)})}},$l.prototype.fromCursor=function(t){var e=this,n=!!t.before,r=t.values.map(function(t){return e.fromValue(t)});return new Al(r,n)},$l.prototype.toDirection=function(t){return zl[t.name]},$l.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return Dl.ASCENDING;case"DESCENDING":return Dl.DESCENDING;default:return}},$l.prototype.toOperatorName=function(t){return Hl[t.name]},$l.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return al.EQUAL;case"GREATER_THAN":return al.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return al.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return al.LESS_THAN;case"LESS_THAN_OR_EQUAL":return al.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return al.ARRAY_CONTAINS;case"IN":return al.IN;case"ARRAY_CONTAINS_ANY":return al.ARRAY_CONTAINS_ANY;case"OPERATOR_UNSPECIFIED":return xr("Unspecified operator");default:return xr("Unknown operator")}},$l.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},$l.prototype.fromFieldPathReference=function(t){return Bi.fromServerFormat(t.fieldPath)},$l.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},$l.prototype.fromPropertyOrder=function(t){return new Rl(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},$l.prototype.fromFieldFilter=function(t){return cl.create(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},$l.prototype.toUnaryOrFieldFilter=function(t){if(t.op===al.EQUAL){if(t.value.isEqual(as.NAN))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}};if(t.value.isEqual(za.INSTANCE))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}}return{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}},$l.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.fromFieldPathReference(t.unaryFilter.field);return cl.create(e,al.EQUAL,as.NAN);case"IS_NULL":var n=this.fromFieldPathReference(t.unaryFilter.field);return cl.create(n,al.EQUAL,za.INSTANCE);case"OPERATOR_UNSPECIFIED":return xr("Unspecified filter");default:return xr("Unknown filter")}},$l.prototype.toDocumentMask=function(t){var e=[];return t.fields.forEach(function(t){return e.push(t.canonicalString())}),{fieldPaths:e}},$l.prototype.fromDocumentMask=function(t){var e=(t.fieldPaths||[]).map(function(t){return Bi.fromServerFormat(t)});return ma.fromArray(e)},$l);function $l(t,e){this.databaseId=t,this.options=e}var tf=function(){this.viewSnap=null,this.targetId=0,this.listeners=[]},ef=(nf.prototype.listen=function(t){var e=t.query,n=!1,r=this.queries.get(e);return r||(n=!0,r=new tf,this.queries.set(e,r)),r.listeners.push(t),Fr(!t.applyOnlineStateChange(this.onlineState),"applyOnlineStateChange() shouldn't raise an event for brand-new listeners."),!r.viewSnap||t.onViewSnapshot(r.viewSnap)&&this.raiseSnapshotsInSyncEvent(),n?this.syncEngine.listen(e).then(function(t){return r.targetId=t}):Promise.resolve(r.targetId)},nf.prototype.unlisten=function(o){return d(this,void 0,void 0,function(){var e,n,r,i;return m(this,function(t){return e=o.query,n=!1,(r=this.queries.get(e))&&0<=(i=r.listeners.indexOf(o))&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(e),[2,this.syncEngine.unlisten(e)]):[2]})})},nf.prototype.onWatchChange=function(t){for(var e=!1,n=0,r=t;n<r.length;n++){var i=r[n],o=i.query,a=this.queries.get(o);if(a){for(var s=0,u=a.listeners;s<u.length;s++)u[s].onViewSnapshot(i)&&(e=!0);a.viewSnap=i}}e&&this.raiseSnapshotsInSyncEvent()},nf.prototype.onWatchError=function(t,e){var n=this.queries.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++)i[r].onError(e);this.queries.delete(t)},nf.prototype.onOnlineStateChange=function(i){this.onlineState=i;var o=!1;this.queries.forEach(function(t,e){for(var n=0,r=e.listeners;n<r.length;n++)r[n].applyOnlineStateChange(i)&&(o=!0)}),o&&this.raiseSnapshotsInSyncEvent()},nf.prototype.addSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.add(t),t.next()},nf.prototype.removeSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.delete(t)},nf.prototype.raiseSnapshotsInSyncEvent=function(){this.snapshotsInSyncListeners.forEach(function(t){t.next()})},nf);function nf(t){this.syncEngine=t,this.queries=new Qs(function(t){return t.canonicalId()}),this.onlineState=lh.Unknown,this.snapshotsInSyncListeners=new Set,this.syncEngine.subscribe(this)}var rf=(of.prototype.onViewSnapshot=function(t){if(Fr(0<t.docChanges.length||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==Eh.Metadata&&e.push(i)}t=new Mh(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}var o=!1;return this.raisedInitialEvent?this.shouldRaiseEvent(t)&&(this.queryObserver.next(t),o=!0):this.shouldRaiseInitialEvent(t,this.onlineState)&&(this.raiseInitialEvent(t),o=!0),this.snap=t,o},of.prototype.onError=function(t){this.queryObserver.error(t)},of.prototype.applyOnlineStateChange=function(t){this.onlineState=t;var e=!1;return this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&(this.raiseInitialEvent(this.snap),e=!0),e},of.prototype.shouldRaiseInitialEvent=function(t,e){if(Fr(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache)return!0;var n=e!==lh.Offline;return this.options.waitForSyncWhenOnline&&n?(Fr(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||e===lh.Offline},of.prototype.shouldRaiseEvent=function(t){if(0<t.docChanges.length)return!0;var e=this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges},of.prototype.raiseInitialEvent=function(t){Fr(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=Mh.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},of);function of(t,e,n){this.query=t,this.queryObserver=e,this.raisedInitialEvent=!1,this.snap=null,this.onlineState=lh.Unknown,this.options=n||{}}var af=(sf.fromSnapshot=function(t,e){for(var n=Ro(),r=Ro(),i=0,o=e.docChanges;i<o.length;i++){var a=o[i];switch(a.type){case Eh.Added:n=n.add(a.doc.key);break;case Eh.Removed:r=r.add(a.doc.key)}}return new sf(t,e.fromCache,n,r)},sf);function sf(t,e,n,r){this.targetId=t,this.fromCache=e,this.addedKeys=n,this.removedKeys=r}var uf=function(t){this.key=t},cf=function(t){this.key=t},hf=(Object.defineProperty(lf.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),lf.prototype.computeDocChanges=function(t,e){var s=this,u=e?e.changeSet:new kh,c=e?e.documentSet:this.documentSet,h=e?e.mutatedKeys:this.mutatedKeys,l=c,f=!1,d=this.query.hasLimitToFirst()&&c.size===this.query.limit?c.last():null,p=this.query.hasLimitToLast()&&c.size===this.query.limit?c.first():null;if(t.inorderTraversal(function(t,e){var n=c.get(t),r=e instanceof Ps?e:null;r&&(Fr(t.isEqual(r.key),"Mismatching keys found in document changes: "+t+" != "+r.key),r=s.query.matches(r)?r:null);var i=!!n&&s.mutatedKeys.has(n.key),o=!!r&&(r.hasLocalMutations||s.mutatedKeys.has(r.key)&&r.hasCommittedMutations),a=!1;n&&r?n.data().isEqual(r.data())?i!==o&&(u.track({type:Eh.Metadata,doc:r}),a=!0):s.shouldWaitForSyncedDocument(n,r)||(u.track({type:Eh.Modified,doc:r}),a=!0,(d&&0<s.query.docComparator(r,d)||p&&s.query.docComparator(r,p)<0)&&(f=!0)):!n&&r?(u.track({type:Eh.Added,doc:r}),a=!0):n&&!r&&(u.track({type:Eh.Removed,doc:n}),a=!0,(d||p)&&(f=!0)),a&&(h=r?(l=l.add(r),o?h.add(t):h.delete(t)):(l=l.delete(t),h.delete(t)))}),this.query.hasLimitToFirst()||this.query.hasLimitToLast())for(;l.size>this.query.limit;){var n=this.query.hasLimitToFirst()?l.last():l.first();l=l.delete(n.key),h=h.delete(n.key),u.track({type:Eh.Removed,doc:n})}return Fr(!f||!e,"View was refilled using docs that themselves needed refilling."),{documentSet:l,changeSet:u,needsRefill:f,mutatedKeys:h}},lf.prototype.shouldWaitForSyncedDocument=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},lf.prototype.applyChanges=function(t,e,n){var r=this;Fr(!t.needsRefill,"Cannot apply changes that need a refill");var i=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var o=t.changeSet.getChanges();o.sort(function(t,e){return function(t,e){function n(t){switch(t){case Eh.Added:return 1;case Eh.Modified:case Eh.Metadata:return 2;case Eh.Removed:return 0;default:return xr("Unknown ChangeType: "+t)}}return n(t)-n(e)}(t.type,e.type)||r.query.docComparator(t.doc,e.doc)}),this.applyTargetChange(n);var a=e?this.updateLimboDocuments():[],s=0===this.limboDocuments.size&&this.current?Ch.Synced:Ch.Local,u=s!==this.syncState;return this.syncState=s,0!==o.length||u?{snapshot:new Mh(this.query,t.documentSet,i,o,t.mutatedKeys,s===Ch.Local,u,!1),limboChanges:a}:{limboChanges:a}},lf.prototype.applyOnlineStateChange=function(t){return this.current&&t===lh.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new kh,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},lf.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations},lf.prototype.applyTargetChange=function(t){var e=this;t&&(t.addedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.add(t)}),t.modifiedDocuments.forEach(function(t){return Fr(e._syncedDocuments.has(t),"Modified document "+t+" not found in view.")}),t.removedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.delete(t)}),this.current=t.current)},lf.prototype.updateLimboDocuments=function(){var e=this;if(!this.current)return[];var n=this.limboDocuments;this.limboDocuments=Ro(),this.documentSet.forEach(function(t){e.shouldBeInLimbo(t.key)&&(e.limboDocuments=e.limboDocuments.add(t.key))});var r=[];return n.forEach(function(t){e.limboDocuments.has(t)||r.push(new cf(t))}),this.limboDocuments.forEach(function(t){n.has(t)||r.push(new uf(t))}),r},lf.prototype.synchronizeWithPersistedState=function(t){this._syncedDocuments=t.remoteKeys,this.limboDocuments=Ro();var e=this.computeDocChanges(t.documents);return this.applyChanges(e,!0)},lf.prototype.computeInitialSnapshot=function(){return Mh.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===Ch.Local)},lf);function lf(t,e){this.query=t,this._syncedDocuments=e,this.syncState=null,this.current=!1,this.limboDocuments=Ro(),this.mutatedKeys=Ro(),this.documentSet=new Nh(t.docComparator.bind(t))}var ff=(df.prototype.run=function(){this.runWithBackOff()},df.prototype.runWithBackOff=function(){var t=this;this.backoff.backoffAndRun(function(){return d(t,void 0,void 0,function(){var e,n,r=this;return m(this,function(t){return e=this.remoteStore.createTransaction(),(n=this.tryRunUpdateFunction(e))&&n.then(function(t){r.asyncQueue.enqueueAndForget(function(){return e.commit().then(function(){r.deferred.resolve(t)}).catch(function(t){r.handleTransactionError(t)})})}).catch(function(t){r.handleTransactionError(t)}),[2]})})})},df.prototype.tryRunUpdateFunction=function(t){try{var e=this.updateFunction(t);return!Hc(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}},df.prototype.handleTransactionError=function(t){var e=this;0<this.retries&&this.isRetryableTransactionError(t)?(this.retries-=1,this.asyncQueue.enqueueAndForget(function(){return e.runWithBackOff(),Promise.resolve()})):this.deferred.reject(t)},df.prototype.isRetryableTransactionError=function(t){if("FirebaseError"!==t.name)return!1;var e=t.code;return"aborted"===e||"failed-precondition"===e||!Th(e)},df);function df(t,e,n,r){this.asyncQueue=t,this.remoteStore=e,this.updateFunction=n,this.deferred=r,this.retries=5,this.backoff=new Xc(this.asyncQueue,ji.RetryTransaction)}var pf="SyncEngine",mf=function(t,e,n){this.query=t,this.targetId=e,this.view=n},yf=function(t){this.key=t,this.receivedDocument=!1},gf=(Object.defineProperty(vf.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),vf.prototype.subscribe=function(t){Fr(null!==t,"SyncEngine listener cannot be null"),Fr(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},vf.prototype.listen=function(a){return d(this,void 0,void 0,function(){var e,n,r,i,o;return m(this,function(t){switch(t.label){case 0:return this.assertSubscribed("listen()"),(r=this.queryViewsByQuery.get(a))?(e=r.targetId,this.sharedClientState.addLocalQueryTarget(e),n=r.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateTarget(a.toTarget())];case 2:return i=t.sent(),o=this.sharedClientState.addLocalQueryTarget(i.targetId),e=i.targetId,[4,this.initializeViewAndComputeSnapshot(a,e,"current"===o)];case 3:n=t.sent(),this.isPrimary&&this.remoteStore.listen(i),t.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,e]}})})},vf.prototype.initializeViewAndComputeSnapshot=function(s,u,c){return d(this,void 0,void 0,function(){var e,n,r,i,o,a;return m(this,function(t){switch(t.label){case 0:return[4,this.localStore.executeQuery(s,!0)];case 1:return e=t.sent(),n=new hf(s,e.remoteKeys),r=n.computeDocChanges(e.documents),i=Ph.createSynthesizedTargetChangeForCurrentChange(u,c&&this.onlineState!==lh.Offline),Fr(0===(o=n.applyChanges(r,!0===this.isPrimary,i)).limboChanges.length,"View returned limbo docs before target ack from the server."),Fr(!!o.snapshot,"applyChanges for new view should always return a snapshot"),a=new mf(s,u,n),this.queryViewsByQuery.set(s,a),this.queriesByTarget[u]||(this.queriesByTarget[u]=[]),this.queriesByTarget[u].push(s),[2,o.snapshot]}})})},vf.prototype.synchronizeViewAndComputeSnapshot=function(r){return d(this,void 0,void 0,function(){var e,n;return m(this,function(t){switch(t.label){case 0:return[4,this.localStore.executeQuery(r.query,!0)];case 1:return e=t.sent(),n=r.view.synchronizeWithPersistedState(e),this.isPrimary&&this.updateTrackedLimbos(r.targetId,n.limboChanges),[2,n]}})})},vf.prototype.unlisten=function(i){return d(this,void 0,void 0,function(){var e,n,r=this;return m(this,function(t){switch(t.label){case 0:return this.assertSubscribed("unlisten()"),Fr(!!(e=this.queryViewsByQuery.get(i)),"Trying to unlisten on query not found:"+i),1<(n=this.queriesByTarget[e.targetId]).length?(this.queriesByTarget[e.targetId]=n.filter(function(t){return!t.isEqual(i)}),this.queryViewsByQuery.delete(i),[2]):this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,this.localStore.releaseTarget(e.targetId,!1).then(function(){r.sharedClientState.clearQueryState(e.targetId),r.remoteStore.unlisten(e.targetId),r.removeAndCleanupTarget(e.targetId)}).catch(hc)]):[3,3];case 1:t.sent(),t.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupTarget(e.targetId),[4,this.localStore.releaseTarget(e.targetId,!0)];case 4:t.sent(),t.label=5;case 5:return[2]}})})},vf.prototype.write=function(n,r){return d(this,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:return this.assertSubscribed("write()"),[4,this.localStore.localWrite(n)];case 1:return e=t.sent(),this.sharedClientState.addPendingMutation(e.batchId),this.addMutationCallback(e.batchId,r),[4,this.emitNewSnapsAndNotifyLocalStore(e.changes)];case 2:return t.sent(),[4,this.remoteStore.fillWritePipeline()];case 3:return t.sent(),[2]}})})},vf.prototype.runTransaction=function(t,e,n){new ff(t,this.remoteStore,e,n).run()},vf.prototype.applyRemoteEvent=function(n){return d(this,void 0,void 0,function(){var e,r=this;return m(this,function(t){switch(t.label){case 0:this.assertSubscribed("applyRemoteEvent()"),t.label=1;case 1:return t.trys.push([1,4,,6]),[4,this.localStore.applyRemoteEvent(n)];case 2:return e=t.sent(),Yr(n.targetChanges,function(t,e){var n=r.limboResolutionsByTarget[Number(t)];n&&(Fr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),0<e.addedDocuments.size?n.receivedDocument=!0:0<e.modifiedDocuments.size?Fr(n.receivedDocument,"Received change for limbo target document without add."):0<e.removedDocuments.size&&(Fr(n.receivedDocument,"Received remove for limbo target document without add."),n.receivedDocument=!1))}),[4,this.emitNewSnapsAndNotifyLocalStore(e,n)];case 3:return t.sent(),[3,6];case 4:return[4,hc(t.sent())];case 5:return t.sent(),[3,6];case 6:return[2]}})})},vf.prototype.applyOnlineStateChange=function(r,t){if(this.isPrimary&&t===dh.RemoteStore||!this.isPrimary&&t===dh.SharedClientState){this.assertSubscribed("applyOnlineStateChange()");var i=[];this.queryViewsByQuery.forEach(function(t,e){var n=e.view.applyOnlineStateChange(r);Fr(0===n.limboChanges.length,"OnlineState should not affect limbo documents."),n.snapshot&&i.push(n.snapshot)}),this.syncEngineListener.onOnlineStateChange(r),this.syncEngineListener.onWatchChange(i),this.onlineState=r,this.isPrimary&&this.sharedClientState.setOnlineState(r)}},vf.prototype.rejectListen=function(s,u){return d(this,void 0,void 0,function(){var e,n,r,i,o,a=this;return m(this,function(t){switch(t.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(s,"rejected",u),e=this.limboResolutionsByTarget[s],(n=e&&e.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(n),delete this.limboResolutionsByTarget[s],r=(r=new co(Ki.comparator)).insert(n,new qs(n,so.forDeletedDoc())),i=Ro().add(n),o=new _h(so.MIN,{},new vo(vi),r,i),[2,this.applyRemoteEvent(o)]):[3,1];case 1:return[4,this.localStore.releaseTarget(s,!1).then(function(){return a.removeAndCleanupTarget(s,u)}).catch(hc)];case 2:t.sent(),t.label=3;case 3:return[2]}})})},vf.prototype.applyBatchState=function(n,r,i){return d(this,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(n)];case 1:return null===(e=t.sent())?(_r(pf,"Cannot apply mutation batch with id: "+n),[2]):"pending"!==r?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return t.sent(),[3,4];case 3:"acknowledged"===r||"rejected"===r?(this.processUserCallback(n,i||null),this.localStore.removeCachedMutationBatchMetadata(n)):xr("Unknown batchState: "+r),t.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(e)];case 5:return t.sent(),[2]}})})},vf.prototype.applySuccessfulWrite=function(r){return d(this,void 0,void 0,function(){var e,n;return m(this,function(t){switch(t.label){case 0:this.assertSubscribed("applySuccessfulWrite()"),e=r.batch.batchId,this.processUserCallback(e,null),this.triggerPendingWritesCallbacks(e),t.label=1;case 1:return t.trys.push([1,4,,6]),[4,this.localStore.acknowledgeBatch(r)];case 2:return n=t.sent(),this.sharedClientState.updateMutationState(e,"acknowledged"),[4,this.emitNewSnapsAndNotifyLocalStore(n)];case 3:return t.sent(),[3,6];case 4:return[4,hc(t.sent())];case 5:return t.sent(),[3,6];case 6:return[2]}})})},vf.prototype.rejectFailedWrite=function(n,r){return d(this,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(n,r),this.triggerPendingWritesCallbacks(n),t.label=1;case 1:return t.trys.push([1,4,,6]),[4,this.localStore.rejectBatch(n)];case 2:return e=t.sent(),this.sharedClientState.updateMutationState(n,"rejected",r),[4,this.emitNewSnapsAndNotifyLocalStore(e)];case 3:return t.sent(),[3,6];case 4:return[4,hc(t.sent())];case 5:return t.sent(),[3,6];case 6:return[2]}})})},vf.prototype.registerPendingWritesCallback=function(r){return d(this,void 0,void 0,function(){var e,n;return m(this,function(t){switch(t.label){case 0:return this.remoteStore.canUseNetwork()||_r(pf,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),[4,this.localStore.getHighestUnacknowledgedBatchId()];case 1:return-1===(e=t.sent())?r.resolve():((n=this.pendingWritesCallbacks.get(e)||[]).push(r),this.pendingWritesCallbacks.set(e,n)),[2]}})})},vf.prototype.triggerPendingWritesCallbacks=function(t){(this.pendingWritesCallbacks.get(t)||[]).forEach(function(t){t.resolve()}),this.pendingWritesCallbacks.delete(t)},vf.prototype.rejectOutstandingPendingWritesCallbacks=function(e){this.pendingWritesCallbacks.forEach(function(t){t.forEach(function(t){t.reject(new Qr(Kr.CANCELLED,e))})}),this.pendingWritesCallbacks.clear()},vf.prototype.addMutationCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n=(n=n||new co(vi)).insert(t,e),this.mutationUserCallbacks[this.currentUser.toKey()]=n},vf.prototype.processUserCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(t);r&&(Fr(t===n.minKey(),"Mutation callbacks processed out-of-order?"),e?r.reject(e):r.resolve(),n=n.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},vf.prototype.removeAndCleanupTarget=function(t,e){var n=this;void 0===e&&(e=null),this.sharedClientState.removeLocalQueryTarget(t),Fr(this.queriesByTarget[t]&&0!==this.queriesByTarget[t].length,"There are no queries mapped to target id "+t);for(var r=0,i=this.queriesByTarget[t];r<i.length;r++){var o=i[r];this.queryViewsByQuery.delete(o),e&&this.syncEngineListener.onWatchError(o,e)}if(delete this.queriesByTarget[t],this.isPrimary){var a=this.limboDocumentRefs.referencesForId(t);this.limboDocumentRefs.removeReferencesForId(t),a.forEach(function(t){n.limboDocumentRefs.containsKey(t)||n.removeLimboTarget(t)})}},vf.prototype.removeLimboTarget=function(t){var e=this.limboTargetsByKey.get(t);null!==e&&(this.remoteStore.unlisten(e),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[e])},vf.prototype.updateTrackedLimbos=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];i instanceof uf?(this.limboDocumentRefs.addReference(i.key,t),this.trackLimboChange(i)):i instanceof cf?(_r(pf,"Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,t),this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)):xr("Unknown limbo change: "+JSON.stringify(i))}},vf.prototype.trackLimboChange=function(t){var e=t.key;if(!this.limboTargetsByKey.get(e)){_r(pf,"New document in limbo: "+e);var n=this.limboTargetIdGenerator.next(),r=rl.atPath(e.path);this.limboResolutionsByTarget[n]=new yf(e),this.remoteStore.listen(new Bu(r.toTarget(),n,Lu.LimboResolution,Ri.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(e,n)}},vf.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},vf.prototype.emitNewSnapsAndNotifyLocalStore=function(r,u){return d(this,void 0,void 0,function(){var o,a,e,s=this;return m(this,function(t){switch(t.label){case 0:return o=[],a=[],e=[],this.queryViewsByQuery.forEach(function(t,i){e.push(Promise.resolve().then(function(){var n=i.view.computeDocChanges(r);return n.needsRefill?s.localStore.executeQuery(i.query,!1).then(function(t){var e=t.documents;return i.view.computeDocChanges(e,n)}):n}).then(function(t){var e=u&&u.targetChanges[i.targetId],n=i.view.applyChanges(t,!0===s.isPrimary,e);if(s.updateTrackedLimbos(i.targetId,n.limboChanges),n.snapshot){s.isPrimary&&s.sharedClientState.updateQueryState(i.targetId,n.snapshot.fromCache?"not-current":"current"),o.push(n.snapshot);var r=af.fromSnapshot(i.targetId,n.snapshot);a.push(r)}}))}),[4,Promise.all(e)];case 1:return t.sent(),this.syncEngineListener.onWatchChange(o),[4,this.localStore.notifyLocalViewChanges(a)];case 2:return t.sent(),[2]}})})},vf.prototype.assertSubscribed=function(t){Fr(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},vf.prototype.handleCredentialChange=function(r){return d(this,void 0,void 0,function(){var e,n;return m(this,function(t){switch(t.label){case 0:return e=!this.currentUser.isEqual(r),this.currentUser=r,e?(this.rejectOutstandingPendingWritesCallbacks("'waitForPendingWrites' promise is rejected due to a user change."),[4,this.localStore.handleUserChange(r)]):[3,3];case 1:return n=t.sent(),this.sharedClientState.handleUserChange(r,n.removedBatchIds,n.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(n.affectedDocuments)];case 2:t.sent(),t.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return t.sent(),[2]}})})},vf.prototype.applyPrimaryState=function(c){return d(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u=this;return m(this,function(t){switch(t.label){case 0:return!0!==c||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return t.sent(),e=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e.toArray())];case 2:for(n=t.sent(),r=0,i=n;r<i.length;r++)o=i[r],this.remoteStore.listen(o);return[3,7];case 3:return!1!==c||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,a=[],s=Promise.resolve(),Hr(this.queriesByTarget,function(t,e){u.sharedClientState.isLocalQueryTarget(t)?a.push(t):s=s.then(function(){return u.removeAndCleanupTarget(t),u.localStore.releaseTarget(t,!0)}),u.remoteStore.unlisten(t)}),[4,s]);case 4:return t.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(a)];case 5:return t.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:t.sent(),t.label=7;case 7:return[2]}})})},vf.prototype.resetLimboDocuments=function(){var e=this;Hr(this.limboResolutionsByTarget,function(t){e.remoteStore.unlisten(t)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new co(Ki.comparator)},vf.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(p){return d(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c,h,l,f,d;return m(this,function(t){switch(t.label){case 0:e=[],n=[],r=0,i=p,t.label=1;case 1:return r<i.length?(o=i[r],a=void 0,(s=this.queriesByTarget[o])&&0!==s.length?[4,this.localStore.releaseTarget(o,!0)]:[3,8]):[3,14];case 2:return t.sent(),[4,this.localStore.allocateTarget(s[0].toTarget())];case 3:a=t.sent(),u=0,c=s,t.label=4;case 4:return u<c.length?(h=c[u],Fr(!!(l=this.queryViewsByQuery.get(h)),"No query view found for "+h),[4,this.synchronizeViewAndComputeSnapshot(l)]):[3,7];case 5:(f=t.sent()).snapshot&&n.push(f.snapshot),t.label=6;case 6:return u++,[3,4];case 7:return[3,12];case 8:return Fr(!0===this.isPrimary,"A secondary tab should never have an active target without an active query."),[4,this.localStore.getTarget(o)];case 9:return Fr(!!(d=t.sent()),"Target for id "+o+" not found"),[4,this.localStore.allocateTarget(d)];case 10:return a=t.sent(),[4,this.initializeViewAndComputeSnapshot(this.synthesizeTargetToQuery(d),o,!1)];case 11:t.sent(),t.label=12;case 12:e.push(a),t.label=13;case 13:return r++,[3,1];case 14:return this.syncEngineListener.onWatchChange(n),[2,e]}})})},vf.prototype.synthesizeTargetToQuery=function(t){return new rl(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,$h.First,t.startAt,t.endAt)},vf.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},vf.prototype.applyTargetState=function(r,i,o){return d(this,void 0,void 0,function(){var e,n;return m(this,function(t){switch(t.label){case 0:if(this.isPrimary)return _r(pf,"Ignoring unexpected query state notification."),[2];if(!this.queriesByTarget[r])return[3,7];switch(i){case"current":case"not-current":return[3,1];case"rejected":return[3,4]}return[3,6];case 1:return[4,this.localStore.getNewDocumentChanges()];case 2:return e=t.sent(),n=_h.createSynthesizedRemoteEventForCurrentChange(r,"current"===i),[4,this.emitNewSnapsAndNotifyLocalStore(e,n)];case 3:return t.sent(),[3,7];case 4:return[4,this.localStore.releaseTarget(r,!0)];case 5:return t.sent(),this.removeAndCleanupTarget(r,o),[3,7];case 6:xr("Unexpected target state: "+i),t.label=7;case 7:return[2]}})})},vf.prototype.applyActiveTargetsChange=function(l,f){return d(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c,h=this;return m(this,function(t){switch(t.label){case 0:if(!this.isPrimary)return[2];e=0,n=l,t.label=1;case 1:return e<n.length?(c=n[e],Fr(!this.queriesByTarget[c],"Trying to add an already active target"),[4,this.localStore.getTarget(c)]):[3,6];case 2:return Fr(!!(r=t.sent()),"Query data for active target "+c+" not found"),[4,this.localStore.allocateTarget(r)];case 3:return i=t.sent(),[4,this.initializeViewAndComputeSnapshot(this.synthesizeTargetToQuery(r),i.targetId,!1)];case 4:t.sent(),this.remoteStore.listen(i),t.label=5;case 5:return e++,[3,1];case 6:o=function(e){return m(this,function(t){switch(t.label){case 0:return a.queriesByTarget[e]?[4,a.localStore.releaseTarget(e,!1).then(function(){h.remoteStore.unlisten(e),h.removeAndCleanupTarget(e)}).catch(hc)]:[2,"continue"];case 1:return t.sent(),[2]}})},a=this,s=0,u=f,t.label=7;case 7:return s<u.length?(c=u[s],[5,o(c)]):[3,10];case 8:t.sent(),t.label=9;case 9:return s++,[3,7];case 10:return[2]}})})},vf.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},vf.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},vf.prototype.getRemoteKeysForTarget=function(t){var e=this.limboResolutionsByTarget[t];if(e&&e.receivedDocument)return Ro().add(e.key);var n=Ro(),r=this.queriesByTarget[t];if(!r)return n;for(var i=0,o=r;i<o.length;i++){var a=o[i],s=this.queryViewsByQuery.get(a);Fr(!!s,"No query view found for "+a),n=n.unionWith(s.view.syncedDocuments)}return n},vf);function vf(t,e,n,r){this.localStore=t,this.remoteStore=e,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new Qs(function(t){return t.canonicalId()}),this.queriesByTarget={},this.limboTargetsByKey=new co(Ki.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new vc,this.mutationUserCallbacks={},this.pendingWritesCallbacks=new Map,this.limboTargetIdGenerator=sa.forSyncEngine(),this.isPrimary=void 0,this.onlineState=lh.Unknown}var bf=(wf.prototype.isAuthenticated=function(){return null!=this.uid},wf.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},wf.prototype.isEqual=function(t){return t.uid===this.uid},wf.UNAUTHENTICATED=new wf(null),wf.GOOGLE_CREDENTIALS=new wf("google-credentials-uid"),wf.FIRST_PARTY=new wf("first-party-uid"),wf);function wf(t){this.uid=t}var Tf="SharedClientState",Sf="firestore_clients",Ef="firestore_mutations",If="firestore_targets",Cf=(Df.fromWebStorageEntry=function(t,e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new Qr(r.error.code,r.error.message)),i?new Df(t,e,r.state,o):(Lr(Tf,"Failed to parse mutation state for ID '"+e+"': "+n),null)},Df.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},Df);function Df(t,e,n,r){this.user=t,this.batchId=e,this.state=n,Fr(void 0!==(this.error=r)==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}var Nf=(Af.fromWebStorageEntry=function(t,e){var n=JSON.parse(e),r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error),i=void 0;return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new Qr(n.error.code,n.error.message)),r?new Af(t,n.state,i):(Lr(Tf,"Failed to parse target state for ID '"+t+"': "+e),null)},Af.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},Af);function Af(t,e,n){this.targetId=t,this.state=e,Fr(void 0!==(this.error=n)==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}var kf=(Rf.fromWebStorageEntry=function(t,e){for(var n=JSON.parse(e),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=Oo(),o=0;r&&o<n.activeTargetIds.length;++o)r=Yc(n.activeTargetIds[o]),i=i.add(n.activeTargetIds[o]);return r?new Rf(t,i):(Lr(Tf,"Failed to parse client data for instance '"+t+"': "+e),null)},Rf);function Rf(t,e){this.clientId=t,this.activeTargetIds=e}var Mf=(Of.fromWebStorageEntry=function(t){var e=JSON.parse(t);return"object"==typeof e&&e.onlineState in lh&&"string"==typeof e.clientId?new Of(e.clientId,lh[e.onlineState]):(Lr(Tf,"Failed to parse online state: "+t),null)},Of);function Of(t,e){this.clientId=t,this.onlineState=e}var _f=(Lf.prototype.addQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.add(t)},Lf.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},Lf.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},Lf);function Lf(){this.activeTargetIds=Oo()}var Pf=(xf.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},xf.prototype.start=function(){return d(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c,h,l,f=this;return m(this,function(t){switch(t.label){case 0:return Fr(!this.started,"WebStorageSharedClientState already started"),Fr(null!==this.syncEngine,"syncEngine property must be set before calling start()"),Fr(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(e=t.sent(),n=0,r=e;n<r.length;n++)(i=r[n])!==this.localClientId&&(o=this.getItem(this.toWebStorageClientStateKey(i)))&&(a=kf.fromWebStorageEntry(i,o))&&(this.activeClients[a.clientId]=a);for(this.persistClientState(),(s=this.storage.getItem(this.onlineStateKey))&&(u=this.fromWebStorageOnlineState(s))&&this.handleOnlineStateEvent(u),c=0,h=this.earlyEvents;c<h.length;c++)l=h[c],this.handleWebStorageEvent(l);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return f.shutdown()}),this.started=!0,[2]}})})},xf.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},xf.prototype.getAllActiveQueryTargets=function(){var n=Oo();return Yr(this.activeClients,function(t,e){n=n.unionWith(e.activeTargetIds)}),n},xf.prototype.isActiveQueryTarget=function(t){for(var e in this.activeClients)if(this.activeClients.hasOwnProperty(e)&&this.activeClients[e].activeTargetIds.has(t))return!0;return!1},xf.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},xf.prototype.updateMutationState=function(t,e,n){this.persistMutationState(t,e,n),this.removeMutationState(t)},xf.prototype.addLocalQueryTarget=function(t){var e="not-current";if(this.isActiveQueryTarget(t)){var n=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t));if(n){var r=Nf.fromWebStorageEntry(t,n);r&&(e=r.state)}}return this.localClientState.addQueryTarget(t),this.persistClientState(),e},xf.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},xf.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},xf.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},xf.prototype.updateQueryState=function(t,e,n){this.persistQueryTargetState(t,e,n)},xf.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach(function(t){r.removeMutationState(t)}),this.currentUser=t,n.forEach(function(t){r.addPendingMutation(t)})},xf.prototype.setOnlineState=function(t){this.persistOnlineState(t)},xf.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},xf.prototype.getItem=function(t){var e=this.storage.getItem(t);return _r(Tf,"READ",t,e),e},xf.prototype.setItem=function(t,e){_r(Tf,"SET",t,e),this.storage.setItem(t,e)},xf.prototype.removeItem=function(t){_r(Tf,"REMOVE",t),this.storage.removeItem(t)},xf.prototype.handleWebStorageEvent=function(s){var t=this;if(s.storageArea===this.storage){if(_r(Tf,"EVENT",s.key,s.newValue),s.key===this.localClientStorageKey)return void Lr("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget(function(){return d(t,void 0,void 0,function(){var e,n,r,i,o,a;return m(this,function(t){if(!this.started)return this.earlyEvents.push(s),[2];if(null===s.key)return[2];if(this.clientStateKeyRe.test(s.key)){if(null==s.newValue)return n=this.fromWebStorageClientStateKey(s.key),[2,this.handleClientStateEvent(n,null)];if(e=this.fromWebStorageClientState(s.key,s.newValue))return[2,this.handleClientStateEvent(e.clientId,e)]}else if(this.mutationBatchKeyRe.test(s.key)){if(null!==s.newValue&&(r=this.fromWebStorageMutationMetadata(s.key,s.newValue)))return[2,this.handleMutationBatchEvent(r)]}else if(this.queryTargetKeyRe.test(s.key)){if(null!==s.newValue&&(i=this.fromWebStorageQueryTargetMetadata(s.key,s.newValue)))return[2,this.handleQueryTargetEvent(i)]}else if(s.key===this.onlineStateKey){if(null!==s.newValue&&(o=this.fromWebStorageOnlineState(s.newValue)))return[2,this.handleOnlineStateEvent(o)]}else s.key===this.sequenceNumberKey&&(Fr(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(a=function(t){var e=Ri.INVALID;if(null!=t)try{var n=JSON.parse(t);Fr("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){Lr(Tf,"Failed to read sequence number from WebStorage",t)}return e}(s.newValue))!==Ri.INVALID&&this.sequenceNumberHandler(a));return[2]})})})}},Object.defineProperty(xf.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),xf.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},xf.prototype.persistMutationState=function(t,e,n){var r=new Cf(this.currentUser,t,e,n),i=this.toWebStorageMutationBatchKey(t);this.setItem(i,r.toWebStorageJSON())},xf.prototype.removeMutationState=function(t){var e=this.toWebStorageMutationBatchKey(t);this.removeItem(e)},xf.prototype.persistOnlineState=function(t){var e={clientId:this.localClientId,onlineState:lh[t]};this.storage.setItem(this.onlineStateKey,JSON.stringify(e))},xf.prototype.persistQueryTargetState=function(t,e,n){var r=this.toWebStorageQueryTargetMetadataKey(t),i=new Nf(t,e,n);this.setItem(r,i.toWebStorageJSON())},xf.prototype.toWebStorageClientStateKey=function(t){return Fr(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),Sf+"_"+this.persistenceKey+"_"+t},xf.prototype.toWebStorageQueryTargetMetadataKey=function(t){return If+"_"+this.persistenceKey+"_"+t},xf.prototype.toWebStorageMutationBatchKey=function(t){var e=Ef+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(e+="_"+this.currentUser.uid),e},xf.prototype.fromWebStorageClientStateKey=function(t){var e=this.clientStateKeyRe.exec(t);return e?e[1]:null},xf.prototype.fromWebStorageClientState=function(t,e){var n=this.fromWebStorageClientStateKey(t);return Fr(null!==n,"Cannot parse client state key '"+t+"'"),kf.fromWebStorageEntry(n,e)},xf.prototype.fromWebStorageMutationMetadata=function(t,e){var n=this.mutationBatchKeyRe.exec(t);Fr(null!==n,"Cannot parse mutation batch key '"+t+"'");var r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return Cf.fromWebStorageEntry(new bf(i),r,e)},xf.prototype.fromWebStorageQueryTargetMetadata=function(t,e){var n=this.queryTargetKeyRe.exec(t);Fr(null!==n,"Cannot parse query target key '"+t+"'");var r=Number(n[1]);return Nf.fromWebStorageEntry(r,e)},xf.prototype.fromWebStorageOnlineState=function(t){return Mf.fromWebStorageEntry(t)},xf.prototype.handleMutationBatchEvent=function(e){return d(this,void 0,void 0,function(){return m(this,function(t){return e.user.uid!==this.currentUser.uid?(_r(Tf,"Ignoring mutation for non-active user "+e.user.uid),[2]):[2,this.syncEngine.applyBatchState(e.batchId,e.state,e.error)]})})},xf.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},xf.prototype.handleClientStateEvent=function(t,e){var n=this,r=this.getAllActiveQueryTargets();e?this.activeClients[t]=e:delete this.activeClients[t];var i=this.getAllActiveQueryTargets(),o=[],a=[];return i.forEach(function(e){return d(n,void 0,void 0,function(){return m(this,function(t){return r.has(e)||o.push(e),[2]})})}),r.forEach(function(e){return d(n,void 0,void 0,function(){return m(this,function(t){return i.has(e)||a.push(e),[2]})})}),this.syncEngine.applyActiveTargetsChange(o,a)},xf.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},xf);function xf(t,e,n,r,i){if(this.queue=t,this.platform=e,this.persistenceKey=n,this.localClientId=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!xf.isAvailable(this.platform))throw new Qr(Kr.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var o=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=i,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey="firestore_sequence_number_"+n,this.activeClients[this.localClientId]=new _f,this.clientStateKeyRe=new RegExp("^"+Sf+"_"+o+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+Ef+"_"+o+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+If+"_"+o+"_(\\d+)$"),this.onlineStateKey="firestore_online_state_"+n,this.platform.window.addEventListener("storage",this.storageListener)}var Ff=(qf.prototype.addPendingMutation=function(t){},qf.prototype.updateMutationState=function(t,e,n){},qf.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},qf.prototype.updateQueryState=function(t,e,n){this.queryState[t]=e},qf.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},qf.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},qf.prototype.clearQueryState=function(t){delete this.queryState[t]},qf.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},qf.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},qf.prototype.start=function(){return this.localState=new _f,Promise.resolve()},qf.prototype.handleUserChange=function(t,e,n){},qf.prototype.setOnlineState=function(t){},qf.prototype.shutdown=function(){},qf.prototype.writeSequenceNumber=function(t){},qf);function qf(){this.localState=new _f,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}var Vf="FirestoreClient",Bf=(Uf.prototype.lruParams=function(){return Hu.withCacheSize(this.cacheSizeBytes)},Uf);function Uf(t,e,n){this.cacheSizeBytes=t,this.synchronizeTabs=e,this.force=n}var Kf=function(){},Qf=(jf.prototype.start=function(t){var n=this;this.verifyNotTerminated();var r=new Gi,i=new Gi,o=!1;return this.credentials.setChangeListener(function(e){o?n.asyncQueue.enqueueAndForget(function(){return n.handleCredentialChange(e)}):(o=!0,n.initializePersistence(t,i,e).then(function(t){return n.initializeRest(e,t)}).then(r.resolve,r.reject))}),this.asyncQueue.enqueueAndForget(function(){return r.promise}),i.promise},jf.prototype.enableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return t.syncEngine.enableNetwork()})},jf.prototype.initializePersistence=function(t,e,n){var r=this;return t instanceof Bf?this.startIndexedDbPersistence(n,t).then(function(t){return e.resolve(),t}).catch(function(t){if(e.reject(t),!r.canFallback(t))throw t;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.startMemoryPersistence()}):(e.resolve(),this.startMemoryPersistence())},jf.prototype.canFallback=function(t){return t instanceof Qr?t.code===Kr.FAILED_PRECONDITION||t.code===Kr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code},jf.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new Qr(Kr.FAILED_PRECONDITION,"The client has already been terminated.")},jf.prototype.startIndexedDbPersistence=function(r,i){var t=this,o=uc.buildStoragePrefix(this.databaseInfo),a=new Zl(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return d(t,void 0,void 0,function(){var e,n;return m(this,function(t){switch(t.label){case 0:if(i.synchronizeTabs&&!Pf.isAvailable(this.platform))throw new Qr(Kr.UNIMPLEMENTED,"IndexedDB persistence with synchronizeTabs is only available on platforms that support LocalStorage.");return e=i.lruParams(),this.sharedClientState=i.synchronizeTabs?new Pf(this.asyncQueue,this.platform,o,this.clientId,r):new Ff,[4,uc.createIndexedDbPersistence({allowTabSynchronization:i.synchronizeTabs,persistenceKey:o,clientId:this.clientId,platform:this.platform,queue:this.asyncQueue,serializer:a,lruParams:e,sequenceNumberSyncer:this.sharedClientState,force:i.force})];case 1:return n=t.sent(),[2,(this.persistence=n).referenceDelegate.garbageCollector]}})})})},jf.prototype.startMemoryPersistence=function(){return this.persistence=_c.createEagerPersistence(this.clientId),this.sharedClientState=new Ff,Promise.resolve(null)},jf.prototype.initializeRest=function(c,h){var t=this;return _r(Vf,"Initializing. user=",c.uid),this.platform.loadConnection(this.databaseInfo).then(function(u){return d(t,void 0,void 0,function(){var e,n,r,i,o,a,s=this;return m(this,function(t){switch(t.label){case 0:return e=new Kc,this.localStore=new Ec(this.persistence,e,c),[4,this.localStore.start()];case 1:return t.sent(),h&&(this.lruScheduler=new Xu(h,this.asyncQueue,this.localStore)),n=this.platform.newConnectivityMonitor(),r=this.platform.newSerializer(this.databaseInfo.databaseId),i=new ch(this.asyncQueue,u,this.credentials,r),o=function(t){return s.syncEngine.applyOnlineStateChange(t,dh.RemoteStore)},a=function(t){return s.syncEngine.applyOnlineStateChange(t,dh.SharedClientState)},this.remoteStore=new Yh(this.localStore,i,this.asyncQueue,o,n),this.syncEngine=new gf(this.localStore,this.remoteStore,this.sharedClientState,c),this.sharedClientState.onlineStateHandler=a,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new ef(this.syncEngine),[4,this.sharedClientState.start()];case 2:return t.sent(),[4,this.remoteStore.start()];case 3:return t.sent(),[4,this.persistence.setPrimaryStateListener(function(e){return d(s,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return[4,this.syncEngine.applyPrimaryState(e)];case 1:return t.sent(),this.lruScheduler&&(e&&!this.lruScheduler.started?this.lruScheduler.start():e||this.lruScheduler.stop()),[2]}})})})];case 4:return t.sent(),[4,this.persistence.setDatabaseDeletedListener(function(){return d(s,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return[4,this.terminate()];case 1:return t.sent(),[2]}})})})];case 5:return t.sent(),[2]}})})})},jf.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),_r(Vf,"Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},jf.prototype.disableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return t.syncEngine.disableNetwork()})},jf.prototype.terminate=function(){var t=this;return this.asyncQueue.enqueueAndInitiateShutdown(function(){return d(t,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:return t.sent(),this.credentials.removeChangeListener(),[2]}})})})},jf.prototype.waitForPendingWrites=function(){var t=this;this.verifyNotTerminated();var e=new Gi;return this.asyncQueue.enqueueAndForget(function(){return t.syncEngine.registerPendingWritesCallback(e)}),e.promise},jf.prototype.listen=function(t,e,n){var r=this;this.verifyNotTerminated();var i=new rf(t,e,n);return this.asyncQueue.enqueueAndForget(function(){return r.eventMgr.listen(i)}),i},jf.prototype.unlisten=function(t){var e=this;this.clientTerminated||this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.unlisten(t)})},jf.prototype.getDocumentFromLocalCache=function(t){var e=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return e.localStore.readDocument(t)}).then(function(t){if(t instanceof Ps)return t;if(t instanceof qs)return null;throw new Qr(Kr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},jf.prototype.getDocumentsFromLocalCache=function(i){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return d(t,void 0,void 0,function(){var e,n,r;return m(this,function(t){switch(t.label){case 0:return[4,this.localStore.executeQuery(i,!0)];case 1:return e=t.sent(),n=new hf(i,e.remoteKeys),r=n.computeDocChanges(e.documents),[2,n.applyChanges(r,!1).snapshot]}})})})},jf.prototype.write=function(t){var e=this;this.verifyNotTerminated();var n=new Gi;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.write(t,n)}),n.promise},jf.prototype.databaseId=function(){return this.databaseInfo.databaseId},jf.prototype.addSnapshotsInSyncListener=function(t){var e=this;this.verifyNotTerminated(),this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.addSnapshotsInSyncListener(t),Promise.resolve()})},jf.prototype.removeSnapshotsInSyncListener=function(t){this.clientTerminated||this.eventMgr.removeSnapshotsInSyncListener(t)},Object.defineProperty(jf.prototype,"clientTerminated",{get:function(){return this.asyncQueue.isShuttingDown},enumerable:!0,configurable:!0}),jf.prototype.transaction=function(t){var e=this;this.verifyNotTerminated();var n=new Gi;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.runTransaction(e.asyncQueue,t,n),Promise.resolve()}),n.promise},jf);function jf(t,e,n,r){this.platform=t,this.databaseInfo=e,this.credentials=n,this.asyncQueue=r,this.clientId=yi.newId()}var Wf=(Gf.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},Gf.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},Gf.prototype.mute=function(){this.muted=!0},Gf.prototype.scheduleEvent=function(t,e){var n=this;this.muted||setTimeout(function(){n.muted||t(e)},0)},Gf);function Gf(t){this.observer=t,this.muted=!1}var zf=(Hf.documentId=function(){return Hf._DOCUMENT_ID},Hf.prototype.isEqual=function(t){if(!(t instanceof Hf))throw fi("isEqual","FieldPath",1,t);return this._internalPath.isEqual(t._internalPath)},Hf._DOCUMENT_ID=new Hf(Bi.keyField().canonicalString()),Hf);function Hf(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];!function(t,e,n,r){if(!(e instanceof Array)||e.length<r)throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" argument to be an array with at least "+mi(r,"element")+".")}("FieldPath",t,"fieldNames",1);for(var n=0;n<t.length;++n)if(ei("FieldPath","string",n,t[n]),0===t[n].length)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Bi(t)}var Yf=new RegExp("[~\\*/\\[\\]]");var Xf=function(t,e){this.user=e,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}},Jf=(Zf.prototype.getToken=function(){return Promise.resolve(null)},Zf.prototype.invalidateToken=function(){},Zf.prototype.setChangeListener=function(t){Fr(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=t)(bf.UNAUTHENTICATED)},Zf.prototype.removeChangeListener=function(){Fr(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},Zf);function Zf(){this.changeListener=null}var $f=(td.prototype.getToken=function(){var e=this;Fr(null!=this.tokenListener,"getToken cannot be called after listener removed.");var n=this.tokenCounter,t=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(t).then(function(t){if(e.tokenCounter!==n)throw new Qr(Kr.ABORTED,"getToken aborted due to token change.");return t?(Fr("string"==typeof t.accessToken,"Invalid tokenData returned from getToken():"+t),new Xf(t.accessToken,e.currentUser)):null})},td.prototype.invalidateToken=function(){this.forceRefresh=!0},td.prototype.setChangeListener=function(t){Fr(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,this.receivedInitialUser&&t(this.currentUser)},td.prototype.removeChangeListener=function(){Fr(null!=this.tokenListener,"removeChangeListener() called twice"),Fr(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},td.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return Fr(null===t||"string"==typeof t,"Received invalid UID: "+t),new bf(t)},td);function td(t){var e=this;this.app=t,this.tokenListener=null,this.currentUser=bf.UNAUTHENTICATED,this.receivedInitialUser=!1,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){e.tokenCounter++,e.currentUser=e.getUser(),e.receivedInitialUser=!0,e.changeListener&&e.changeListener(e.currentUser)},this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}var ed=(Object.defineProperty(nd.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.sessionIndex},e=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),t},enumerable:!0,configurable:!0}),nd);function nd(t,e){this.gapi=t,this.sessionIndex=e,this.type="FirstParty",this.user=bf.FIRST_PARTY}var rd=(id.prototype.getToken=function(){return Promise.resolve(new ed(this.gapi,this.sessionIndex))},id.prototype.setChangeListener=function(t){t(bf.FIRST_PARTY)},id.prototype.removeChangeListener=function(){},id.prototype.invalidateToken=function(){},id);function id(t,e){this.gapi=t,this.sessionIndex=e}function od(t){return function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=t,r=0,i=e;r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}(t,["next","error","complete"])}var ad=(sd.delete=function(){return Jr("FieldValue.delete",arguments),cd.instance},sd.serverTimestamp=function(){return Jr("FieldValue.serverTimestamp",arguments),fd.instance},sd.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return $r("FieldValue.arrayUnion",arguments,1),new md(t)},sd.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return $r("FieldValue.arrayRemove",arguments,1),new vd(t)},sd.increment=function(t){return ei("FieldValue.increment","number",1,t),Zr("FieldValue.increment",arguments,1),new Td(t)},sd.prototype.isEqual=function(t){return this===t},sd);function sd(t){this._methodName=t}var ud,cd=(s(hd,ud=ad),hd.instance=new hd,hd);function hd(){return ud.call(this,"FieldValue.delete")||this}var ld,fd=(s(dd,ld=ad),dd.instance=new dd,dd);function dd(){return ld.call(this,"FieldValue.serverTimestamp")||this}var pd,md=(s(yd,pd=ad),yd);function yd(t){var e=pd.call(this,"FieldValue.arrayUnion")||this;return e._elements=t,e}var gd,vd=(s(bd,gd=ad),bd);function bd(t){var e=gd.call(this,"FieldValue.arrayRemove")||this;return e._elements=t,e}var wd,Td=(s(Sd,wd=ad),Sd);function Sd(t){var e=wd.call(this,"FieldValue.increment")||this;return e._operand=t,e}var Ed=Wr(ad,"Use FieldValue.<field>() instead."),Id=/^__.*__$/,Cd=(Dd.prototype.toMutations=function(t,e){var n=[];return null!==this.fieldMask?n.push(new Ra(t,this.data,this.fieldMask,e)):n.push(new Na(t,this.data,e)),0<this.fieldTransforms.length&&n.push(new _a(t,this.fieldTransforms)),n},Dd);function Dd(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}var Nd,Ad,kd=(Rd.prototype.toMutations=function(t,e){var n=[new Ra(t,this.data,this.fieldMask,e)];return 0<this.fieldTransforms.length&&n.push(new _a(t,this.fieldTransforms)),n},Rd);function Rd(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}function Md(t){switch(t){case Nd.Set:case Nd.MergeSet:case Nd.Update:return!0;case Nd.Argument:case Nd.ArrayArgument:return!1;default:throw xr("Unexpected case for UserDataSource: "+t)}}(Ad=Nd=Nd||{})[Ad.Set=0]="Set",Ad[Ad.Update=1]="Update",Ad[Ad.MergeSet=2]="MergeSet",Ad[Ad.Argument=3]="Argument",Ad[Ad.ArrayArgument=4]="ArrayArgument";var Od=(_d.prototype.childContextForField=function(t){var e=null==this.path?null:this.path.child(t),n=new _d(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return n.validatePathSegment(t),n},_d.prototype.childContextForFieldPath=function(t){var e=null==this.path?null:this.path.child(t),n=new _d(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return n.validatePath(),n},_d.prototype.childContextForArray=function(t){return new _d(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},_d.prototype.createError=function(t){var e=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new Qr(Kr.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},_d.prototype.contains=function(e){return void 0!==this.fieldMask.find(function(t){return e.isPrefixOf(t)})||void 0!==this.fieldTransforms.find(function(t){return e.isPrefixOf(t.field)})},_d.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},_d.prototype.validatePathSegment=function(t){if(0===t.length)throw this.createError("Document fields must not be empty");if(Md(this.dataSource)&&Id.test(t))throw this.createError('Document fields cannot begin and end with "__"')},_d);function _d(t,e,n,r,i,o){this.dataSource=t,this.methodName=e,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}var Ld=function(t,e){this.databaseId=t,this.key=e},Pd=(xd.prototype.parseSetData=function(t,e){var n=new Od(Nd.Set,t,Bi.EMPTY_PATH);qd("Data must be an object, but it was:",n,e);var r=this.parseData(e,n);return new Cd(r,null,n.fieldTransforms)},xd.prototype.parseMergeData=function(t,e,n){var r=new Od(Nd.MergeSet,t,Bi.EMPTY_PATH);qd("Data must be an object, but it was:",r,e);var i,o,a=this.parseData(e,r);if(n){for(var s=new vo(Bi.comparator),u=0,c=n;u<c.length;u++){var h=c[u],l=void 0;if(h instanceof zf)l=h._internalPath;else{if("string"!=typeof h)throw xr("Expected stringOrFieldPath to be a string or a FieldPath");l=Bd(t,h)}if(!r.contains(l))throw new Qr(Kr.INVALID_ARGUMENT,"Field '"+l+"' is specified in your field mask but missing from your input data.");s=s.add(l)}i=ma.fromSet(s),o=r.fieldTransforms.filter(function(t){return i.covers(t.field)})}else i=ma.fromArray(r.fieldMask),o=r.fieldTransforms;return new Cd(a,i,o)},xd.prototype.parseUpdateData=function(o,t){var a=this,s=new Od(Nd.Update,o,Bi.EMPTY_PATH);qd("Data must be an object, but it was:",s,t);var u=new vo(Bi.comparator),c=Ns.EMPTY;Yr(t,function(t,e){var n=Bd(o,t),r=s.childContextForFieldPath(n);if((e=a.runPreConverter(e,r))instanceof cd)u=u.add(n);else{var i=a.parseData(e,r);null!=i&&(u=u.add(n),c=c.set(n,i))}});var e=ma.fromSet(u);return new kd(c,e,s.fieldTransforms)},xd.prototype.parseUpdateVarargs=function(t,e,n,r){var i=new Od(Nd.Update,t,Bi.EMPTY_PATH),o=[Vd(t,e)],a=[n];if(r.length%2!=0)throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(Vd(t,r[s])),a.push(r[s+1]);var u=new vo(Bi.comparator),c=Ns.EMPTY;for(s=0;s<o.length;++s){var h=o[s],l=i.childContextForFieldPath(h),f=this.runPreConverter(a[s],l);if(f instanceof cd)u=u.add(h);else{var d=this.parseData(f,l);null!=d&&(u=u.add(h),c=c.set(h,d))}}var p=ma.fromSet(u);return new kd(c,p,i.fieldTransforms)},xd.prototype.parseQueryValue=function(t,e,n){void 0===n&&(n=!1);var r=new Od(n?Nd.ArrayArgument:Nd.Argument,t,Bi.EMPTY_PATH),i=this.parseData(e,r);return Fr(null!=i,"Parsed data should not be null."),Fr(0===r.fieldTransforms.length,"Field transforms should have been disallowed."),i},xd.prototype.runPreConverter=function(t,e){try{return this.preConverter(t)}catch(t){var n=Ud(t);throw e.createError(n)}},xd.prototype.parseData=function(t,e){if(Fd(t=this.runPreConverter(t,e)))return qd("Unsupported field value:",e,t),this.parseObject(t,e);if(t instanceof ad)return this.parseSentinelFieldValue(t,e),null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.arrayElement&&e.dataSource!==Nd.ArrayArgument)throw e.createError("Nested arrays are not supported");return this.parseArray(t,e)}return this.parseScalarValue(t,e)},xd.prototype.parseObject=function(t,r){var i=this,o=new co(vi);return Xr(t)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):Yr(t,function(t,e){var n=i.parseData(e,r.childContextForField(t));null!=n&&(o=o.insert(t,n))}),new Ns(o)},xd.prototype.parseArray=function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var a=o[i],s=this.parseData(a,e.childContextForArray(r));null==s&&(s=za.INSTANCE),n.push(s),r++}return new Rs(n)},xd.prototype.parseSentinelFieldValue=function(t,e){if(!Md(e.dataSource))throw e.createError(t._methodName+"() can only be used with update() and set()");if(null===e.path)throw e.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof cd){if(e.dataSource!==Nd.MergeSet)throw e.dataSource===Nd.Update?(Fr(0<e.path.length,"FieldValue.delete() at the top level should have already been handled."),e.createError("FieldValue.delete() can only appear at the top level of your update data")):e.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fieldMask.push(e.path)}else if(t instanceof fd)e.fieldTransforms.push(new ga(e.path,Ll.instance));else if(t instanceof md){var n=this.parseArrayTransformElements(t._methodName,t._elements),r=new xl(n);e.fieldTransforms.push(new ga(e.path,r))}else if(t instanceof vd){n=this.parseArrayTransformElements(t._methodName,t._elements);var i=new ql(n);e.fieldTransforms.push(new ga(e.path,i))}else if(t instanceof Td){var o=this.parseQueryValue("FieldValue.increment",t._operand),a=new Bl(o);e.fieldTransforms.push(new ga(e.path,a))}else xr("Unknown FieldValue type: "+t)},xd.prototype.parseScalarValue=function(t,e){if(null===t)return za.INSTANCE;if("number"==typeof t)return Yc(t)?new rs(t):new as(t);if("boolean"==typeof t)return Xa.of(t);if("string"==typeof t)return new cs(t);if(t instanceof Date)return new fs(oo.fromDate(t));if(t instanceof oo)return new fs(new oo(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof Jh)return new Is(t);if(t instanceof Ei)return new vs(t);if(t instanceof Ld)return new Ts(t.databaseId,t.key);throw e.createError("Unsupported field value: "+ci(t))},xd.prototype.parseArrayTransformElements=function(r,t){var i=this;return t.map(function(t,e){var n=new Od(Nd.Argument,r,Bi.EMPTY_PATH);return i.parseData(t,n.childContextForArray(e))})},xd);function xd(t){this.preConverter=t}function Fd(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof oo||t instanceof Jh||t instanceof Ei||t instanceof Ld||t instanceof ad)}function qd(t,e,n){if(!Fd(n)||!ui(n)){var r=ci(n);throw"an object"===r?e.createError(t+" a custom object"):e.createError(t+" "+r)}}function Vd(t,e){if(e instanceof zf)return e._internalPath;if("string"==typeof e)return Bd(t,e);throw new Qr(Kr.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function Bd(e,t){try{return function(e){if(0<=e.search(Yf))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(zf.bind.apply(zf,[void 0].concat(e.split("."))))}catch(t){throw new Qr(Kr.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(t)._internalPath}catch(t){var n=Ud(t);throw new Qr(Kr.INVALID_ARGUMENT,"Function "+e+"() called with invalid data. "+n)}}function Ud(t){return t instanceof Error?t.message:t.toString()}var Kd=Hu.COLLECTION_DISABLED,Qd=(jd.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},jd);function jd(t){if(void 0===t.host){if(void 0!==t.ssl)throw new Qr(Kr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else ri("settings","non-empty string","host",t.host),this.host=t.host,ii("settings","boolean","ssl",t.ssl),this.ssl=zr(t.ssl,!0);if(li("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),ii("settings","object","credentials",t.credentials),this.credentials=t.credentials,ii("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?Lr("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&Lr("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=zr(t.timestampsInSnapshots,!0),ii("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=Hu.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==Kd&&t.cacheSizeBytes<Hu.MINIMUM_CACHE_SIZE_BYTES)throw new Qr(Kr.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+Hu.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}ii("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0!==t.experimentalForceLongPolling&&t.experimentalForceLongPolling}var Wd=(Gd.prototype.settings=function(t){if(Zr("Firestore.settings",arguments,1),ei("Firestore.settings","object",1,t),Gr(t,"persistence"))throw new Qr(Kr.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var e=new Qd(t);if(this._firestoreClient&&!this._settings.isEqual(e))throw new Qr(Kr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");void 0!==(this._settings=e).credentials&&(this._credentials=function(t){if(!t)return new Jf;switch(t.type){case"gapi":var e=t.client;return Fr(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new rd(e,t.sessionIndex||"0");case"provider":return t.client;default:throw new Qr(Kr.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(e.credentials))},Gd.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},Gd.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},Gd.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new Qr(Kr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");var e=!1,n=!1;return t&&(void 0!==t.experimentalTabSynchronization&&Lr("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),e=zr(void 0!==t.synchronizeTabs?t.synchronizeTabs:t.experimentalTabSynchronization,!1),n=!!t.experimentalForce&&t.experimentalForce),this.configureClient(new Bf(this._settings.cacheSizeBytes,e,n))},Gd.prototype.clearPersistence=function(){var t=this,n=uc.buildStoragePrefix(this.makeDatabaseInfo()),r=new Gi;return this._queue.enqueueAndForgetEvenAfterShutdown(function(){return d(t,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:if(t.trys.push([0,2,,3]),void 0!==this._firestoreClient&&!this._firestoreClient.clientTerminated)throw new Qr(Kr.FAILED_PRECONDITION,"Persistence cannot be cleared after this Firestore instance is initialized.");return[4,uc.clearPersistence(n)];case 1:return t.sent(),r.resolve(),[3,3];case 2:return e=t.sent(),r.reject(e),[3,3];case 3:return[2]}})})}),r.promise},Gd.prototype.terminate=function(){return this.app._removeServiceInstance("firestore"),this.INTERNAL.delete()},Object.defineProperty(Gd.prototype,"_isTerminated",{get:function(){return this.ensureClientConfigured(),this._firestoreClient.clientTerminated},enumerable:!0,configurable:!0}),Gd.prototype.waitForPendingWrites=function(){return this.ensureClientConfigured(),this._firestoreClient.waitForPendingWrites()},Gd.prototype.onSnapshotsInSync=function(t){if(this.ensureClientConfigured(),od(t))return this.onSnapshotsInSyncInternal(t);ei("Firestore.onSnapshotsInSync","function",1,t);var e={next:t};return this.onSnapshotsInSyncInternal(e)},Gd.prototype.onSnapshotsInSyncInternal=function(t){var e=this,n=new Wf({next:function(){t.next&&t.next()},error:function(t){throw xr("Uncaught Error in onSnapshotsInSync")}});return this._firestoreClient.addSnapshotsInSyncListener(n),function(){n.mute(),e._firestoreClient.removeSnapshotsInSyncListener(n)}},Gd.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Kf),this._firestoreClient},Gd.prototype.makeDatabaseInfo=function(){return new Di(this._databaseId,this._persistenceKey,this._settings.host,this._settings.ssl,this._settings.forceLongPolling)},Gd.prototype.configureClient=function(t){Fr(!!this._settings.host,"FirestoreSettings.host is not set"),Fr(!this._firestoreClient,"configureClient() called multiple times");var e=this.makeDatabaseInfo();return this._firestoreClient=new Qf(qr.getPlatform(),e,this._credentials,this._queue),this._firestoreClient.start(t)},Gd.prototype.createDataConverter=function(r){return new Pd(function(t){if(t instanceof Jd){var e=r,n=t.firestore._databaseId;if(!n.isEqual(e))throw new Qr(Kr.INVALID_ARGUMENT,"Document reference is for database "+n.projectId+"/"+n.database+" but should be for database "+e.projectId+"/"+e.database);return new Ld(r,t._key)}return t})},Gd.databaseIdFromApp=function(t){var e=t.options;if(!Gr(e,"projectId"))throw new Qr(Kr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=e.projectId;if(!n||"string"!=typeof n)throw new Qr(Kr.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new Ai(n)},Object.defineProperty(Gd.prototype,"app",{get:function(){if(!this._firebaseApp)throw new Qr(Kr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._firebaseApp},enumerable:!0,configurable:!0}),Gd.prototype.collection=function(t){return Zr("Firestore.collection",arguments,1),ei("Firestore.collection","non-empty string",1,t),this.ensureClientConfigured(),new lp(xi.fromString(t),this)},Gd.prototype.doc=function(t){return Zr("Firestore.doc",arguments,1),ei("Firestore.doc","non-empty string",1,t),this.ensureClientConfigured(),Jd.forPath(xi.fromString(t),this)},Gd.prototype.collectionGroup=function(t){if(Zr("Firestore.collectionGroup",arguments,1),ei("Firestore.collectionGroup","non-empty string",1,t),0<=t.indexOf("/"))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new ap(new rl(xi.EMPTY_PATH,t),this)},Gd.prototype.runTransaction=function(e){var n=this;return Zr("Firestore.runTransaction",arguments,1),ei("Firestore.runTransaction","function",1,e),this.ensureClientConfigured().transaction(function(t){return e(new zd(n,t))})},Gd.prototype.batch=function(){return this.ensureClientConfigured(),new Yd(this)},Object.defineProperty(Gd,"logLevel",{get:function(){switch(Mr()){case Tr.DEBUG:return"debug";case Tr.ERROR:return"error";case Tr.SILENT:return"silent";default:return xr("Unknown log level: "+Mr())}},enumerable:!0,configurable:!0}),Gd.setLogLevel=function(t){switch(Zr("Firestore.setLogLevel",arguments,1),ei("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":Or(Tr.DEBUG);break;case"error":Or(Tr.ERROR);break;case"silent":Or(Tr.SILENT);break;default:throw new Qr(Kr.INVALID_ARGUMENT,"Invalid log level: "+t)}},Gd.prototype._areTimestampsInSnapshotsEnabled=function(){return this._settings.timestampsInSnapshots},Gd);function Gd(t){var e=this;if(this._firebaseApp=null,this._queue=new Yi,this.INTERNAL={delete:function(){return d(e,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.terminate()];case 1:return t.sent(),[2]}})})}},"object"==typeof t.options){var n=t;this._firebaseApp=n,this._databaseId=Gd.databaseIdFromApp(n),this._persistenceKey=n.name,this._credentials=new $f(n)}else{var r=t;if(!r.projectId)throw new Qr(Kr.INVALID_ARGUMENT,"Must provide projectId");this._databaseId=new Ai(r.projectId,r.database),this._persistenceKey="[DEFAULT]",this._credentials=new Jf}this._settings=new Qd({}),this._dataConverter=this.createDataConverter(this._databaseId)}var zd=(Hd.prototype.get=function(t){var n=this;Zr("Transaction.get",arguments,1);var r=yp("Transaction.get",t,this._firestore);return this._transaction.lookup([r._key]).then(function(t){if(!t||1!==t.length)return xr("Mismatch in docs returned from document lookup.");var e=t[0];if(e instanceof qs)return new ep(n._firestore,r._key,null,!1,!1);if(e instanceof Ps)return new ep(n._firestore,r._key,e,!1,!1);throw xr("BatchGetDocumentsRequest returned unexpected document type: "+e.constructor.name)})},Hd.prototype.set=function(t,e,n){ti("Transaction.set",arguments,2,3);var r=yp("Transaction.set",t,this._firestore),i=(n=dp("Transaction.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",e);return this._transaction.set(r._key,i),this},Hd.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return i="string"==typeof e||e instanceof zf?($r("Transaction.update",arguments,3),r=yp("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",e,n,o)):(Zr("Transaction.update",arguments,2),r=yp("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("Transaction.update",e)),this._transaction.update(r._key,i),this},Hd.prototype.delete=function(t){Zr("Transaction.delete",arguments,1);var e=yp("Transaction.delete",t,this._firestore);return this._transaction.delete(e._key),this},Hd);function Hd(t,e){this._firestore=t,this._transaction=e}var Yd=(Xd.prototype.set=function(t,e,n){ti("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=yp("WriteBatch.set",t,this._firestore),i=(n=dp("WriteBatch.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",e);return this._mutations=this._mutations.concat(i.toMutations(r._key,Sa.NONE)),this},Xd.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return this.verifyNotCommitted(),i="string"==typeof e||e instanceof zf?($r("WriteBatch.update",arguments,3),r=yp("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",e,n,o)):(Zr("WriteBatch.update",arguments,2),r=yp("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("WriteBatch.update",e)),this._mutations=this._mutations.concat(i.toMutations(r._key,Sa.exists(!0))),this},Xd.prototype.delete=function(t){Zr("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var e=yp("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new Ba(e._key,Sa.NONE)),this},Xd.prototype.commit=function(){return d(this,void 0,void 0,function(){return m(this,function(t){return this.verifyNotCommitted(),this._committed=!0,0<this._mutations.length?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},Xd.prototype.verifyNotCommitted=function(){if(this._committed)throw new Qr(Kr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},Xd);function Xd(t){this._firestore=t,this._mutations=[],this._committed=!1}var Jd=(Zd.forPath=function(t,e){if(t.length%2!=0)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+t.canonicalString()+" has "+t.length);return new Zd(new Ki(t),e)},Object.defineProperty(Zd.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(Zd.prototype,"parent",{get:function(){return new lp(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(Zd.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),Zd.prototype.collection=function(t){if(Zr("DocumentReference.collection",arguments,1),ei("DocumentReference.collection","non-empty string",1,t),!t)throw new Qr(Kr.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var e=xi.fromString(t);return new lp(this._key.path.child(e),this.firestore)},Zd.prototype.isEqual=function(t){if(!(t instanceof Zd))throw fi("isEqual","DocumentReference",1,t);return this.firestore===t.firestore&&this._key.isEqual(t._key)},Zd.prototype.set=function(t,e){ti("DocumentReference.set",arguments,1,2);var n=(e=dp("DocumentReference.set",e)).merge||e.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,e.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(n.toMutations(this._key,Sa.NONE))},Zd.prototype.update=function(t,e){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return n="string"==typeof t||t instanceof zf?($r("DocumentReference.update",arguments,2),this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,e,r)):(Zr("DocumentReference.update",arguments,1),this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(n.toMutations(this._key,Sa.exists(!0)))},Zd.prototype.delete=function(){return Zr("DocumentReference.delete",arguments,0),this._firestoreClient.write([new Ba(this._key,Sa.NONE)])},Zd.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];ti("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof t[i]||od(t[i])||(li("DocumentReference.onSnapshot",r=t[i],["includeMetadataChanges"]),ii("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var o={includeMetadataChanges:r.includeMetadataChanges};return n=od(t[i])?t[i]:(ei("DocumentReference.onSnapshot","function",i,t[i]),ni("DocumentReference.onSnapshot","function",i+1,t[i+1]),ni("DocumentReference.onSnapshot","function",i+2,t[i+2]),{next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(o,n)},Zd.prototype.onSnapshotInternal=function(t,n){var r=this,e=function(t){console.error("Uncaught Error in onSnapshot:",t)};n.error&&(e=n.error.bind(n));var i=new Wf({next:function(t){if(n.next){Fr(t.docs.size<=1,"Too many documents returned on a document query");var e=t.docs.get(r._key);n.next(new ep(r.firestore,r._key,e,t.fromCache,t.hasPendingWrites))}},error:e}),o=this._firestoreClient.listen(rl.atPath(this._key.path),i,t);return function(){i.mute(),r._firestoreClient.unlisten(o)}},Zd.prototype.get=function(n){var r=this;return ti("DocumentReference.get",arguments,0,1),mp("DocumentReference.get",n),new Promise(function(e,t){n&&"cache"===n.source?r.firestore.ensureClientConfigured().getDocumentFromLocalCache(r._key).then(function(t){e(new ep(r.firestore,r._key,t,!0,t instanceof Ps&&t.hasLocalMutations))},t):r.getViaSnapshotListener(e,t,n)})},Zd.prototype.getViaSnapshotListener=function(e,n,r){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(t){i(),!t.exists&&t.metadata.fromCache?n(new Qr(Kr.UNAVAILABLE,"Failed to get document because the client is offline.")):t.exists&&t.metadata.fromCache&&r&&"server"===r.source?n(new Qr(Kr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):e(t)},error:n})},Zd);function Zd(t,e){this._key=t,this.firestore=e,this._firestoreClient=this.firestore.ensureClientConfigured()}var $d=(tp.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},tp);function tp(t,e){this.hasPendingWrites=t,this.fromCache=e}var ep=(np.prototype.data=function(t){return ti("DocumentSnapshot.data",arguments,0,1),t=pp("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data(),Ka.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},np.prototype.get=function(t,e){if(ti("DocumentSnapshot.get",arguments,1,2),e=pp("DocumentSnapshot.get",e),this._document){var n=this._document.data().field(Vd("DocumentSnapshot.get",t));if(null!==n)return this.convertValue(n,Ka.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(np.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(np.prototype,"ref",{get:function(){return new Jd(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(np.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(np.prototype,"metadata",{get:function(){return new $d(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),np.prototype.isEqual=function(t){if(!(t instanceof np))throw fi("isEqual","DocumentSnapshot",1,t);return this._firestore===t._firestore&&this._fromCache===t._fromCache&&this._key.isEqual(t._key)&&(null===this._document?null===t._document:this._document.isEqual(t._document))},np.prototype.convertObject=function(t,n){var r=this,i={};return t.forEach(function(t,e){i[t]=r.convertValue(e,n)}),i},np.prototype.convertValue=function(t,e){if(t instanceof Ns)return this.convertObject(t,e);if(t instanceof Rs)return this.convertArray(t,e);if(t instanceof Ts){var n=t.value(e),r=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(r)||Lr("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new Jd(n,this._firestore)}return t.value(e)},np.prototype.convertArray=function(t,e){var n=this;return t.internalValue.map(function(t){return n.convertValue(t,e)})},np);function np(t,e,n,r,i){this._firestore=t,this._key=e,this._document=n,this._fromCache=r,this._hasPendingWrites=i}var rp,ip=(s(op,rp=ep),op.prototype.data=function(t){var e=rp.prototype.data.call(this,t);return Fr("object"==typeof e,"Document in a QueryDocumentSnapshot should exist"),e},op);function op(){return null!==rp&&rp.apply(this,arguments)||this}var ap=(sp.prototype.where=function(t,e,n){var r;Zr("Query.where",arguments,3),hi("Query.where",3,n),function(t,e,n,r){if(!e.some(function(t){return t===r}))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid value "+ci(r)+" provided to function "+t+"() for its "+pi(n)+" argument. Acceptable values: "+e.join(", "))}("Query.where",["<","<=","==",">=",">","array-contains","in","array-contains-any"],2,e);var i=Vd("Query.where",t),o=al.fromString(e);if(i.isKeyField()){if(o===al.ARRAY_CONTAINS||o===al.ARRAY_CONTAINS_ANY)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+o.toString()+"' queries on FieldPath.documentId().");if(o===al.IN){this.validateDisjunctiveFilterElements(n,o);for(var a=[],s=0,u=n;s<u.length;s++){var c=u[s];a.push(this.parseDocumentIdValue(c))}r=new Rs(a)}else r=this.parseDocumentIdValue(n)}else o!==al.IN&&o!==al.ARRAY_CONTAINS_ANY||this.validateDisjunctiveFilterElements(n,o),r=this.firestore._dataConverter.parseQueryValue("Query.where",n,o===al.IN);var h=cl.create(i,o,r);return this.validateNewFilter(h),new sp(this._query.addFilter(h),this.firestore)},sp.prototype.orderBy=function(t,e){var n;if(ti("Query.orderBy",arguments,1,2),ni("Query.orderBy","non-empty string",2,e),void 0===e||"asc"===e)n=Dl.ASCENDING;else{if("desc"!==e)throw new Qr(Kr.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+e+"', expected 'asc' or 'desc'.");n=Dl.DESCENDING}if(null!==this._query.startAt)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var r=Vd("Query.orderBy",t),i=new Rl(r,n);return this.validateNewOrderBy(i),new sp(this._query.addOrderBy(i),this.firestore)},sp.prototype.limit=function(t){return Zr("Query.limit",arguments,1),ei("Query.limit","number",1,t),di("Query.limit",1,t),new sp(this._query.withLimitToFirst(t),this.firestore)},sp.prototype.limitToLast=function(t){return Zr("Query.limitToLast",arguments,1),ei("Query.limitToLast","number",1,t),di("Query.limitToLast",1,t),new sp(this._query.withLimitToLast(t),this.firestore)},sp.prototype.startAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];$r("Query.startAt",arguments,1);var r=this.boundFromDocOrFields("Query.startAt",t,e,!0);return new sp(this._query.withStartAt(r),this.firestore)},sp.prototype.startAfter=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];$r("Query.startAfter",arguments,1);var r=this.boundFromDocOrFields("Query.startAfter",t,e,!1);return new sp(this._query.withStartAt(r),this.firestore)},sp.prototype.endBefore=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];$r("Query.endBefore",arguments,1);var r=this.boundFromDocOrFields("Query.endBefore",t,e,!0);return new sp(this._query.withEndAt(r),this.firestore)},sp.prototype.endAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];$r("Query.endAt",arguments,1);var r=this.boundFromDocOrFields("Query.endAt",t,e,!1);return new sp(this._query.withEndAt(r),this.firestore)},sp.prototype.isEqual=function(t){if(!(t instanceof sp))throw fi("isEqual","Query",1,t);return this.firestore===t.firestore&&this._query.isEqual(t._query)},sp.prototype.boundFromDocOrFields=function(t,e,n,r){if(hi(t,1,e),e instanceof ep){if(0<n.length)throw new Qr(Kr.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new Qr(Kr.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,i._document,r)}var o=[e].concat(n);return this.boundFromFields(t,o,r)},sp.prototype.boundFromDocument=function(t,e,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new Ts(this.firestore._databaseId,e.key));else{var s=e.field(a.field);if(s instanceof ms)throw new Qr(Kr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){var u=a.field.canonicalString();throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(s)}}return new Al(r,n)},sp.prototype.boundFromFields=function(t,e,n){var r=this._query.explicitOrderBy;if(e.length>r.length)throw new Qr(Kr.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<e.length;o++){var a=e[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof a);if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+a+"' contains a slash.");var s=this._query.path.child(xi.fromString(a));if(!Ki.isDocumentKey(s))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+s+"' is not because it contains an odd number of segments.");var u=new Ki(s);i.push(new Ts(this.firestore._databaseId,u))}else{var c=this.firestore._dataConverter.parseQueryValue(t,a);i.push(c)}}return new Al(i,n)},sp.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];ti("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof t[i]||od(t[i])||(li("Query.onSnapshot",r=t[i],["includeMetadataChanges"]),ii("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),n=od(t[i])?t[i]:(ei("Query.onSnapshot","function",i,t[i]),ni("Query.onSnapshot","function",i+1,t[i+1]),ni("Query.onSnapshot","function",i+2,t[i+2]),{next:t[i],error:t[i+1],complete:t[i+2]}),this.validateHasExplicitOrderByForLimitToLast(this._query),this.onSnapshotInternal(r,n)},sp.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new Wf({next:function(t){e.next&&e.next(new up(n.firestore,n._query,t))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,t);return function(){i.mute(),o.unlisten(a)}},sp.prototype.validateHasExplicitOrderByForLimitToLast=function(t){if(t.hasLimitToLast()&&0===t.explicitOrderBy.length)throw new Qr(Kr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")},sp.prototype.get=function(n){var r=this;return ti("Query.get",arguments,0,1),mp("Query.get",n),this.validateHasExplicitOrderByForLimitToLast(this._query),new Promise(function(e,t){n&&"cache"===n.source?r.firestore.ensureClientConfigured().getDocumentsFromLocalCache(r._query).then(function(t){e(new up(r.firestore,r._query,t))},t):r.getViaSnapshotListener(e,t,n)})},sp.prototype.getViaSnapshotListener=function(e,n,r){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(t){i(),t.metadata.fromCache&&r&&"server"===r.source?n(new Qr(Kr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):e(t)},error:n})},sp.prototype.parseDocumentIdValue=function(t){if("string"==typeof t){if(""===t)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==t.indexOf("/"))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+t+"' contains a '/' character.");var e=this._query.path.child(xi.fromString(t));if(!Ki.isDocumentKey(e))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+e+"' is not because it has an odd number of segments ("+e.length+").");return new Ts(this.firestore._databaseId,new Ki(e))}if(t instanceof Jd){var n=t;return new Ts(this.firestore._databaseId,n._key)}throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+ci(t)+".")},sp.prototype.validateDisjunctiveFilterElements=function(t,e){if(!Array.isArray(t)||0===t.length)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+e.toString()+"' filters.");if(10<t.length)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters support a maximum of 10 elements in the value array.");if(0<=t.indexOf(null))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'null' in the value array.");if(0<t.filter(function(t){return Number.isNaN(t)}).length)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'NaN' in the value array.")},sp.prototype.validateNewFilter=function(t){if(t instanceof cl){var e=[al.ARRAY_CONTAINS,al.ARRAY_CONTAINS_ANY],n=[al.IN,al.ARRAY_CONTAINS_ANY],r=0<=e.indexOf(t.op),i=0<=n.indexOf(t.op);if(t.isInequality()){var o=this._query.getInequalityFilterField();if(null!==o&&!o.isEqual(t.field))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+o.toString()+"' and '"+t.field.toString()+"'");var a=this._query.getFirstOrderByField();null!==a&&this.validateOrderByAndInequalityMatch(t.field,a)}else if(i||r){var s=null;if(i&&(s=this._query.findFilterOperator(n)),null===s&&r&&(s=this._query.findFilterOperator(e)),null!=s)throw s===t.op?new Qr(Kr.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+t.op.toString()+"' filter."):new Qr(Kr.INVALID_ARGUMENT,"Invalid query. You cannot use '"+t.op.toString()+"' filters with '"+s.toString()+"' filters.")}}},sp.prototype.validateNewOrderBy=function(t){if(null===this._query.getFirstOrderByField()){var e=this._query.getInequalityFilterField();null!==e&&this.validateOrderByAndInequalityMatch(e,t.field)}},sp.prototype.validateOrderByAndInequalityMatch=function(t,e){if(!e.isEqual(t))throw new Qr(Kr.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},sp);function sp(t,e){this._query=t,this.firestore=e}var up=(Object.defineProperty(cp.prototype,"docs",{get:function(){var e=[];return this.forEach(function(t){return e.push(t)}),e},enumerable:!0,configurable:!0}),Object.defineProperty(cp.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(cp.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),cp.prototype.forEach=function(e,n){var r=this;ti("QuerySnapshot.forEach",arguments,1,2),ei("QuerySnapshot.forEach","function",1,e),this._snapshot.docs.forEach(function(t){e.call(n,r.convertToDocumentImpl(t))})},Object.defineProperty(cp.prototype,"query",{get:function(){return new ap(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),cp.prototype.docChanges=function(t){t&&(li("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),ii("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));var e=!(!t||!t.includeMetadataChanges);if(e&&this._snapshot.excludesMetadataChanges)throw new Qr(Kr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,e,o){if(o.oldDocs.isEmpty()){var n,r=0;return o.docChanges.map(function(t){var e=new ip(i,t.doc.key,t.doc,o.fromCache,o.mutatedKeys.has(t.doc.key));return Fr(t.type===Eh.Added,"Invalid event type for first snapshot"),Fr(!n||o.query.docComparator(n,t.doc)<0,"Got added events in wrong order"),n=t.doc,{type:"added",doc:e,oldIndex:-1,newIndex:r++}})}var a=o.oldDocs;return o.docChanges.filter(function(t){return e||t.type!==Eh.Metadata}).map(function(t){var e=new ip(i,t.doc.key,t.doc,o.fromCache,o.mutatedKeys.has(t.doc.key)),n=-1,r=-1;return t.type!==Eh.Added&&(Fr(0<=(n=a.indexOf(t.doc.key)),"Index for document not found"),a=a.delete(t.doc.key)),t.type!==Eh.Removed&&(r=(a=a.add(t.doc)).indexOf(t.doc.key)),{type:function(t){switch(t){case Eh.Added:return"added";case Eh.Modified:case Eh.Metadata:return"modified";case Eh.Removed:return"removed";default:return xr("Unknown change type: "+t)}}(t.type),doc:e,oldIndex:n,newIndex:r}})}(this._firestore,e,this._snapshot),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges},cp.prototype.isEqual=function(t){if(!(t instanceof cp))throw fi("isEqual","QuerySnapshot",1,t);return this._firestore===t._firestore&&this._originalQuery.isEqual(t._originalQuery)&&this._snapshot.isEqual(t._snapshot)},cp.prototype.convertToDocumentImpl=function(t){return new ip(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},cp);function cp(t,e,n){this._firestore=t,this._originalQuery=e,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new $d(n.hasPendingWrites,n.fromCache)}["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(t){try{Object.defineProperty(up.prototype.docChanges,t,{get:function(){return function(){throw new Qr(Kr.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(t){}});var hp,lp=(s(fp,hp=ap),Object.defineProperty(fp.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(fp.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new Jd(new Ki(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(fp.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),fp.prototype.doc=function(t){if(ti("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=yi.newId()),ei("CollectionReference.doc","non-empty string",1,t),""===t)throw new Qr(Kr.INVALID_ARGUMENT,"Document path must be a non-empty string");var e=xi.fromString(t);return Jd.forPath(this._query.path.child(e),this.firestore)},fp.prototype.add=function(t){Zr("CollectionReference.add",arguments,1),ei("CollectionReference.add","object",1,t);var e=this.doc();return e.set(t).then(function(){return e})},fp);function fp(t,e){var n=hp.call(this,rl.atPath(t),e)||this;if(t.length%2!=1)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+t.canonicalString()+" has "+t.length);return n}function dp(t,e){if(void 0===e)return{merge:!1};if(li(t,e,["merge","mergeFields"]),ii(t,"boolean","merge",e.merge),oi(t,"mergeFields","a string or a FieldPath",e.mergeFields,function(t){return"string"==typeof t||t instanceof zf}),void 0!==e.mergeFields&&void 0!==e.merge)throw new Qr(Kr.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function pp(t,e){return void 0===e?{}:(li(t,e,["serverTimestamps"]),ai(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function mp(t,e){ni(t,"object",1,e),e&&(li(t,e,["source"]),ai(t,0,"source",e.source,["default","server","cache"]))}function yp(t,e,n){if(e instanceof Jd){if(e.firestore!==n)throw new Qr(Kr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw fi(t,"DocumentReference",1,e)}var gp=Wr(Wd,"Use firebase.firestore() instead."),vp=Wr(zd,"Use firebase.firestore().runTransaction() instead."),bp=Wr(Yd,"Use firebase.firestore().batch() instead."),wp=Wr(Jd,"Use firebase.firestore().doc() instead."),Tp=Wr(ep),Sp=Wr(ip),Ep=Wr(ap),Ip=Wr(up),Cp=Wr(lp,"Use firebase.firestore().collection() instead."),Dp={Firestore:gp,GeoPoint:Jh,Timestamp:oo,Blob:Ci,Transaction:vp,WriteBatch:bp,DocumentReference:wp,DocumentSnapshot:Tp,Query:Ep,QueryDocumentSnapshot:Sp,QuerySnapshot:Ip,CollectionReference:Cp,FieldPath:zf,FieldValue:Ed,setLogLevel:Wd.setLogLevel,CACHE_SIZE_UNLIMITED:Kd};function Np(t){t.INTERNAL.registerService("firestore",function(t){return new Wd(t)},function(t){Fr(t&&"object"==typeof t,"shallowCopy() expects object parameter.");var e={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}(Dp))}var Ap=(kp.prototype.addCallback=function(t){},kp.prototype.shutdown=function(){},kp);function kp(){}var Rp="ConnectivityMonitor",Mp=(Op.prototype.addCallback=function(t){this.callbacks.push(t)},Op.prototype.shutdown=function(){window.removeEventListener("online",this.networkAvailableListener),window.removeEventListener("offline",this.networkUnavailableListener)},Op.prototype.configureNetworkMonitoring=function(){window.addEventListener("online",this.networkAvailableListener),window.addEventListener("offline",this.networkUnavailableListener)},Op.prototype.onNetworkAvailable=function(){_r(Rp,"Network connectivity changed: AVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(0)},Op.prototype.onNetworkUnavailable=function(){_r(Rp,"Network connectivity changed: UNAVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(1)},Op.isAvailable=function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener},Op);function Op(){var t=this;this.networkAvailableListener=function(){return t.onNetworkAvailable()},this.networkUnavailableListener=function(){return t.onNetworkUnavailable()},this.callbacks=[],this.configureNetworkMonitoring()}var _p=(Lp.prototype.onOpen=function(t){Fr(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},Lp.prototype.onClose=function(t){Fr(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},Lp.prototype.onMessage=function(t){Fr(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},Lp.prototype.close=function(){this.closeFn()},Lp.prototype.send=function(t){this.sendFn(t)},Lp.prototype.callOnOpen=function(){Fr(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},Lp.prototype.callOnClose=function(t){Fr(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},Lp.prototype.callOnMessage=function(t){Fr(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},Lp);function Lp(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}var Pp="Connection",xp={BatchGetDocuments:"batchGet",Commit:"commit"},Fp="gl-js/ fire/"+kr,qp=(Vp.prototype.modifyHeadersForRequest=function(t,e){if(e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n]);t["X-Goog-Api-Client"]=Fp},Vp.prototype.invokeRPC=function(s,r,u){var c=this,h=this.makeUrl(s);return new Promise(function(i,o){var a=new Ar;a.listenOnce(Dr.COMPLETE,function(){try{switch(a.getLastErrorCode()){case Cr.NO_ERROR:var t=a.getResponseJson();_r(Pp,"XHR received:",JSON.stringify(t)),i(t);break;case Cr.TIMEOUT:_r(Pp,'RPC "'+s+'" timed out'),o(new Qr(Kr.DEADLINE_EXCEEDED,"Request time out"));break;case Cr.HTTP_ERROR:var e=a.getStatus();if(_r(Pp,'RPC "'+s+'" failed with status:',e,"response text:",a.getResponseText()),0<e){var n=a.getResponseJson().error;if(n&&n.status&&n.message){var r=function(t){var e=t.toLowerCase().replace("_","-");return 0<=Object.values(Kr).indexOf(e)?e:Kr.UNKNOWN}(n.status);o(new Qr(r,n.message))}else o(new Qr(Kr.UNKNOWN,"Server responded with status "+a.getStatus()))}else _r(Pp,'RPC "'+s+'" failed'),o(new Qr(Kr.UNAVAILABLE,"Connection failed."));break;default:xr('RPC "'+s+'" failed with unanticipated webchannel error '+a.getLastErrorCode()+": "+a.getLastError()+", giving up.")}}finally{_r(Pp,'RPC "'+s+'" completed.')}});var t=l({},r);delete t.database;var e=JSON.stringify(t);_r(Pp,"XHR sending: ",h+" "+e);var n={"Content-Type":"text/plain"};c.modifyHeadersForRequest(n,u),a.send(h,"POST",e,n,15)})},Vp.prototype.invokeStreamingRPC=function(t,e,n){return this.invokeRPC(t,e,n)},Vp.prototype.openStream=function(t,e){var n=[this.baseUrl,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=Ir(),i={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(i.initMessageHeaders,e),"object"==typeof navigator&&"ReactNative"===navigator.product||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");function a(t,e){s.listen(t,function(t){try{e(t)}catch(t){setTimeout(function(){throw t},0)}})}_r(Pp,"Creating WebChannel: "+o+" "+i);var s=r.createWebChannel(o,i),u=!1,c=!1,h=new _p({sendFn:function(t){c?_r(Pp,"Not sending because WebChannel is closed:",t):(u||(_r(Pp,"Opening WebChannel transport."),s.open(),u=!0),_r(Pp,"WebChannel sending:",t),s.send(t))},closeFn:function(){return s.close()}});return a(Nr.EventType.OPEN,function(){c||_r(Pp,"WebChannel transport opened.")}),a(Nr.EventType.CLOSE,function(){c||(c=!0,_r(Pp,"WebChannel transport closed"),h.callOnClose())}),a(Nr.EventType.ERROR,function(t){c||(c=!0,_r(Pp,"WebChannel transport errored:",t),h.callOnClose(new Qr(Kr.UNAVAILABLE,"The operation could not be completed")))}),a(Nr.EventType.MESSAGE,function(t){if(!c){var e=t.data[0];Fr(!!e,"Got a webchannel message without data.");var n=e,r=n.error||n[0]&&n[0].error;if(r){_r(Pp,"WebChannel received error:",r);var i=r.status,o=function(t){var e=gh[t];if(void 0!==e)return Sh(e)}(i),a=r.message;void 0===o&&(o=Kr.INTERNAL,a="Unknown error status: "+i+" with message "+r.message),c=!0,h.callOnClose(new Qr(o,a)),s.close()}else _r(Pp,"WebChannel received:",e),h.callOnMessage(e)}}),setTimeout(function(){h.callOnOpen()},0),h},Vp.prototype.makeUrl=function(t){var e=xp[t];return Fr(void 0!==e,"Unknown REST mapping for: "+t),this.baseUrl+"/v1/projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents:"+e},Vp);function Vp(t){this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.baseUrl=e+"://"+t.host,this.forceLongPolling=t.forceLongPolling}var Bp=(Object.defineProperty(Up.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(Up.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),Up.prototype.loadConnection=function(t){return Promise.resolve(new qp(t))},Up.prototype.newConnectivityMonitor=function(){return Mp.isAvailable()?new Mp:new Ap},Up.prototype.newSerializer=function(t){return new Zl(t,{useProto3Json:!0})},Up.prototype.formatJSON=function(t){return JSON.stringify(t)},Up.prototype.atob=function(t){return atob(t)},Up.prototype.btoa=function(t){return btoa(t)},Up);function Up(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}qr.setPlatform(new Bp),Np(Kp)}).apply(this,arguments)}catch(t){throw console.error(t),new Error("Cannot instantiate firebase-firestore - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore.js.map
